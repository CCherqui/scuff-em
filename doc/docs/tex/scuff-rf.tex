\documentclass[letterpaper]{article}

\input{scufftex}

\graphicspath{{figures/}}

%------------------------------------------------------------
%------------------------------------------------------------
%- Special commands for this document -----------------------
%------------------------------------------------------------
%------------------------------------------------------------

%------------------------------------------------------------
%------------------------------------------------------------
%- Document header  -----------------------------------------
%------------------------------------------------------------
%------------------------------------------------------------
\title {{\sc librfsolver} and {\sc scuff-rf}: Support for
        RF device modeling in {\sc scuff-em}}
\author {Homer Reid}
\date {April 16, 2018}

%------------------------------------------------------------
%------------------------------------------------------------
%- Start of actual document
%------------------------------------------------------------
%------------------------------------------------------------

\begin{document}
\pagestyle{myheadings}
\markright{Homer Reid: The {\sc scuff-em} RF module}
\maketitle

\tableofcontents

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Overview}

The {\sc scuff-em} package includes a module for RF device modeling
within the framework of integral-equation electromagnetism.
The core functionality of the module is implemented 
by the {\sc librfsolver} library packaged with the {\sc scuff-em}
distribution, and may be accessed either \textbf{(a)} in API form 
from C++ or python programs, or \textbf{(b)} from the command line
via the {\sc scuff-rf} binary application code.

The {\sc scuff-em} RF module extends the existing functionality of the
{\sc scuff-em} core library in three main ways:

\begin{enumerate}
  \item It introduces the notion of a \textit{port.} This is the region
        of your structure (be it an antenna, a coaxial cable, etc.)
        that interfaces with RF circuitry.
        Information on ports may be specified to {\sc scuff-em} via
        \textbf{(a)} text-based input files (\texttt{.ports} files), or
        \textbf{(b)} polygonal regions in GDSII files.
        Information on ports is stored internally in the {\sc scuff-em}
        RF module via data structures named \texttt{RWGPort} and 
        \texttt{RWGPortEdge}.
  \item It allows you to specify a fixed set of \textit{port currents},
        rather than a fixed incident field configuration such as a plane wave,
        as the excitation source for a {\sc scuff-em} scattering problem.
        The incident field in the scattering problem is then the field radiated
        by the currents forced into the ports.
  \item As a new type of post-processing calculation, it provides functionality 
        to compute the \textit{impedance parameters} of a multiport geometry.
        (All of the varous other types of post-processing calculations offered by
        core {\sc scuff-em}---including computation and visualization of fields,
        induced moments, power, etc.---are available as well.)
\end{enumerate}

In this memo we will discuss the implementation of these features.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newpage
\section{The concept of an \texttt{RWGPort}}
%####################################################################%
%####################################################################%
%####################################################################%
\begin{figure}
\begin{center}
%\includegraphics{RWGPortFigure
\caption{An \texttt{RWGPort}. The port current $I$ is
         forced into the positive port terminal, while
         an identical current is extracted from the negative
         port terminal. Each port terminal is comprised of one or
         more exterior edges in a meshed geometry.
        }
\label{RWGPortFigure}
\end{center}
\end{figure}
%####################################################################%
%####################################################################%
%####################################################################%

A key extension of the \lss core library provided by {\sc scuff-rf}
is the idea of an \texttt{RWGPort}. This is a physical region of
a structure that interfaces with RF circuitry.

Figure \ref{PortFigure} depicts an \texttt{RWGPort}.
The port consists of a positive and a negative terminal.
[The negative terminal may be omitted, in which case
the role of negative terminal is played by the ground plane
in the geometry (if present) or by an implicit negative terminal
at spatial infinity.]
Each port terminal is comprised of one or more exterior edges
in an \texttt{RWGSurface} (i.e. an \texttt{OBJECT} or \texttt{SURFACE}
in a \texttt{.scuffgeo} file).
There is no need for the two port terminals to have the same length,
nor must they be comprised of the same number of panel edges,
nor must they lie on the same meshed surface.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newpage

\section{RF device modeling in the integral-equation framework}
\label{RFDeviceModeling}

In RF device modeling, structures are excited by user-specified input currents
forced into one or more ports of a structure, and the objective is to compute
impedance parameters (or admittance parameters or $S$-parameters) for the 
multiport network (possibly accompanied by other quantities such as 
radiated-field profiles).

On the other hand, in the usual surface-integral-equation (SIE)
approach to electromagnetic scattering implemented by the {\sc scuff-em}
core library, the excitation is provided by a user-specified
incident electromagnetic field configuration (such as a plane wave
or the field of a point dipole),
and the objective is to compute quantities such as absorbed or scattered
power.

How do we squeeze the former problem into the latter framework?
In essence, we take the incident field in the SIE scattering problem
to be the field radiated by the currents forced into the ports
of a structure, and we obtain impedance-matrix elements by calculating
complex power dissipation in the structure.
In this section I discuss how these steps are implemented
in the {\sc scuff-em} RF module.
(The problem of computing fields radiated by port-driven structures
requires no new implementation beyond the existing {\sc scuff-em} 
algorithms for computing fields radiated by excited structures.)

\subsection{Port currents: A new type of incident field}

%####################################################################%
%####################################################################%
%####################################################################%
\begin{figure}
\begin{center}
%\includegraphics{PortCurrentIncidentField}}
\caption{The incident field in the BEM scattering problem
         is the field radiated by half-RWG basis functions
         associated with the exterior edges comprising the
         \texttt{RWGPort}.
         The weight of each
half-RWG basis function is populated with
         a strength proportional to the port current.
        }
\label{PortCurrentFigure}
\end{center}
\end{figure}
%####################################################################%
%####################################################################%
%####################################################################%

To model RF devices excited by currents forced into ports,
the {\sc scuff-em} RF module solves an integral-equation scattering problem
in which the incident field is the field radiated by the currents
forced into the ports.
half-RWG basis
functions associated 
with each port, with those basis functions populated by strengths
proportional to the port current.

The positive port current is assumed to be equally distributed over 
all edges on the positive side of the port, while the 
negative port current is assumed to be equally distributed over 
all edges on the negative side of the port.
Thus, if the port current in Figure \ref{PortCurrentFigure}) is $I$, 
then the coefficients of the three half-RWG functions on the 
positive side of the port are
$$K_{15}=K_{29}=K_{37}=-\frac{I}{W^+},$$
while the coefficients of the three half-RWG functions on the 
positive side of the port are
$$K_{61}=K_{82}=+\frac{I}{W^-}.$$
Note that our sign convention is that the current carried
by a half-RWG function always flows \textit{from} the vertex 
\textit{to} the edge, which is why the half-RWG functions
on the positive port edge have negative coefficients.

%####################################################################%
%####################################################################%
%####################################################################%
\begin{figure}
\begin{center}
%\includegraphics{PortCurrentIncidentField}}
\caption{The fields radiated by a half-RWG basis function
         contain one contribution from surface sources 
         (surface current and associated surface charge)
         on the triangular panel $\pan$, and a second contribution
         from the line charge that accumulates on the edge 
         $\vb L.$
        }
\label{HalfRWGBasisFunction}
\end{center}
\end{figure}
%####################################################################%
%####################################################################%
%####################################################################%

\subsection*{Fields radiated by a half-RWG basis function}

Consider a half-RWG basis function $h_\alpha(\vb x)$, as depicted in 
Figure \ref{HalfRWGBasisFunction}.  Suppose the basis function
is weighted with coefficient $k_\alpha$. 
($k_\alpha$ has dimensions of current/length.) 
The $\vb E$ field may be expressed in terms of the Lorentz-gauge potentials,
\begin{align*}
  \vb E(\vb x) 
 &= iw\vb A(\vb x) - \nabla \Phi(\vb x),,,,
\end{align*}
where the vector potential is obtained by integrating over surface 
currents on $\pan_\alpha$,
\begin{align*}
 \vb A(\vb x) 
&=\mu\int_{\pan_\alpha} G(\vb x, \vb x^\prime) \vb K(\vb x^\prime) 
  d\vb x^\prime
\intertext{but the scalar potential contains contributions from both
           the surface charge on $\pan_\alpha$ and the line charge 
           on $\vb L_\alpha$:}
 \vb \phi(\vb x) 
&=+\frac{1}{\epsilon}
  \int_{\pan_\alpha} G(\vb x, \vb x^\prime) \sigma(\vb x^\prime) dA 
+\,\frac{1}{\epsilon}
  \int_{\vb L_\alpha} G(\vb x, \vb x^\prime) \lambda(\vb x^\prime) dl
\end{align*}
For a half-RWG function populated by strength $k_\alpha$ we have 
$$ \left.
   \begin{array}{lcl}
   \vb K(\vb x)  &=& \frac{lk_\alpha}{2A}(\vb x-\vb Q)
   \\[8pt]
   \sigma(\vb x) &=& \frac{lk_\alpha}{i\omega A}
   \end{array}
   \right\} \qquad \vb x\in\pan_\alpha 
$$
and 
$$ \lambda(\vb x) = \frac{k_\alpha}{i\omega}, \qquad 
   \vb x \in \vb L 
$$
and hence the 

\subsection{Evaluation of RHS vector}

The elements of the RHS vector in a {\sc scuff-em} scattering problem
are (the negatives of) the inner products of the incident fields
with the RWG basis functions of the geometry.

%####################################################################%
%####################################################################%
%####################################################################%
\subsection{Calculation of impedance matrix}

For an $N\subt{P}$-port system, the
$N\subt{P}\times N\subt{P}$ impedance matrix $\vb Z$ is defined by
JStar E = (Jr-iJi)(Er+iEi) JrEr + JiEi + i(JrEi-JiEr)
J E = (Jr+iJi)(Er+iEi) (JrEr - JiEi) + i(JrEi+JiEr)

$$ \vb J_p(\vb x) =
   \sum_{a\in\mc{P}_p}
   \bigg\{ \Big[ 
     -\sum_{\alpha\beta} \vb b_\alpha(\vb x) M_{\alpha\beta} R_{\beta a}
           \Big]
           +\vb b_a(\vb x)
   \bigg\}w_a,
 \quad 
   \vb E_q(\vb x) =
   \sum_{b\in\mc{P}_q}
   \bigg\{ \Big[ 
     -\sum_{\gamma\delta} \mb E_\gamma(\vb x) M_{\gamma\delta} R_{\delta b}
           \Big]
           +\mb E_b(\vb x)
   \bigg\}w_b
 \qquad 
$$
%====================================================================%
\begin{align*}
 Z_{pq} 
 &\equiv \frac{1}{2I_p I_q}\int \vb J_p(\vb x) \vb E_q(\vb x)\,d\vb x
\\
 &= T_1 + T_2 + T_3 + T_4 
\\
 T_1 &\equiv \sum_{\alpha\beta\gamma\delta}
  R_{\delta q}
  M_{\alpha\beta}
 \underbrace{\Inp{\vb b_\alpha}{\vb E_\gamma}}_{M_{\alpha\gamma}^{-1}}
  M_{\gamma\delta}
  R_{\beta p}
\\
&= \frac{1}{2} \vb R_q \vb M \vb R_p
\\
 T_2 &\equiv -\sum_{\alpha\beta}
 \underbrace{\Inp{\vb b_\alpha}{\vb E_b}}_{R_{\alpha q}}
  M_{\alpha\beta}
  R_{\beta p}
 &= -\frac{1}{2}\vb R_q \vb M \vb R_p
\end{align*}
%====================================================================%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newpage
\appendix
\subsection{Port voltages: Alternative computation of impedance matrix}
%####################################################################%
%####################################################################%
%####################################################################%
\begin{figure}
\begin{center}
%\includegraphics{PortCurrentIncidentField}}
\caption{The port voltage is the line integral of the total $\vb E$ 
         field along the straight line connecting the port's 
         positive reference point to its negative reference point.
        }
\label{LineIntegralFigure}
\end{center}
\end{figure}
%####################################################################%
%####################################################################%
%####################################################################%

\label{PortVoltageSection}

The port voltage is defined to be the directed line integral 
of the total $\vb E$ field over the straight line connecting
the port's positive reference point to its negative reference
point (Figure \ref{LineIntegralFigure}).

\begin{align*}
  V\sups{port}
&=\int_{P^+}^{P^-} \vb E(\vb x) \cdot d \vb l 
\\
&=\int_{P^+}^{P^-} \Big[ i\omega \vb A(\vb x) - \nabla \Phi(\vb x)\Big]
                   \cdot d \vb l
\\
&= \Big[ \Phi\big(P^+\big) - \Phi\big(P^-\big)\Big]
   +i\omega \int_{P^+}^{P^-} \vb A(\vb x) \cdot d\vb l
\end{align*}

\section*{Averaging the potential due to $\mathcal{P}$ over an edge $\vb L$}

The electrostatic potential due to a unit charge density on panel $\mc P$,
averaged over the length of some panel edge $\vb L$, is 

\begin{align*}
 \Big\langle \phi^{\mc P} \Big \rangle_{\vb L}
&= \frac{1}{4\pi \epsilon_0 |\vb L|}\int_{\vb L} d\vb x \int_{\mc P} d\vb x^\prime 
   \frac{1}{|\vb x - \vb x^\prime|} 
\end{align*}

\end{document}
