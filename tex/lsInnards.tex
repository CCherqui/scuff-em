\documentclass[letterpaper]{article}

\input{scufftex}

\graphicspath{{figures/}}

%------------------------------------------------------------
%------------------------------------------------------------
%- Special commands for this document -----------------------
%------------------------------------------------------------
%------------------------------------------------------------

%------------------------------------------------------------
%------------------------------------------------------------
%- Document header  -----------------------------------------
%------------------------------------------------------------
%------------------------------------------------------------
\title {\lss Implementation and Technical Details}
\author {Homer Reid}
\date {October 11, 2011}


%------------------------------------------------------------
%------------------------------------------------------------
%- Start of actual document
%------------------------------------------------------------
%------------------------------------------------------------

\begin{document}
\pagestyle{myheadings}
\markright{Homer Reid: \lss Implementation and Technical Details}
\maketitle

\tableofcontents

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newpage
\section{Geometries in \lss}

\lss thinks of a geometry as consisting of a collection
of three-dimensional \textit{regions}, bounded by 
two-dimensional \textit{surfaces.}

Each region $\mathcal{R}^r$ is a contiguous volume
throughout which the permittivity and permeability are 
spatially constant,
$$ \epsilon(\vb x, \omega) \equiv \epsilon^r(\omega), \qquad
   \mu(\vb x, \omega)      \equiv \mu^r(\omega)
$$
where $\epsilon^r(\omega)$ and $\mu^r(\omega)$ may
be arbitrary user-specified functions of frequency. 
(Only linear, isotropic $\epsilon$ and $\mu$ are supported.)
The region with index $r=0$ is known as the 
``exterior'' medium of the \lss geometry; it is 
always present in every \lss geometry and has by 
default the permittivity and permeability of vacuum. 
The user may redefine the material properties of the 
exterior medium as desired.

Each surface is described by a surface mesh consisting of 
a union of flat triangular panels. 
Each surface lies at the interface between precisely two 
regions. We identify one of these two regions as 
the ``exterior'' region for the surface in question,
and the other region is the ``interior.'' The normal 
vector to the surface is always defined to point into 
the ``exterior'' region.\footnote{This requires that 
surfaces be \textit{orientable}; Klein bottles are thus 
explicitly forbidden in \lss geometries, although PEC 
M\"obius strips are allowed.} (This is true even for 
open surfaces; in this case the terminology ``exterior'' 
and ``interior'' doesn't quite make sense, but we can 
certainly still pick one of the two regions between
which a surface lies and decide that the normal vector
will point into that region, and we call that region
the ``exterior'' region for the open surface.

The regions and surfaces that define \lss\, geometries are 
specified in \textit{geometry files,} conventionally given the 
file extension \texttt{.scuffgeo}. The \texttt{.scuffgeo}
file is parsed to create an instance of a {\sc c++} 
class named \texttt{RWGGeometry.} This is a big class 
containing lots of data fields and methods, but 
for the purposes of this section the most important 
fields are the following:
%
\begin{verbatim}
  class RWGGeometry
   {
      int NumRegions;
      char **RegionLabels;

      int NumSurfaces;
      RWGSurface **Surfaces;
   };
\end{verbatim}
%
\subsection*{Simple geometries: \texttt{OBJECT} specifications}

The simplest type of \lss geometry consists of one or more
compact homogeneous objects embedded in an external 
medium. In this case, each object is described by a 
\textit{closed} surface mesh (specified to \lss
as a mesh file in one of the supported mesh file 
formats) together with an material designation.
Here's an example:
%####################################################################%
\begin{figure}[H]
\begin{center}
\resizebox{\textwidth}{!}{\includegraphics{RWGGeometryDataFields1.pdf}}
\caption{A simple \texttt{.scuffgeo} file and some fields in the 
         corresponding \texttt{RWGGeometry} structure.}
\end{center}
\end{figure}
%####################################################################%

In the language of regions and surfaces discussed above,
each \texttt{OBJECT} statement adds one new region and 
one new surface to a geometry. The newly added region 
is always taken to be the interior region associated
with the newly added surface, and the 
volume inside the object; the new surface exists at 
the interface between this region and the exterior
medium.

We said above that surface meshes for compact objects 
should be \textit{closed} surfaces. The exception to 
this statement is that PEC (perfectly electrically
conducting) or IPEC (imperfectly electrically 
conducting) bodies may be described by open surfaces.
(An IPEC body is a PEC body with finite surface 
conductivity). For both PEC and IPEC bodies the
interior fields vanish identically, and there
is no need for such bodies to have finite
interior volume.

\subsection*{Simple geometries: Nested objects} 

It is possible for an object defined by an
\texttt{OBJECT} declaration to be fully 
contained inside another \texttt{OBJECT}. 
The nesting inclusion relationship is automatically 
detected by \ls. 

\subsection*{More complicated geometries: \texttt{REGION}
             and \texttt{SURFACE} statements}

Some geometries are too complicated to be defined 
as collections of compact objects bounded by closed 
surfaces. One example is a composite sphere in which 
the upper and lower hemispheres consist of different 
materials. Another example is a metallic nanoparticle 
(say, a disc) lying atop a dielectric substrate. The 
common feature of these two examples that prevents 
description in terms of simple closed objects is the 
presence of \textit{multi-material junctions}; these
are one-dimensional subspaces at which three
or more material regions meet. 
For the composite sphere, the multi-material junction 
would be the equator; for the disc on the substrate, 
it would be the lower circumference of the disc.

Geometries like this are described in \lss
using \texttt{REGION} and \texttt{SURFACE}
statements. For example, the composite sphere
above may be specified like this:
%####################################################################%
\begin{figure}[H]
\begin{center}
\resizebox{\textwidth}{!}{\includegraphics{RWGGeometryDataFields2.pdf}}
\caption{A more complex \texttt{.scuffgeo} file and some fields in the 
         corresponding \texttt{RWGGeometry} structure.}
\end{center}
\end{figure}
%####################################################################%
\subsection*{Extended geometries: \texttt{LATTICE}
             statements}

Extended geometries are described using \texttt{LATTICE}
statements in the \texttt{scuffgeo} file.
For example, here's an infinite square-lattice array 
of gold spheres:
%
\begin{verbatim}
LATTICE
        VECTOR 1 0 
        VECTOR 0 1 
ENDLATTICE

OBJECT TheSphere
        MESHFILE Sphere_480.msh
        MATERIAL Gold
ENDOBJECT
\end{verbatim}
%

It is also possible for surfaces to straddle 
the lattice-cell boundaries. This will be the 
case, for example, if you are describing an
infinite planar surface (possibly with
holes). In this case, the surface mesh must
be \textit{compatible} with the lattice specification,
in the sense that every triangle edge that 
lies on the unit-cell boundary must have an
image edge lying one lattice-translate away.

\subsection*{Extended geometries in which the exterior medium
             is non-contiguous}

In some extended geometries, it may be possible for the 
exterior medium to be non-contiguous. For example,
consider a thin film described by two planar surfaces  
(the upper and lower surfaces of the film) with a
\texttt{LATTICE} statement indicating the surfaces
are infinitely extended (comprised of an infinite
2D lattice of the unit-cell surfaces).
In this case, you probably think of the region above the 
upper surface and the region below the lower surface as 
both belonging to the same region, but as far as 
\lss is concerned they are two different regions.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newpage
\section{Representation of Surface Currents in \ls}

\lss uses RWG basis functions to describe electric and 
magnetic surface currents flowing on the surfaces in a 
geometry.

\subsection*{RWG Basis Functions}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newpage
\section{Homogeneous Dyadic Green's Functions}
\label{DyadicGreensFunctionsSection}

Before proceeding, we must pause briefly to establish our 
conventions and notation for homogeneous dyadic Green's
functions.

Consider a spatial region characterized by spatially uniform 
relative permittivity and permeability $\epsilon^r$ and 
$\mu^r$. If we have
known distributions of electric and magnetic current
$\vb J(\vb x)$ and $\vb M(\vb x),$
we can compute the electric and magnetic fields in terms
of these currents and the properties of the medium, and  
the relevant convolution kernels in this procedure are
the dyadic Green's functions (DGFs):
%====================================================================%
\begin{align*}
 E_i(\vb x, \omega) 
&= 
   \int
    \Big\{
     \Gamma\supt{EE}_{ij}(\epsilon^r, \mu^r; \omega; \vb x, \vb x^\prime) 
     J_j(\vb x^\prime)
     +
     \Gamma\supt{EM}_{ij}(\epsilon^r, \mu^r; \omega; \vb x, \vb x^\prime) 
     M_j(\vb x^\prime)
    \Big\}
    \, d\vb x^\prime
\\
 H_i(\vb x, \omega) 
&= 
   \int
    \Big\{
     \Gamma\supt{ME}_{ij}(\epsilon^r, \mu^r; \omega; \vb x, \vb x^\prime) 
     J_j(\vb x^\prime)
     +
     \Gamma\supt{MM}_{ij}(\epsilon^r, \mu^r; \omega; \vb x, \vb x^\prime) 
     M_j(\vb x^\prime)
    \Big\}
    \, d\vb x^\prime.
\end{align*}
%====================================================================%

Explicit expressions for the DGFs are 
%====================================================================%
\begin{align*}
\BG\supt{EE}(\epsilon^r, \mu^r, \omega, \vb x, \vb x^\prime)
&=
 iZ_0 Z^r k^r \, \vb G(k^r, \vb x-\vb x^\prime)
\\[8pt]
%--------------------------------------------------------------------%
\BG\supt{ME}(\epsilon^r, \mu^r, \omega, \vb x, \vb x^\prime)
&=
 -ik^r \vb C(k^r, \vb x-\vb x^\prime)
\\[8pt]
%--------------------------------------------------------------------%
\BG\supt{EM}(\epsilon^r, \mu^r, \omega, \vb x, \vb x^\prime)
&=
 ik^r \, \vb C(k^r, \vb x-\vb x^\prime)
\\[8pt]
%--------------------------------------------------------------------%
\BG\supt{MM}(\epsilon^r, \mu^r, \omega, \vb x, \vb x^\prime)
&= \frac{ik^r}{Z_0 Z^r} \vb G(k^r, \vb x-\vb x^\prime)
\end{align*}
%====================================================================%
$$\bigg(Z_0=\sqrt\frac{\mu_0}{\epsilon_0},
        \qquad
        Z^r=\sqrt\frac{\mu^r}{\epsilon^r}, 
         \qquad
        k^r=\sqrt{\mu_0 \mu^r \epsilon_0 \epsilon^r}\cdot \omega
  \bigg)
$$
%====================================================================%
where $\vb G$, the ``photon Green's function,''
is the solution to the equation
\begin{equation}
 \Big[\nabla \times \nabla\times - \,\,k^2 \Big]\vb G(k; \vb r)
 =\delta(\vb r)\vb{1};
 \label{DyadicGFG}
\end{equation}
and $\vb C$ is defined by  
\begin{equation}
  \vb C(k, \vb r) = -\frac{1}{ik} \nabla \times \vb G(k, \vb r).
 \label{DyadicGFC}
\end{equation}
%
(Note that the $\BG$ dyadics depend separately on $\epsilon,\mu,$ 
and $\omega$, while $\vb G$ and $\vb C$ depend only on the 
combination $k=\sqrt{\epsilon\mu}\cdot \omega.$)

Explicit expressions for the components of $\vb G$ and $\vb C$ are 
\begin{align*}
G_{ij}(k,\vb r) 
 &= \frac{e^{ikr}}{4\pi (ik)^2 r^3}
    \bigg[ \Big(1-ikr + (ikr)^2 \Big)\delta_{ij}
          +\Big(-3 + 3ikr - (ikr)^2 \Big)\frac{r_i r_j}{r^2}
    \bigg]
\\
C_{ij}(k,\vb r) 
 &= \frac{e^{ikr}}{4\pi (ik) r^3} \varepsilon_{ijk} r_k 
    \Big(-1+ikr\Big)
\end{align*}
These may also be written in the form

\begin{equation}
G_{ij}(k,\vb r) =
  \Big[\delta_{\mu\nu} +\frac{1}{k} \partial_i \partial_j \Big]
  G_0(k, \vb r), \qquad
  C_{ij}(k, \vb r) = +\frac{1}{i\kappa} \varepsilon_{ijl} 
                          \partial_l G_0(k, \vb r)
\label{GCfromG0}
\end{equation}
where $G_0$ is the scalar Green's function for the Helmholtz equation,
\numeq{ScalarGF}
{G_0(k; \vb r)
   =
  \frac{e^{ik|\vb r|}}{4\pi|\vb r|}
}
which satisfies
$$ \Big[ \nabla^2 + k^2 \Big] G_0(k; \vb r)
   =\delta(\vb r).
$$
With these expressions, we can verify that equation (\ref{DyadicGFC}) 
is actually just the first half of a pair of reciprocal curl identities 
relating $\vb G$ and $\vb C:$
\numeq{ReciprocalCurlIdentities}
{
  \frac{1}{ik} \nabla \times \vb G=-\vb C, 
\qquad
  \frac{1}{ik} \nabla \times \vb C=\vb G.
}
(As usual with tensors and dyadics, the vector notation here
is suggestive but vague; the precise meaning of (\ref{DyadicGFC}) is 
\numeq{ReciprocalCurlIdentities2}
{
   \frac{1}{ik} \varepsilon_{iAB} \partial_A G_{Bj} = -C_{ij},
   \qquad
   \frac{1}{ik} \varepsilon_{iAB} \partial_A C_{Bj} = G_{ij}.)
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\paragraph{Shorthand} In what follows, an equation like 

$$ E_i(\vb x, \omega) = 
   \int_{\mathcal S} 
     \Gamma\supt{EE}_{ij}(\epsilon^r, \mu^r; \omega; 
                          \vb x, \vb x^\prime) 
     K_j(\vb x^\prime)
    \, d\vb x^\prime
$$
will often be abbreviated to read 
$$ \vb E(\vb x) = 
    \int_{\mathcal S} 
      \BG\supt{EE}(\mathcal{R}^r; \vb x, \vb x^\prime) 
         \cdot \vb K(\vb x^\prime) 
    \, d\vb x^\prime
$$
(with $\omega$ arguments suppressed and the dependence 
on $\epsilon^r, \mu^r$ condensed into a dependence
on the region $\mathcal{R}^r$), or even abbreviated further
to read
$$ \vb E = \BG\supt{EE}(\mathcal{R}^r) * \vb K $$
where $*$ denotes a convolution operation.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newpage
\section{Computation of the fields in \lss geometries}

Consider a point $\vb x$ in some region $\mathcal{R}$
of a \lss geometry. In general, $\mathcal{R}$
will be bounded by some collection of surfaces
$\{\mathcal{S}^s\}$. Let's subdivide the set of 
surfaces bounding $\mathcal{R}$ into two groups:
a first set $\{\mathcal{S}^\alpha\}$ for which
$\mathcal{R}$ is the \textit{exterior} surface,
and a second set $\{\mathcal{S}^\beta\}$ for which
$\mathcal{R}$ is the \textit{interior} surface.
Then the electric field at $\vb x$ is
%====================================================================%
\begin{align} 
E_i(\vb x) 
    = &\hphantom{-} \sum_\alpha \int_{\mathcal{S}^\alpha} 
           \Big\{ \Gamma_{ij}\supt{EE}(\mathcal{R}; \vb x, \vb x^\prime) 
                   K_j(\vb x^\prime)
                  \,+\,
                   \Gamma_{ij}\supt{EM}(\mathcal{R}; \vb x, \vb x^\prime) 
                   N_j(\vb x^\prime)
           \Big\} \, d\vb x^\prime
\nn
     &-\sum_\beta \int_{\mathcal{S}^\beta} 
           \Big\{ \Gamma_{ij}\supt{EE}(\mathcal{R}; \vb x, \vb x^\prime) 
                   K_j(\vb x^\prime)
                  \,+\,
                   \Gamma_{ij}\supt{EM}(\mathcal{R}; \vb x, \vb x^\prime) 
                   N_j(\vb x^\prime)
           \Big\} \, d\vb x^\prime
\nn
     &+E^{\text{\scriptsize inc},r}_i(\vb x).
\label{FieldContributionsEquation}
\end{align}
%====================================================================%
In this equation, 
$\vb E^{\text{\scriptsize inc},r}$ is the field due to any 
incident field sources that lie inside the region $\mathcal{R}^r.$
(The $\vb H$ fields are given by identical relations with 
$\{ \Gamma\supt{EE}, \Gamma\supt{EM}, E^{\text{\scriptsize inc},r}\}  \to 
 \{ \Gamma\supt{ME}, \Gamma\supt{MM}, H^{\text{\scriptsize inc},r}\}$.)

Note the following points with respect to equation
(\ref{FieldContributionsEquation}):
\begin{itemize}
  \item Sources on surfaces $\mathcal{S}_\alpha$ for which
        $\mathcal{R}$ is the exterior medium  
        contribute to the fields at $\vb x$ 
        with a positive sign.
        Sources on surfaces $\mathcal{S}_\beta$ for which
        $\mathcal{R}$ is the interior medium  
        contribute to the fields at $\vb x$ 
        with a negative sign.

  \item In each line of (\ref{FieldContributionsEquation}), 
        (i.e. regardless of the surface over which we are 
        integrating) the Green's functions used to compute
        the fields at $\vb x$ are the Green's functions for
        the homogeneous region $\mathcal{R}$ containing $\vb x$.
        The material properties of other regions are not
        referenced.
\end{itemize}

%####################################################################%
%####################################################################%
%####################################################################%
\begin{figure}
\begin{center}
%\includegraphics{FieldContributionsFigure}
\caption{Contributions of objects to the scattered fields at 
         an arbitrary point $\vb x$. Objects $\mathcal{O}_\beta$
         and $\mathcal{O}_\gamma$ contribute
         to the field at $\vb x$ ``with a plus sign'' 
         (cf. equation \ref{FieldContributionsEquation}).
         Object $\mathcal{O}_\alpha$ 
         contributes to the field at $\vb x$ ``with a minus
         sign.'' Objects $\mathcal{O}_\delta$ and $\mathcal{O}_\lambda$
         do not contribute to the field at $\vb x$.}
\label{FieldContributionsFigure}
\end{center}
\end{figure}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newpage
\section{The Equations Solved by \ls: Continuous Forms}

\subsection{The equation imposed at points on PEC object surfaces}

At each point $\vb x$ on the surface of a PEC object,
we require that the tangential components of the 
total (incident + scattered) field vanish:
\numeq{PECEquation1}
{ \vbhat{n}\times \vb E\sups{total} (\vb x)=0 
}
where $\vbhat{n}$ is the normal to the object surface
at $\vb x$. 
To break this down a little further, suppose that $\vb x$
lies on the surface of object $\mathcal{O}_\beta$ in
Figure (\ref{FieldContributionsFigure}). Then (\ref{PECEquation1}) 
reads
%====================================================================%
\begin{align}
\vbhat{n}\times
 \Bigg[  &\hphantom{+}\,\,\int_{\mathcal{S_\beta}} 
           \Big\{ \BG\supt{EE}(\alpha)*\vb K \Big\} \, d\vb x^\prime
\nn
         &+\int_{\mathcal{S_{\beta^\prime}}} 
           \Big\{ \BG\supt{EE}(\alpha)*\vb K \Big\} \, d\vb x^\prime
\nn
         &+\int_{\mathcal{S_\gamma}} 
           \Big\{ \BG\supt{EE}(\alpha)*\vb K 
                 +\BG\supt{EM}(\alpha)*\vb N \Big\} \, d\vb x^\prime
\nn
         &-\int_{\mathcal{S_\alpha}} 
           \Big\{ \BG\supt{EE}(\alpha)*\vb K 
                 +\BG\supt{EM}(\alpha)*\vb N \Big\} \, d\vb x^\prime
 \Bigg]
= -\chi\sups{inc}_\alpha \vbhat{n}\times \vb E\sups{inc}(\vb x)
\label{PECEquationBreakdown}
\end{align}
%====================================================================%
where $S_\alpha$ is the surface of the object $\mathcal{O}_\alpha$ 
that contains $\mathcal{O}_\beta$ (which may be the exterior medium, 
in which case the last bracketed term on the LHS 
of (\ref{PECEquationBreakdown}) vanishes),
$\beta^\prime$ runs over any other PEC objects contained
within $\mathcal{O}_\alpha$, and $\gamma$ runs over
any dielectric objects contained within 
$\mathcal{O}_\alpha$.

The incident field only contributes to the total field
inside object $\mathcal{O}_\alpha$, 
and thus only contributes to equation (\ref{PECEquation1}),
if the incident field sources are contained inside 
$\mathcal{O}_\alpha$. This dependence is represented by the 
quantity $\chi\sups{inc}_\alpha$ on the RHS of 
(\ref{PECEquationBreakdown}), which is an 
\textit{indicator function} characterizing the location of 
the incident field sources:
$$
 \chi\sups{inc}_\alpha
 =\begin{cases} 
    1, \qquad &\text{if the incident field sources lie inside 
                      $\mathcal{O}_\alpha$} \\
    0, \qquad &\text{otherwise.}
  \end{cases} 
$$

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{The equation imposed at points on dielectric object surfaces}

At each point $\vb x$ on the surface of a dielectric object, we require
that the tangential components of the total $\vb E$ and $\vb H$ fields
be continuous as we pass from just inside to just outside the 
surface,
%====================================================================%
\begin{subequations}
\begin{align}
 \lim_{\eta \to 0} \vbhat{n}\times 
 \Big[ \vb E\sups{total}(\vb x + \eta\vbhat{n})
      -\vb E\sups{total}(\vb x - \eta\vbhat{n})
 \Big] 
&= 0 
\\
 \lim_{\eta \to 0} \vbhat{n}\times 
 \Big[ \vb H\sups{total}(\vb x + \eta\vbhat{n})
      -\vb H\sups{total}(\vb x - \eta\vbhat{n})
 \Big] 
&= 0.
\label{DielectricEquation1}
\end{align}
\end{subequations}
%====================================================================%
Referring again to Figure (\ref{FieldContributionsFigure}), let 
$\mathcal{O}_\gamma$ be the dielectric object in question, let 
$\mathcal{O}_\alpha$ be the object containing 
$\mathcal{O}_\gamma$, 
let $\mathcal{O}_{\gamma^\prime}$ represent any other dielectric
objects contained in $\mathcal{O}_\alpha$, 
let $\mathcal{O}_{\beta}$ represent any PEC objects contained 
in $\mathcal{O}_\alpha$, and let $\mathcal{O}_\delta$ represent 
any objects contained inside $\mathcal{O}_\gamma$.

Then the total $E$-field as we approach $\vb x$ from 
\textit{inside} $\mathcal{O}_\gamma$ is 
%====================================================================%
\begin{align} 
E\sups{total}_i(\vb x) 
    = &-\int_{\mathcal{S}_\gamma} 
           \Big\{ \Gamma_{ij}\supt{EE}(\gamma; \vb x, \vb x^\prime) 
                   K_j(\vb x^\prime)
                  \,+\,
                   \Gamma_{ij}\supt{EM}(\gamma; \vb x, \vb x^\prime) 
                   N_j(\vb x^\prime)
           \Big\} \, d\vb x^\prime
\nn
     &+\int_{\mathcal{S}_\delta}
           \Big\{ \Gamma_{ij}\supt{EE}(\gamma; \vb x, \vb x^\prime) 
                   K_j(\vb x^\prime)
                  \,+\,
                   \Gamma_{ij}\supt{EM}(\gamma; \vb x, \vb x^\prime) 
                   N_j(\vb x^\prime)
           \Big\} \, d\vb x^\prime.
\nn
     &+\chi\sups{inc}_\gamma E_i\supt{inc}(\vb x)
\label{FieldInsideDielectric}
\end{align}
%====================================================================%
(we have assumed that $\mathcal{O}_\delta$ is dielectric, but 
the PEC case is similar), while the 
total $E$-field as we approach $\vb x$ from \textit{outside} 
$\mathcal{O}_\gamma$ is 
%====================================================================%
\begin{align} 
E\sups{total}_i(\vb x) 
    = &+\int_{\mathcal{S}_\gamma} 
           \Big\{ \Gamma_{ij}\supt{EE}(\alpha; \vb x, \vb x^\prime) 
                   K_j(\vb x^\prime)
                  \,+\,
                   \Gamma_{ij}\supt{EM}(\alpha; \vb x, \vb x^\prime) 
                   N_j(\vb x^\prime)
           \Big\} \, d\vb x^\prime
\nn
     &+\int_{\mathcal{S}_{\gamma^\prime}}
           \Big\{ \Gamma_{ij}\supt{EE}(\alpha; \vb x, \vb x^\prime) 
                   K_j(\vb x^\prime)
                  \,+\,
                   \Gamma_{ij}\supt{EM}(\alpha; \vb x, \vb x^\prime) 
                   N_j(\vb x^\prime)
           \Big\} \, d\vb x^\prime.
\nn
     &+\int_{\mathcal{S}_{\beta}}
           \Big\{ \Gamma_{ij}\supt{EE}(\alpha; \vb x, \vb x^\prime) 
                   K_j(\vb x^\prime)
           \Big\} \, d\vb x^\prime
\nn
     &-\int_{\mathcal{S}_{\alpha}}
           \Big\{ \Gamma_{ij}\supt{EE}(\alpha; \vb x, \vb x^\prime) 
                   K_j(\vb x^\prime)
                  \,+\,
                   \Gamma_{ij}\supt{EM}(\alpha; \vb x, \vb x^\prime) 
                   N_j(\vb x^\prime)
           \Big\} \, d\vb x^\prime
\nn
     &+\chi\sups{inc}_\alpha E_i\supt{inc}(\vb x).
\label{FieldOutsideDielectric}
\end{align}
%====================================================================%
Inserting (\ref{FieldInsideDielectric}) and 
(\ref{FieldOutsideDielectric}) into (\ref{DielectricEquation1}), 
the first of the two conditions imposed at $\vb x$ is
%====================================================================%
\begin{align}
\vbhat{n}\times
 \Bigg[  &\hphantom{+}\,\,\int_{\mathcal{S_\gamma}}
           \Big\{ \big[\BG\supt{EE}(\alpha) + \BG\supt{EE}(\gamma)\big]
                   *\vb K 
                + \big[\BG\supt{EM}(\alpha) + \BG\supt{EM}(\gamma)\big]
                   *\vb N 
           \Big\} \, d\vb x^\prime
\nn
         &+\int_{\mathcal{S}_{\gamma^\prime}}
           \Big\{ \BG\supt{EE}(\alpha)*\vb K 
                 +\BG\supt{EM}(\alpha)*\vb N 
           \Big\} \, d\vb x^\prime
\nn
         &+\int_{\mathcal{S_\beta}} 
           \Big\{ \BG\supt{EE}(\alpha)*\vb K \Big\} \, d\vb x^\prime
\nn
         &-\int_{\mathcal{S_\alpha}}
           \Big\{ \BG\supt{EE}(\alpha)*\vb K 
                 +\BG\supt{EM}(\alpha)*\vb N 
           \Big\} \, d\vb x^\prime
\nn
         &-\int_{\mathcal{S_\delta}} 
           \Big\{ \BG\supt{EE}(\gamma)*\vb K 
                 +\BG\supt{EM}(\gamma)*\vb N 
           \Big\} \, d\vb x^\prime
 \Bigg]
= \Big[\chi\sups{inc}_\gamma - \chi\sups{inc}_\alpha\Big] 
   \vbhat{n}\times \vb E\sups{inc}(\vb x)
\label{DielectricEquationBreakdown}
\end{align}
%====================================================================%
and the second of the two conditions is identical 
but with 
$\{\BG\supt{EE}, \BG\supt{EM}\} \to 
 \{\BG\supt{ME}, \BG\supt{MM}\}$.

\subsection{The equations in the presence of nonzero surface impedance}

\medskip

\subsubsection*{PEC bodies} 

In the presence of a nonzero surface impedance $Z_s(\vb x)>0$
(corresponding to a finite surface conductivity
 $G_s(\vb x) = \frac{1}{Z_s(\vb x)} < \infty$),
equation (\ref{PECEquation1}) is modified to read 

\numeq{PECEquationZS}
{ \vbhat{n}\times \vb E\sups{total} (\vb x) 
  = 
  \frac{1}{G_s(\vb x)} \vbhat{n}\times \vb K(\vb x)
}
where $\vb K(\vb x)$ is the (unknown) electric surface current
at $\vb x$. 

Note that we use the symbol $G$, not $\sigma$, for surface
conductivity, because this quantity has the dimensions of a 
conductance (current/voltage), not the dimensions of a conductivity
[current/(voltage $\cdot $length)].

\subsubsection*{General bodies} 

In the presence of a nonvanishing surface impedance $Z_s(\vb x)$
(corresponding to a finite surface conductivity, 
 $G_s(\vb x) = \frac{1}{Z_s(\vb x)} < \infty$),
the $\vb E$-field continuity equation [the first of equations
(\ref{DielectricEquation1})] is unchanged, while the $\vb H$-field
continuity equation is modified to read
%====================================================================%
\begin{subequations}
\begin{align}
 \lim_{\eta \to 0} \vbhat{n}\times 
 \Big[ \vb H\sups{total}(\vb x + \eta\vbhat{n})
      -\vb H\sups{total}(\vb x - \eta\vbhat{n})
 \Big] 
&= G(\vb x) \vb E\sups{total}(\vb x)
\\
&= -G(\vb x) \vbhat{n} \times \vb{N}(\vb x)
\label{DielectricEquationZS}
\end{align}
\end{subequations}
is the (unknown) magnetic surface current at $\vb x$.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newpage
\section{Introduction of the $-Z_0$ Prefactor in the 
         Magnetic Current Expansion} 

In rough schematic form, the equations derived in the 
previous section take the form 
%====================================================================%
$$ \left( \begin{array}{cc}
   \BG\supt{EE} & \BG\supt{EM} \\
   \BG\supt{ME} & \BG\supt{MM} \\
   \end{array} \right)
   *
   \left( \begin{array}{c} \vb K \\  \vb N\end{array}\right)
   = 
   -
   \left( \begin{array}{c}
   \vb E\sups{inc} \\
   \vb H\sups{inc} \\
   \end{array}\right)
$$
%====================================================================%
where $*$ denotes a convolution operation.

The matrix kernel on the LHS is not symmetric because 
$\BG\supt{EM} = -\BG\supt{ME}$. To remedy this, I 
\textbf{(a)} scale the magnetic current by $-1/Z_0$, and then
\textbf{(b)} divide the upper row of the system by $Z_0$ to obtain
the following symmetric 
system\footnote{L.~N. Medgyesi-Mitschang, J.~M. Putnam, and M.~B. Gedera, ``Generalized method
  of moments for three-dimensional penetrable scatterers,'' \emph{J. Opt. Soc.
  Am. A}, vol.~11, no.~4, pp. 1383--1398, Apr 1994.}:
%====================================================================%
\renewcommand{\arraystretch}{2.0}
\numeq{lsSystem}
{ \left( \begin{array}{cc}
   \displaystyle{ \frac{1}{Z_0} \BG\supt{EE}} 
   & 
   \displaystyle{-\BG\supt{EM}}
   \\
   \displaystyle{\BG\supt{ME}}
   & 
   \displaystyle{-Z_0\BG\supt{MM}} \\
   \end{array} \right)
   *
   \left( \begin{array}{c} 
      \displaystyle{\vb K} 
      \\
      \displaystyle{-\frac{1}{Z_0}\vb N}
   \end{array}\right)
   = 
   -
   \left( \begin{array}{c}
   \displaystyle{\frac{1}{Z_0} \vb E\sups{inc}} 
   \\
   \displaystyle{\vb H\sups{inc}}
   \end{array}\right)
}
\renewcommand{\arraystretch}{1.0}
Equation (\ref{lsSystem}) is the actual linear system
solved by \ls. 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newpage
\section{The Equations Solved by \ls: Discrete Forms}

\subsubsection*{Discretization Procedure} 

\lss uses a two-step procedure to discretize the integral equations 
derived in the previous sections. 
Briefly, we approximate the $\vb K$ and $\vb N$ surface-current 
distributions as expansions in RWG basis functions, then 
Galerkin-test the resulting equations again with the RWG basis
functions. 

In more detail,

\begin{enumerate}
 \item First, \lss approximates surface currents as expansions 
       in RWG basis functions.

       For electric currents on the surfaces of PEC objects, 
       we have the expansion
       \begin{subequations}
       %====================================================================%
       \begin{equation}
         \vb K(\vb x) \approx \sum K_{\alpha n} \vb f_{\alpha n}(\vb x)
       \end{equation}
       %====================================================================%
       where $\alpha$ runs over all PEC objects in the geometry
       and $n$ runs over all RWG basis functions on object 
       $\mathcal{O}_\alpha$.

       For electric and magnetic currents on the surfaces of 
       dielectric objects, we have the expansions
       %====================================================================%
       \begin{equation}
           \vb K(\vb x) \approx \sum K_{\beta n} \vb f_{\beta n}(\vb x), 
           \qquad 
           \vb N(\vb x) \approx -Z_0 \sum N_{\beta n} \vb f_{\beta n}(\vb x)
       \end{equation}
       %====================================================================%
       \label{KNExpansions}
       \end{subequations}
       \noindent where $\beta $ runs over all PEC objects in the geometry
       and $n$ runs over all RWG basis functions on object
       $\mathcal{O}_\beta$. (The rationale for the prefactor $-Z_0$ 
       was explained in the previous section).

 \item Second, \lss obtains one equation for each of the unknown
       $K$ and $N$ coefficients in (\ref{KNExpansions}) by proceeding
       as follows.

       First, we take the inner product of equation
       (\ref{PECEquationBreakdown})
       with each RWG basis function $\vb f_{\alpha n}$ defined on 
       the surface of each PEC object. This gives us one equation
       for each of the $K_{\alpha n}$ coefficients in 
       (\ref{KNExpansions}a).

       Second, we take the inner product of equation
       (\ref{DielectricEquationBreakdown})
       with each RWG basis function $\vb f_{\beta n}$ defined on 
       the surface of each dielectric object. We associate the 
       resulting equation with the coefficient $K_{\beta n}$ in
       (\ref{KNExpansions}b). Then, we take the inner product of 
       the magnetic analogue of 
       (\ref{DielectricEquationBreakdown}) (which, as stated above,
       is identical to (\ref{DielectricEquationBreakdown}) with
       the replacements $\{\BG\supt{EE}, \BG\supt{EM}\} \to 
       \{\BG\supt{ME}, \BG\supt{MM}\}$) with $\vb f_{\beta n})$
       and associate the resulting equation with the coefficient
       $N_{\beta n}$ in (\ref{KNExpansions}b).
\end{enumerate}

\subsubsection*{Discretized Version of Equation 
                (\ref{PECEquationBreakdown})}

We consider again the setting of Figure \ref{EmbeddedObjects}:
We have a PEC object $\mathcal{O}_\beta$, embedded in an object
$\mathcal{O}_\alpha$ (which may be the environment 
$\mathcal{O}_e$); also embedded in $\mathcal{O}_\alpha$ are
additional PEC object(s) $\mathcal{O}_{\beta^\prime}$ and dielectric 
object(s) $\mathcal{O}_\gamma.$ 
Inserting expansions (\ref{KNExpansions}) 
into (\ref{PECEquationBreakdown})
and Galerkin-testing with a basis function $\vb f_{\beta m}$ on 
the surface of $\mathcal{O}_\beta$ yields 
(after dividing both 
sides of the equation by $Z_0$ as per equation (\ref{lsSystem}):
%====================================================================%
\begin{align}
&\sum_{n=1}^{\texttt{NEdges}(\beta)} 
   \Big\langle 
         \vb f_{\beta m} 
   \Big| \frac{1}{Z_0} \BG\supt{EE}(\alpha) \Big|
         \vb f_{\beta n}
   \Big\rangle 
         K_{\beta n}
\nn
%--------------------------------------------------------------------%
+&\sum_{n=1}^{\texttt{NEdges}(\beta^\prime)} 
   \Big\langle 
         \vb f_{\beta m} 
   \Big| \frac{1}{Z_0} \BG\supt{EE}(\alpha) \Big| 
         \vb f_{\beta^\prime n}
   \Big\rangle 
         K_{\beta^\prime n}
\nn
%--------------------------------------------------------------------%
+&\sum_{n=1}^{\texttt{NEdges}(\gamma)} \bigg\{
   \Big\langle 
         \vb f_{\beta m} 
   \Big| \frac{1}{Z_0} \BG\supt{EE}(\alpha) \Big| 
         \vb f_{\gamma n}
   \Big\rangle 
         K_{\gamma n}
   \,-
   \Big\langle 
         \vb f_{\beta m} 
   \Big| \BG\supt{EM}(\alpha) \Big| 
         \vb f_{\gamma n}
   \Big\rangle 
         N_{\gamma n}
  \bigg\}
\nn
%--------------------------------------------------------------------%
-&\sum_{n=1}^{\texttt{NEdges}(\alpha)} \bigg\{
   \Big\langle 
         \vb f_{\beta m} 
   \Big| \frac{1}{Z_0} \BG\supt{EE}(\alpha) \Big| 
         \vb f_{\alpha n}
   \Big\rangle 
         K_{\alpha n}
   \,-
   \Big\langle 
         \vb f_{\beta m} 
   \Big| \BG\supt{EM}(\alpha) \Big| 
         \vb f_{\alpha n}
   \Big\rangle 
         N_{\alpha n}
  \bigg\}
\nn
%--------------------------------------------------------------------%
&=-\frac{1}{Z_0} \chi_\alpha\sups{inc} 
   \Big\langle \vb f_{\beta m} \Big| \vb E\sups{inc} \Big\rangle.
 \label{DiscretizedPECEquation}
\end{align}
%====================================================================%

\subsubsection*{Discretized Version of Equation
                (\ref{DielectricEquationBreakdown}) and its 
                Magnetic Analogue}

Again in the setting of Figure \ref{EmbeddedObjects}, we 
Galerkin-test equation (\ref{DielectricEquationBreakdown}) 
with a basis function $\vb f_{\gamma m}$ on the surface
of object $\mathcal{O}_\gamma$ to find (again, dividing through
by $Z_0$ as per (\ref{lsSystem})):
%====================================================================%
\begin{subequations}
\begin{align}
&\sum_{n=1}^{\texttt{NEdges}(\gamma)}  \bigg\{
   \Big\langle 
         \vb f_{\gamma m} 
   \Big| \frac{1}{Z_0} \BG\supt{EE}(\alpha) + \frac{1}{Z_0} \BG\supt{EE}(\gamma) \Big|
         \vb f_{\gamma n}
   \Big\rangle 
         K_{\gamma n}
   -
   \Big\langle 
         \vb f_{\gamma m} 
   \Big| \BG\supt{EM}(\alpha) + \BG\supt{EM}(\gamma) \Big|
         \vb f_{\gamma n}
   \Big\rangle 
         N_{\gamma n}
  \bigg\}
\nn
%--------------------------------------------------------------------%
&\sum_{n=1}^{\texttt{NEdges}(\gamma^\prime)}  \bigg\{
   \Big\langle 
         \vb f_{\gamma m} 
   \Big| \frac{1}{Z_0}\BG\supt{EE}(\alpha) \Big|
         \vb f_{\gamma^\prime n}
   \Big\rangle 
         K_{\gamma^\prime n}
   -
   \Big\langle 
         \vb f_{\gamma m} 
   \Big| \BG\supt{EM}(\alpha) \Big|
         \vb f_{\gamma^\prime n}
   \Big\rangle 
         N_{\gamma^\prime n}
  \bigg\}
\nn
%--------------------------------------------------------------------%
+&\sum_{n=1}^{\texttt{NEdges}(\beta)} 
   \Big\langle 
         \vb f_{\gamma m} 
   \Big| \frac{1}{Z_0} \BG\supt{EE}(\alpha) \Big| 
         \vb f_{\beta n}
   \Big\rangle 
         K_{\beta n}
\nn
%--------------------------------------------------------------------%
-&\sum_{n=1}^{\texttt{NEdges}(\alpha)} \bigg\{
   \Big\langle 
         \vb f_{\gamma m} 
   \Big| \frac{1}{Z_0} \BG\supt{EE}(\alpha) \Big| 
         \vb f_{\alpha n}
   \Big\rangle 
         K_{\alpha n}
   \,-
   \Big\langle 
         \vb f_{\gamma m} 
   \Big| \BG\supt{EM}(\alpha) \Big| 
         \vb f_{\alpha n}
   \Big\rangle 
         N_{\alpha n}
  \bigg\}
\nn
%--------------------------------------------------------------------%
-&\sum_{n=1}^{\texttt{NEdges}(\delta)} \bigg\{
   \Big\langle 
         \vb f_{\gamma m} 
   \Big| \frac{1}{Z_0} \BG\supt{EE}(\gamma) \Big| 
         \vb f_{\delta n}
   \Big\rangle 
         K_{\delta n}
   \,-
   \Big\langle 
         \vb f_{\gamma m} 
   \Big| \BG\supt{EM}(\gamma) \Big| 
         \vb f_{\delta n}
   \Big\rangle 
         N_{\delta n}
  \bigg\}
\nn
%--------------------------------------------------------------------%
&=\frac{1}{Z_0} \Big[\chi_\gamma\sups{inc} - \chi_\alpha\sups{inc}\Big] 
   \Big\langle \vb f_{\gamma m} \Big| \vb E\sups{inc} \Big\rangle.
\end{align}

\subsubsection*{Discretized Version of the Magnetic Analogue of 
                Equation (\ref{DielectricEquationBreakdown})}

Finally,, we Galerkin-test the magnetic-field analogue of 
(\ref{DielectricEquationBreakdown}) to find
\begin{align}
&\sum_{n=1}^{\texttt{NEdges}(\gamma)}  \bigg\{
   \Big\langle 
         \vb f_{\gamma m} 
   \Big| \BG\supt{ME}(\alpha) + \BG\supt{ME}(\gamma) \Big|
         \vb f_{\gamma n}
   \Big\rangle 
         K_{\gamma n}
   -
   \Big\langle 
         \vb f_{\gamma m} 
   \Big| Z_0\BG\supt{MM}(\alpha) + Z_0\BG\supt{MM}(\gamma) \Big|
         \vb f_{\gamma n}
   \Big\rangle 
         N_{\gamma n}
  \bigg\}
\nn
%--------------------------------------------------------------------%
&\sum_{n=1}^{\texttt{NEdges}(\gamma^\prime)}  \bigg\{
   \Big\langle 
         \vb f_{\gamma m} 
   \Big| \BG\supt{ME}(\alpha) \Big|
         \vb f_{\gamma^\prime n}
   \Big\rangle 
         K_{\gamma^\prime n}
   -
   \Big\langle 
         \vb f_{\gamma m} 
   \Big| Z_0\BG\supt{MM}(\alpha) \Big|
         \vb f_{\gamma^\prime n}
   \Big\rangle 
         N_{\gamma^\prime n}
  \bigg\}
\nn
%--------------------------------------------------------------------%
+&\sum_{n=1}^{\texttt{NEdges}(\beta)} 
   \Big\langle 
         \vb f_{\gamma m} 
   \Big| \BG\supt{ME}(\alpha) \Big| 
         \vb f_{\beta n}
   \Big\rangle 
         K_{\beta n}
\nn
%--------------------------------------------------------------------%
-&\sum_{n=1}^{\texttt{NEdges}(\alpha)} \bigg\{
   \Big\langle 
         \vb f_{\gamma m} 
   \Big| \BG\supt{ME}(\alpha) \Big| 
         \vb f_{\alpha n}
   \Big\rangle 
         K_{\alpha n}
   \,-
   \Big\langle 
         \vb f_{\gamma m} 
   \Big| Z_0 \BG\supt{MM}(\alpha) \Big| 
         \vb f_{\alpha n}
   \Big\rangle 
         N_{\alpha n}
  \bigg\}
\nn
%--------------------------------------------------------------------%
-&\sum_{n=1}^{\texttt{NEdges}(\delta)} \bigg\{
   \Big\langle 
         \vb f_{\gamma m} 
   \Big| \BG\supt{ME}(\gamma) \Big| 
         \vb f_{\delta n}
   \Big\rangle 
         K_{\delta n}
   \,-
   \Big\langle 
         \vb f_{\gamma m} 
   \Big| Z_0 \BG\supt{MM}(\gamma) \Big| 
         \vb f_{\delta n}
   \Big\rangle 
         N_{\delta n}
  \bigg\}
\nn
%--------------------------------------------------------------------%
&=\Big[\chi_\gamma\sups{inc} - \chi_\alpha\sups{inc}\Big] 
   \Big\langle \vb f_{\gamma m} \Big| \vb H\sups{inc} \Big\rangle.
\end{align}
\label{DiscretizedDielectricEquation}
\end{subequations}
%====================================================================%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newpage
\section{Structure of the BEM System}

The discretization procedure of the previous section results in a 
linear system of the form
\numeq{BEMSystem}
{ \Big[ \vb M \Big]  \cdot \Big[ \vb{KN} \Big] = \Big[ \vb{RHS} \Big ] }
where the vector $\big[\vb{KN}\big]$ contains the unknown 
$K$ and $N$ coefficients from equation (\ref{KNExpansions}),
the matrix $\big[\vb M\big]$ is the ``BEM matrix,''
and the right-hand-side vector $\big[\vb{RHS}\big]$ 
depends on the incident fields.

In the remainder of this section we will describe the structure
of each of the entities in equation (\ref{BEMSystem}). 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Structure of the coefficient vector}

The $\vb{KN}$ vector contains the $K$ and $N$ coefficients
in (\ref{KNExpansions}), ordered as follows:

\begin{enumerate}
 \item All coefficients for object $\mathcal{O}_1$ come first, 
       followed by all coefficients for object $\mathcal{O}_2$, etc.

       (Object indices correspond with the order in which the 
        objects were specified in the \texttt{.rwggeo} file 
        used as input to \ls.)
       
 \item Within the portion of the vector corresponding to a 
       dielectric object, the electric and magnetic coefficients
       for the first RWG basis function come first, followed
       by the electric and magnetic coefficients
       for the second RWG basis function, etc.

\end{enumerate}

Thus, for a geometry consisting of object $\mathcal{O}_1$ (PEC)
with $M$ interior edges in its surface discretization
and object $\mathcal{O}_2$ (dielectric) with $N$ interior edges
in its surface discretization, the $\vb{KN}$ vector has dimension
$2N+M$ and looks like
%====================================================================%
$$ \vb{KN}=\left(\begin{array}{c}
   K_{11} \\ 
   \vdots \\
   K_{1M} \\ 
   K_{21} \\ 
   N_{21} \\ 
   \vdots \\
   K_{2N} \\ 
   N_{2N}
   \end{array}\right).
$$
%====================================================================%

To compute the index of any given coefficient $K_{\alpha n}$ 
or $N_{\alpha n}$ within the $\vb{KN}$ vector,
it is useful first to define functions \texttt{NBF}($\alpha$) 
and \texttt{BFIndexOffset}($\alpha$). The former of these 
is just the number of basis functions on object $\alpha$,
i.e.
$$ \texttt{NBF}(\alpha) = 
   \begin{cases}
   \texttt{NEdges}(\alpha), \qquad &\text{if object $\mathcal{O}_\alpha$
                                          is PEC} \\
   2\cdot \tt{NEdges}(\alpha), 
                        \qquad &\text{if object $\mathcal{O}_\alpha$
                                      is dielectric.} \\
   \end{cases}
$$
(Here \texttt{NEdges}($\alpha$) is the number of interior edges 
in the surface discretization of object $\mathcal{O}_\alpha$.)

The function \texttt{BFIndexOffset}($\alpha$) is the index
within the $\vb{KN}$ vector of the first coefficient corresponding
to object $\mathcal{O}_\alpha$; thus 
\begin{align*}
 \texttt{BFIndexOffset}(1) &= 1 \\
 \texttt{BFIndexOffset}(2) &= 1 + \tt{NBF}(1) \\
 \texttt{BFIndexOffset}(3) &= 1 + \tt{NBF}(1) + \tt{NBF}(2) \\
\end{align*}
et cetera.

Then I can write the following relations for the indices 
with the $\vb{KN}$ vector of individual $K, N$ coefficients.
(Note that these are one-based indices, which must be translated
into zero-based indices for use in \texttt{C++} code.)
%====================================================================%
\begin{align*}
\mathcal{I}(K, \alpha, n)
&\equiv \text{Index of coefficient $K_{\alpha n}$
              within the $\vb{KN}$ vector}
\\
&=\begin{cases}
   \texttt{BFIndexOffset}(\alpha) + n-1, 
   \qquad &\text{if $\mathcal{O}_\alpha$ is PEC} \\
   \texttt{BFIndexOffset}(\alpha) + 2(n-1),
   \qquad &\text{if $\mathcal{O}_\alpha$ is dielectric}
  \end{cases}
\\[5pt]
\mathcal{I}(N, \alpha, n)
&\equiv \text{Index of coefficient $N_{\alpha n}$ 
              within the $\vb{KN}$ vector}
\\
&=\texttt{BFIndexOffset}(\alpha) + 2(n-1)+1.
\end{align*}
%====================================================================%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Structure of the RHS vector}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Structure of the BEM matrix}

Consider two basis functions: $\vb f_{\alpha m}$, corresponding
to the $m$th interior edge of object $\mathcal{O}_\alpha$,
and $\vb f_{\beta n}$, corresponding to the $n$th interior edge
of object $\mathcal{O}_\beta.$ 

Let $\vb A$ be the index of the medium through which the 
objects interact. (If we have $\texttt{NObj}$ objects in 
our geometry, then either $1\le \vb A \le \texttt{NObj}$ 
or else $\vb A=e$ for the external medium.) Thus,

\begin{itemize}
 \item If $\mathcal{O}_\alpha$ is contained in $\mathcal{O}_\beta$, 
       then $\vb A=\beta$.
 \item If $\mathcal{O}_\beta$ is contained in $\mathcal{O}_\alpha$, 
       then $\vb A=\alpha$.
 \item If $\mathcal{O}_\alpha$ and $\mathcal{O}_\alpha$ are both
       contained in the same object $\mathcal{O}_\gamma$ (which may
       be the external medium $\mathcal{O}_e$), then  
       then $\vb A=\gamma$.
 \item If none of the above are true, then the two objects do not
       interact and the corresponding block of the BEM matrix is
       zero.
\end{itemize}

Define a symbol $\texttt{Sign}$ to have value $-1$ in the first
two cases (i.e. when one of $\mathcal{O}_\alpha$, $\mathcal{O}_\beta$
is contained inside the other), while $\texttt{Sign}=+1$ otherwise.

Then the two basis elements contribute a 
$1\times 1$, $1\times 2$, $2\times 1$, or $2\times 2$
block of matrix elements to the BEM matrix, which may be determined
by looking at equations 
(\ref{DiscretizedPECEquation}) 
and 
(\ref{DiscretizedDielectricEquation}) 
as follows:
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{enumerate}
%====================================================================%
\item \textbf{Both objects are PEC:}
%====================================================================%
$$\begin{array}{lclcl}
   M\Big( \mathcal{I}^K_{\alpha m}, \mathcal{I}^K_{\beta n} \Big) 
  &=&
  \displaystyle{ \frac{1}{Z_0} 
                 \Big\langle 
                 \vb f_{\alpha m} 
                 \Big| \BG\supt{EE}(\vb A) \Big|
                 \vb f_{\beta n} 
                 \Big\rangle
               }
%--------------------------------------------------------------------%
  &=&
  \displaystyle{
  ik\supt{A} Z\supt{A}
                \Big\langle 
                \vb f_{\alpha m} 
                \Big| \vb G(k\supt{A}) \Big|
                \vb f_{\beta n} 
                \Big\rangle
               }
\end{array}$$
%====================================================================%
\item \textbf{ $\mathcal{O}_\alpha$ is PEC, 
               $\mathcal{O}_\beta$ is dielectric:}
%====================================================================%
$$\begin{array}{lclcl}
 M\Big( \mathcal{I}^K_{\alpha m}, \mathcal{I}^K_{\beta n} \Big) 
  &=& 
  \displaystyle{ \frac{\texttt{Sign}}{Z_0} 
                 \Big\langle \vb f_{\alpha m} 
                 \Big| \BG\supt{EE}(\vb A) \Big|
                 \vb f_{\beta n} 
                 \Big\rangle
               }
%--------------------------------------------------------------------%
  &=&
  \displaystyle{ \texttt{Sign}\cdot ik\supt{A} Z\supt{A}
                 \Big\langle \vb f_{\alpha m} 
                 \Big| \vb G(k\supt{A}) \Big|
                 \vb f_{\beta n} 
                 \Big\rangle
               }
\\[10pt]
%--------------------------------------------------------------------%
%--------------------------------------------------------------------%
 M\Big( \mathcal{I}^K_{\alpha m}, \mathcal{I}^N_{\beta n} \Big) 
  &=&
  \displaystyle{ -\texttt{Sign}\cdot
                 \Big\langle 
                 \vb f_{\alpha m} 
                 \Big| \BG\supt{EM}(\vb A) \Big|
                 \vb f_{\beta n} 
                 \Big\rangle
               }
%--------------------------------------------------------------------%
  &=&
  \displaystyle{ -\texttt{Sign}\cdot ik\supt{A}
                  \Big\langle 
                  \vb f_{\alpha m} 
                  \Big| \vb C(k\supt{A})\Big|
                  \vb f_{\beta n} 
                  \Big\rangle
               }
\end{array}$$
%====================================================================%
\item \textbf{ $\mathcal{O}_\alpha$ is dielectric, 
               $\mathcal{O}_\beta$ is PEC:}
%====================================================================%
$$\begin{array}{lclcl}
 M\Big( \mathcal{I}^K_{\alpha m}, \mathcal{I}^K_{\beta n} \Big) 
  &=& 
  \displaystyle{ \frac{\texttt{Sign}}{Z_0} 
                 \Big\langle \vb f_{\alpha m} 
                 \Big| \BG\supt{EE}(\vb A) \Big|
                 \vb f_{\beta n} 
                 \Big\rangle
               }
%--------------------------------------------------------------------%
  &=&
  \displaystyle{ \texttt{Sign}\cdot ik\supt{A} Z\supt{A}
                 \Big\langle \vb f_{\alpha m} 
                 \Big| \vb G(k\supt{A}) \Big|
                 \vb f_{\beta n} 
                 \Big\rangle
               }
\\[10pt]
%--------------------------------------------------------------------%
%--------------------------------------------------------------------%
 M\Big( \mathcal{I}^N_{\alpha m}, \mathcal{I}^K_{\beta n} \Big) 
  &=&
  \displaystyle{ \texttt{Sign}\cdot
                 \Big\langle 
                 \vb f_{\alpha m} 
                 \Big| \BG\supt{ME}(\vb A) \Big|
                 \vb f_{\beta n} 
                 \Big\rangle
               }
%--------------------------------------------------------------------%
  &=&
  \displaystyle{ -\texttt{Sign}\cdot ik\supt{A}
                  \Big\langle 
                  \vb f_{\alpha m} 
                  \Big| \vb C(k\supt{A})\Big|
                  \vb f_{\beta n} 
                  \Big\rangle
               }
\end{array}$$
%====================================================================%
\item \textbf{ $\mathcal{O}_\alpha, \mathcal{O}_\beta$ are both
               dielectric and $\mathcal{O}_\alpha \ne \mathcal{O}_\beta$:}
%====================================================================
$$\begin{array}{lclcl}
 M\Big( \mathcal{I}^K_{\alpha m}, \mathcal{I}^K_{\beta n} \Big) 
  &=& 
  \displaystyle{ \frac{\texttt{Sign}}{Z_0} 
                 \Big\langle \vb f_{\alpha m} 
                 \Big| \BG\supt{EE}(\vb A) \Big|
                 \vb f_{\beta n} 
                 \Big\rangle
               }
%--------------------------------------------------------------------%
  &=&
  \displaystyle{ \texttt{Sign}\cdot ik\supt{A} Z\supt{A}
                 \Big\langle \vb f_{\alpha m} 
                 \Big| \vb G(k\supt{A}) \Big|
                 \vb f_{\beta n} 
                 \Big\rangle
               }
\\[10pt]
%--------------------------------------------------------------------%
%--------------------------------------------------------------------%
 M\Big( \mathcal{I}^K_{\alpha m}, \mathcal{I}^N_{\beta n} \Big) 
  &=&
  \displaystyle{ -\texttt{Sign}\cdot
                 \Big\langle 
                 \vb f_{\alpha m} 
                 \Big|\BG\supt{EM}(\vb A) \Big|
                 \vb f_{\beta n} 
                 \Big\rangle
               }
%--------------------------------------------------------------------%
  &=&
  \displaystyle{ -\texttt{Sign}\cdot ik\supt{A}
                  \Big\langle 
                  \vb f_{\alpha m} 
                  \Big| \vb C(k\supt{A})\Big|
                  \vb f_{\beta n} 
                  \Big\rangle
               }
\\[10pt]
%--------------------------------------------------------------------%
%--------------------------------------------------------------------%
 M\Big( \mathcal{I}^N_{\alpha m}, \mathcal{I}^K_{\beta n} \Big) 
  &=&
  \displaystyle{ \texttt{Sign}\cdot
                 \Big\langle 
                 \vb f_{\alpha m} 
                 \Big|\BG\supt{ME}(\vb A) \Big|
                 \vb f_{\beta n} 
                 \Big\rangle
               }
%--------------------------------------------------------------------%
  &=&
  \displaystyle{ -\texttt{Sign}\cdot ik\supt{A}
                  \Big\langle 
                  \vb f_{\alpha m} 
                  \Big| \vb C(k\supt{A})\Big|
                  \vb f_{\beta n} 
                  \Big\rangle
               }
\\[10pt]
%--------------------------------------------------------------------%
%--------------------------------------------------------------------%
 M\Big( \mathcal{I}^N_{\alpha m}, \mathcal{I}^N_{\beta n} \Big) 
  &=&
  \displaystyle{ -\texttt{Sign}\cdot Z_0 
                 \Big\langle 
                 \vb f_{\alpha m} 
                 \Big|\BG\supt{MM}(\vb A) \Big|
                 \vb f_{\beta n} 
                 \Big\rangle
               }
%--------------------------------------------------------------------%
  &=&
  \displaystyle{ -\frac{\texttt{Sign}\cdot ik\supt{A}}{Z\supt{A}}
                  \Big\langle 
                  \vb f_{\alpha m} 
                  \Big| \vb G(k\supt{A})\Big|
                  \vb f_{\beta n} 
                  \Big\rangle
               }
\end{array}$$
%====================================================================%
\item \textbf{ $\mathcal{O}_\alpha, \mathcal{O}_\beta$ are both
               dielectric and $\mathcal{O}_\alpha = \mathcal{O}_\beta$:}

%====================================================================%
This case is identical to the previous case, but now the matrix elements
are augmented by additional contributions describing the basis functions
interacting through the medium inside the object. Let the index
of this medium be $\vb B$. (We have $\vb B=\alpha=\beta$.) Then
the matrix elements are 
%====================================================================
\begin{align*}
 M\Big( \mathcal{I}^K_{\alpha m}, \mathcal{I}^K_{\beta n} \Big) 
 &= \frac{1}{Z_0}
    \Big\langle \vb f_{\alpha m} 
    \Big| \BG\supt{EE}(\vb A) + \BG\supt{EE}(\vb B) \Big|
                \vb f_{\beta n} 
    \Big\rangle
\\[5pt]
 &= ik\supt{A} Z\supt{A}
    \Big\langle \vb f_{\alpha m} 
                 \Big| \vb G(k\supt{A}) \Big|
                 \vb f_{\beta n} 
    \Big\rangle
    +
    ik\supt{B} Z\supt{B}
    \Big\langle \vb f_{\alpha m} 
                 \Big| \vb G(k\supt{B}) \Big|
                 \vb f_{\beta n} 
    \Big\rangle
\\[10pt]
%--------------------------------------------------------------------%
 M\Big( \mathcal{I}^K_{\alpha m}, \mathcal{I}^N_{\beta n} \Big) 
 &= -\Big\langle \vb f_{\alpha m} 
    \Big| \BG\supt{EM}(\vb A) + \BG\supt{EM}(\vb B) \Big|
                \vb f_{\beta n} 
    \Big\rangle
\\[5pt]
 &= -ik\supt{A}
    \Big\langle \vb f_{\alpha m} 
                 \Big| \vb C(k\supt{A}) \Big|
                 \vb f_{\beta n} 
    \Big\rangle
    -ik\supt{B}
    \Big\langle \vb f_{\alpha m} 
                 \Big| \vb C(k\supt{B}) \Big|
                 \vb f_{\beta n} 
    \Big\rangle
\\[10pt]
%--------------------------------------------------------------------%
 M\Big( \mathcal{I}^N_{\alpha m}, \mathcal{I}^K_{\beta n} \Big) 
 &= \Big\langle \vb f_{\alpha m} 
    \Big| \BG\supt{ME}(\vb A) + \BG\supt{ME}(\vb B) \Big|
                \vb f_{\beta n} 
    \Big\rangle
\\[5pt]
 &= -ik\supt{A}
    \Big\langle \vb f_{\alpha m} 
                 \Big| \vb C(k\supt{A}) \Big|
                 \vb f_{\beta n} 
    \Big\rangle
    -ik\supt{B}
    \Big\langle \vb f_{\alpha m} 
                 \Big| \vb C(k\supt{B}) \Big|
                 \vb f_{\beta n} 
    \Big\rangle
\\[10pt]
%--------------------------------------------------------------------%
 M\Big( \mathcal{I}^N_{\alpha m}, \mathcal{I}^N_{\beta n} \Big) 
 &= -\Big\langle \vb f_{\alpha m} 
    \Big| \BG\supt{MM}(\vb A) + \BG\supt{MM}(\vb B) \Big|
                \vb f_{\beta n} 
    \Big\rangle
\\[5pt]
 &= -\frac{ik\supt{A}}{Z\supt{A}}
    \Big\langle \vb f_{\alpha m} 
                 \Big| \vb G(k\supt{A}) \Big|
                 \vb f_{\beta n} 
    \Big\rangle
    -
    \frac{ik\supt{B}}{Z\supt{B}}
    \Big\langle \vb f_{\alpha m} 
                 \Big| \vb G(k\supt{B}) \Big|
                 \vb f_{\beta n}
    \Big\rangle.
\\[10pt]
\end{align*}
%====================================================================%
\end{enumerate}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newpage
\section{Evaluation of Integrals over RWG Basis Functions}

As demonstrated in the previous section, the elements of the 
BEM matrix involve integrals over pairs of RWG basis functions 
of the form
%====================================================================%
\begin{subequations}
\begin{align}
 \Big\langle \vb f_a \Big| \vb G(k) \Big | \vb f_b \Big \rangle
&\equiv 
  \int_{\sup \vb f_a} d\vb x_a \, 
  \int_{\sup \vb f_b} d\vb x_b\,
  \vb f_a(\vb x_a) \cdot 
  \vb G(k, \vb x_a-\vb x_b) \cdot 
  \vb f_b(\vb x_b)
\\
 \Big\langle \vb f_a \Big| \vb C(k) \Big | \vb f_b \Big \rangle
&\equiv 
  \int_{\sup \vb f_a} d\vb x_a \, 
  \int_{\sup \vb f_b} d\vb x_b \,
  \vb f_a(\vb x_a) \cdot 
  \vb C(k, \vb x_a-\vb x_b) \cdot 
  \vb f_b(\vb x_b).
\end{align}
\label{MatrixElementIntegrals}
\end{subequations}
%====================================================================%
\lss computes these integrals using one of two strategies depending
on how far apart the basis functions are from one another. To 
quantify this, let $d_{ab}$ be the distance between the centroids
of basis functions $\vb f_a$ and $\vb f_b$, and let 
$R\subs{max}=\texttt{max}(R_a, R_b)$ be the larger of the radii
of the two basis functions. (The ``radius'' of a compact source distribution
is the radius of the smallest sphere in which the source distribution
may be enclosed. For RWG basis functions, we take the centroid to be
the midpoint of the common edge shared by the two triangle that define
the basis function; then the radius is the greatest distance from the 
centroid to any of the four panel vertices 
(Figure \ref{RWGMidPointRadius}).)

Then the computation of the integrals (\ref{MatrixElementIntegrals})
proceeds as follows. 

\begin{enumerate}
 \item
 When $d_{ab} > \texttt{DBFTHRESHOLD}\cdot R\subs{max}$,
 we approximate (\ref{MatrixElementIntegrals}) using a 
 spherical-multipole expansion. 
 (Here \texttt{DBFThreshold}, the ``distant basis-function threshold,''
 is a dimensionless number that must be tuned to yield 
 optimal accuracy and performance; in \lss its value is set to 8.3.)
 \item
 Otherwise, we compute (\ref{MatrixElementIntegrals}) as a sum
 of four numerically-evaluated integrals over pairs of triangular
 panels.
\end{enumerate}

Each of these methods is described in the following sections.

\subsection{Matrix elements between distant basis functions: 
            spherical multipole method}
\label{SphericalMultipoleMatrixElementSection}

The spherical multipole method is based on the spherical-multipole
expansion of the $\vb G$ and $\vb C$ dyadics:

\begin{align*}
 \vb G(\vb x, \vb x^\prime)
 &= -ik\sum_{\alpha} 
      \left\{   \MInt_{\alpha}(\xInt)\MExt^*(\xExt)
              - \NInt_{\alpha}(\xInt)\NExt^*(\xExt)
      \right\} 
\\
 \vb C(\vb x, \vb x^\prime)
 &= -ik\sum_{\alpha} 
      \left\{   \MInt_{\alpha}(\xInt)\NExt^*(\xExt) 
              + \NInt_{\alpha}(\xInt)\MExt^*(\xExt)
      \right\} 
\end{align*}
where $\xInt (\xExt)$ denote whichever of $\vb x, \vb x^\prime$
is closer to (further from) the origin.
(My notation and conventions for spherical multipole functions
are summarized in Appendix \ref{SphericalHelmoltzAppendix}; 
briefly, the $\wedge$ adornment means ``interior,'' 
while $\vee$ means ``exterior,'' and the mnemonic is to 
think of $\vee$ as indicating radiation outward to infinity,
as is appropriate for exterior solutions).

Inserting into (\ref{MatrixElementIntegrals}), we have 
%====================================================================%
\begin{align*}
 \big\langle \vb f_a \big| \vb G \big| \vb f_b \big\rangle
&=-ik\sum_{\alpha} 
    \Big\{  \big\langle \vb f_a \big| \MInt_\alpha \big\rangle
            \big\langle \vb \MExt^*_\alpha \big| \vb f_b \big\rangle
           -\big\langle \vb f_a \big| \NInt_\alpha \big\rangle
            \big\langle \vb \NExt^*_\alpha \big| \vb f_b \big\rangle
    \Big\}\\
%--------------------------------------------------------------------%
 \big\langle \vb f_a \big| \vb C \big| \vb f_b \big\rangle
&=-ik\sum_{\alpha} 
    \Big\{  \big\langle \vb f_a \big| \MInt_\alpha \big\rangle
            \big\langle \vb \NExt^*_\alpha \big| \vb f_b \big\rangle
           +\big\langle \vb f_a \big| \NInt_\alpha \big\rangle
            \big\langle \vb \MExt^*_\alpha \big| \vb f_b \big\rangle
    \Big\}
%--------------------------------------------------------------------%
\end{align*}

Now use the translation matrices 
[Appendix \ref{SphericalHelmoltzAppendix}, 
 equation (\ref{TranslationMatrixDefinition})]
to rewrite inner products involving exterior functions in terms
of inner products involving interior functions:
%====================================================================%
\begin{subequations}
\begin{align}
 \big\langle \vb f_a \big| \vb G \big| \vb f_b \big\rangle
&=-ik\sum_{\alpha\beta} 
   \left(\begin{array}{c}
     \mathcal{M}_{a\alpha}  \\ \mathcal{N}_{a\alpha}
   \end{array}\right)^T
   \left(\begin{array}{cc}
   A_{\alpha\beta} & B_{\alpha\beta} \\
   B_{\alpha\beta} & -A_{\alpha\beta}
   \end{array}\right)
   \left(\begin{array}{c}
     \mathcal{M}_{b\alpha}  \\ \mathcal{N}_{b\alpha}
   \end{array}\right)
\\
%--------------------------------------------------------------------%
 \big\langle \vb f_a \big| \vb C \big| \vb f_b \big\rangle
&=-ik\sum_{\alpha\beta} 
   \left(\begin{array}{c}
     \mathcal{M}_{a\alpha}  \\ \mathcal{N}_{a\alpha}
   \end{array}\right)^T
   \left(\begin{array}{cc}
  -B_{\alpha\beta} & A_{\alpha\beta} \\
   A_{\alpha\beta} & B_{\alpha\beta}
   \end{array}\right)
   \left(\begin{array}{c}
     \mathcal{M}_{b\alpha}  \\ \mathcal{N}_{b\alpha}
   \end{array}\right)
\end{align}
\label{SphericalMultipoleMatrixElements}
\end{subequations}
%====================================================================%
where $\{ \mathcal{M}, \mathcal{N}\}$ are the spherical multipole moments
of the RWG basis functions:
\numeq{RWGSphericalMultipoleMoments}
{
   \mathcal{M}_{a\alpha}
   =
   \int_{\sup \vb f_a} \vb f_a(\vb x) \cdot \MInt_\alpha(\vb x)\, d\vb x,
   \qquad
   \mathcal{N}_{a\alpha}
   =
   \int_{\sup \vb f_a} \vb f_a(\vb x) \cdot \NInt_\alpha(\vb x)\, d\vb x.
}
The point of this decomposition is that computing the integrals
(\ref{RWGSphericalMultipoleMoments}) at a given frequency
requires $O(\texttt{NBF})$ numerical cubatures, in contrast to 
the $O(\texttt{NBF}^2)$ numerical cubatures that would na\"ively 
be required to evaluate (\ref{MatrixElementIntegrals}) for 
all pairs of basis functions.

%====================================================================%

\subsection{Matrix elements between nearby basis functions: 
            panel-panel integration method}

When the supports of the basis functions $\vb f_a$ and $\vb f_b$ 
are relatively close to each other, we evaluate each of the 
integrals in (\ref{MatrixElementIntegrals}) as a sum of four
integrals over pairs of triangular panels: 
%====================================================================%
\begin{subequations}
\begin{align}
&\hspace{-0.1in}
 \Big\langle \vb f_a \Big| \vb G(k) \Big | \vb f_b \Big \rangle
\nn
&=
  l_a l_b 
  \sum_{\sigma, \tau=-}^+ 
  \frac{\sigma\tau}{4A^\sigma_a A^\tau_b}
  \int_{\pan_a^\sigma}  d\vb x_a \,
  \int_{\pan_b^\tau}  d\vb x_b \,
   \Big[                 h_{\bullet}(\vb x_a, \vb x_b)
         - \frac{1}{k^2} h_{\nabla}(\vb x_a, \vb x_b)
   \Big]
   \phi\big(k, |\vb x_a - \vb x_b|\big)
\\[5pt]
%--------------------------------------------------------------------%
&\hspace{-0.1in}
 \Big\langle \vb f_a \Big| \vb C(k) \Big | \vb f_b \Big \rangle
\nn
&=
  \frac{l_a l_b}{ik}
  \sum_{\sigma, \tau=-}^+ 
  \frac{\sigma \tau}{4A^\sigma_a A^\tau_b}
  \int_{\pan_a^\sigma}  d\vb x_a \,
  \int_{\pan_b^\tau}  d\vb x_b \,
   h_{\times}(\vb x_a, \vb x_b)
   \psi\big(k, |\vb x_a - \vb x_b|\big)
\end{align}
\label{PanelPanelIntegrals}
\end{subequations}
%====================================================================%
where\footnote{\textit{Warning:} My notation for the $h$ functions
hides the fact that $h_\bullet$ and $h_\times$ depend on the current 
source/sink nodes $\vb Q_{ab}^\pm$ within the two triangles.}
%====================================================================%
\begin{align*}
h_{\bullet}(\vb x_a, \vb x_b)
&= (\vb x_a - \vb Q_a) \cdot (\vb x_b - \vb Q_b) 
\\
%--------------------------------------------------------------------%
h_{\nabla}(\vb x_a, \vb x_b)
&= 4
\\
%--------------------------------------------------------------------%
h_{\times}(\vb x_a, \vb x_b)
&=
\Big[ (\vb x_a - \vb Q_a) \times (\vb x_b - \vb Q_b) \Big]
      \cdot (\vb x_a - \vb x_b)
\\
&=
      (\vb x_a \times \vb x_b) \cdot (\vb Q_a - \vb Q_b)
    + (\vb Q_a \times \vb Q_b) \cdot (\vb x_a - \vb x_b)
\\
%--------------------------------------------------------------------%
\phi(k, r)&=\frac{e^{ikr}}{4\pi r}, 
\\
%--------------------------------------------------------------------%
\psi(k, r)&=(ikr-1)\frac{e^{ikr}}{4\pi r^3}.
\end{align*}
%====================================================================%
[Note that $\psi$ is defined such that 
$\nabla \phi(k, |\vb r|) = \vb r \psi(k, |\vb r|)$].
%====================================================================%

The point of this notation is that it expresses the 
integrands of the panel-panel integrals in (\ref{PanelPanelIntegrals}) 
as products of benign polynomials in $\vb x_a, \vb x_b$
(the $h$ functions) times kernel functions that depend only 
on the distance $\vb x_a-\vb x_b$ and have singularities 
when this distance vanishes (the $\phi, \psi$ kernels).
This decomposition facilitates the desingularization procedure
described below.

In some cases I will write (\ref{PanelPanelIntegrals}) 
using the notation
\begin{subequations}
\begin{align}
 \Big\langle \vb f_a \Big| \vb G(k) \Big | \vb f_b \Big \rangle
&=
  l_a l_b 
  \sum_{\sigma, \tau=-}^+ 
  \sigma\tau
  \left\{               \texttt{PPI}\Big(\pan_a^\sigma, \pan_b^\tau, h_\bullet, \phi\Big) 
         -\frac{1}{k^2} \texttt{PPI}\Big(\pan_a^\sigma, \pan_b^\tau, h_\nabla,  \phi\Big) 
  \right\}
\\
%--------------------------------------------------------------------%
 \Big\langle \vb f_a \Big| \vb C(k) \Big | \vb f_b \Big \rangle
&=
  \frac{l_a l_b }{ik}
  \sum_{\sigma, \tau=-}^+ \sigma \tau \cdot 
   \texttt{PPI}\Big(\pan_a^\sigma, \pan_b^\tau, h_\times, \psi\Big) 
\end{align}
\label{PPIs}
\end{subequations}
with the ``panel-panel integral'' functions defined by 
\numeq{PPIDefinition}
{
   \texttt{PPI}\Big(\pan, \pan^\prime, h, g\Big)
   \equiv 
   \frac{1}{4A A^\prime}
   \int_{\pan} d\vb x \, 
   \int_{\pan^\prime} d\vb x^\prime \, 
   h(\vb x, \vb x^\prime) \, g(|\vb x-\vb x^\prime|).
}
%Sometimes I will use the alternative notation
%$$
%   H_{\bullet, \nabla, \times} \Big(\pan_a, \pan_b, g\Big)
%   \equiv 
%   \int_{\pan_a} d\vb x_a \, 
%   \int_{\pan_b} d\vb x_b \, 
%   h_{\bullet, \nabla, \times}(\vb x_a, \vb x_b) \, 
%   g(|\vb x_a-\vb x_b|)
%$$
%as well as 
%$$ H_{+}\Big(\pan_a, \pan_b, g\Big) \equiv 
%   H_{\bullet}\Big(\pan_a, \pan_b, g\Big)
%   -\frac{1}{k^2} H_{\nabla }\Big(\pan_a, \pan_b, g\Big).
%$$
The quantities (\ref{PPIDefinition}) are what are computed 
by the \texttt{GetPanelPanelInteractions()} routine in \ls. 
The responsibility of assembling these quantities together with
the requisite prefactors to obtain the full inner products
(\ref{PPIs}) is handled by the routine 
\texttt{GetEdgeEdgeInteractions()}.

\subsubsection*{Evaluation of distant panel-panel integrals: Cubature}

When the panels $\pan, \pan^\prime$ in 
(\ref{PPIDefinition}) are relative far away from each other, we
evaluate the four-dimensional integral using numerical cubature.
For this purpose it is convenient to parameterize points in the
triangles using the prescription (Figure \ref{uvDefinitionFigure})
\numeq{uvDefinition}
{\begin{array}{cclll}
 \vb x &=&\vb V_1 + u\vb A + v\vb B, 
 \qquad &0\le u \le 1, 
 \qquad &0 \le v \le u 
\\[5pt]
 \vb x^\prime &=& \vb V_1^\prime 
                 + u^\prime\vb A^\prime 
                 + v^\prime\vb B^\prime
 \qquad &0\le u^\prime \le 1, 
 \qquad &0 \le v^\prime \le u^\prime.
 \end{array}
}
The integral (\ref{PPIDefinition}) becomes 
\numeq{uvIntegral}
{
   \texttt{PPI}\Big(\pan, \pan^\prime, h, g\Big)
   =
   \int_0^1 du \, \int_0^u dv \, 
   \int_0^1 du^\prime \, \int_0^{u^\prime} dv^\prime \, 
   h(u, v, u^\prime, v^\prime)
   g(u, v, u^\prime, v^\prime)
}
where the prefactor $\frac{1}{4AA^\prime}$ is cancelled
by the Jacobian of the variable transformation (\ref{uvDefinition}),
and where I put
$$ h(u,v,u^\prime,v^\prime) = 
   h\Big( \vb x(u,v), \vb x^\prime(u^\prime,v^\prime) \Big), 
   \qquad
   g(u,v,u^\prime,v^\prime) = 
   g\Big( \big|\vb x(u,v) - \vb x^\prime(u^\prime,v^\prime) \big|\Big).
$$
The integral (\ref{uvIntegral}) may be evaluated numerically in 
one of two ways:
\begin{enumerate}
 \item by nesting two cubature rules for the standard triangle 
       with vertices $\{(0,0), (0,1), (1,0)\}$, or
 \item by mapping the domain of integration to the four-dimensional 
       hypercube $[0,1] \times [0,1] \times [0,1] \times [0,1]$
       and using a four-dimensional cubature rule for this hypercube.
       (The variable transformation that enables this mapping is
       $$v=ut, \qquad dv=udt, \qquad \int_0^u f(v) dv = \int_0^1 u f(ut) dt$$
       and similarly $v^\prime=u^\prime t^\prime.$)
\end{enumerate}
The former of these two strategies is slightly more efficient, but
the latter has the advantage of allowing the use of standard codes
for adaptive cubature over 
hypercubes.\footnote{\texttt{http://ab-initio.mit.edu/cubature}}
Both strategies are used in \ls.

\subsubsection*{Evaluation of nearby panel-panel integrals: Desingularization}

When the panels in (\ref{PPIDefinition}) have one or more common
vertices, the integrand becomes singular at one or more points in 
the domain of integration. Although these are \textit{integrable}
singularities, their existence precludes application of the na\"ive
numerical cubature scheme discussed above, and instead we must
resort to more complicated, and more costly, numerical methods.

On the other hand, when the panels have no common vertices but are
nearby one another, the integrand in (\ref{PPIDefinition}) is
nonsingular but rapidly varying over the domain of integration, 
and evaluation of the integral by numerical cubature is technically 
possible but expensive due to the large number of cubature points 
required to obtain decent accuracy.

%====================================================================%
\begin{subequations}
\begin{align}
 \iint h \phi
&=
 \iint h \phi\supt{DS}
+\sum_{n=0}^3 \frac{(ik)^n}{4\pi} A_n  
 \iint h r^{n-1}
\\
%--------------------------------------------------------------------%
 \iint h\psi
&=
 \iint h\psi\supt{DS}
+\sum_{n=0}^4 \frac{(ik)^n}{4\pi} B_n 
 \iint h r^{n-3}
\end{align}
\label{DesingularizedPPIs}
\end{subequations}
%====================================================================%
Here we are using a shorthand in which 
\begin{itemize}
 \item $h$ is any of the functions $\{h_\bullet, h_\nabla, h_\times\}$,
 \item $\iint$ is shorthand for 
       $\int_{\pan_a} \, d\vb x_a \, \int_{\pan_b} \, d\vb x_b, $
 \item $\iint h r^p$ is shorthand for 
       $\int_{\pan_a} \, d\vb x_a \, \int_{\pan_b} \, d\vb x_b\,
        \big\{h(\vb x_a, \vb x_b) |\vb x_a - \vb x_b|^p\big\},$
 \item the $A$ coefficients in (\ref{DesingularizedPPIs}a) are 
       $$A_n=\frac{1}{n!}$$
 \item the $B$ coefficients in (\ref{DesingularizedPPIs}b) are 
       $$ B_0 = -1, \qquad B_1 = 0, \qquad B_2 = \frac{1}{2}, \qquad
          B_3 = \frac{1}{3}, \qquad B_4 = \frac{1}{6}
       $$
 \item the desingularized kernels are 
\begin{subequations}
\begin{align}
\phi\supt{DS}(k, r) 
 &=
\frac{e^{ikr} - 1 - ikr - \frac{1}{2}(ikr)^2 - \frac{1}{6}(ikr)^3 }
     {4\pi r}, 
\nonumber \\
&\equiv\frac{\texttt{ExpRel}(ikr, 4)}{4\pi r}
\\
\intertext{and similarly}
%--------------------------------------------------------------------%
\psi\supt{DS}(k, r)&\equiv(ikr-1)\frac{\texttt{ExpRel}(ikr, 4)}{4\pi r^3}.
\end{align}
\label{PhiDSPsiDS}
\end{subequations}
%====================================================================%
\end{itemize}
When computing the ``relative exponential'' functions 
$\texttt{ExpRel}(x,n)$ in (\ref{PhiDSPsiDS}) it is 
important that we \textit{not} simply compute 
$\texttt{exp(x)}$ and then subtract off the first $n$ terms
in its Taylor series, as doing so could lead to catastrophic loss
of numerical precision. Instead, a better-behaved procedure is 
simply to sum the Taylor series for the exponential starting 
with its $(n+1)$th term.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newpage
\section{Evaluation of Frequency-Independent Panel-Panel Integrals}

The frequency-independent panel-panel integrals (FIPPIs) are
\numeq{FIPPIs}
{ \iint h_\bullet r^p,
  \qquad
  \iint h_\nabla r^p,
  \qquad
  \iint h_\times r^p
}
where $\iint$ denotes the four-dimensional integration over
the pair of triangles as in the previous section.

%The general strategy pursued by \lss is to evaluate the
%FIPPIs once for each pair of panels and then store and 
%reuse the results as often as possible. 

\subsubsection*{Evaluation of $\iint h_\bullet r^p$}

In terms of the $u,v,u^\prime,v^\prime$ variables of equation
(\ref{uvDefinition}), we have
\numeq{HBulletUVUPVP}
{ h_{\bullet}(u,v,u^\prime,v^\prime)
=\Big[ \big( \vb V_1-\vb Q\big) + u \vb A + v\vb B\Big]\cdot  
  \Big[ \big( \vb V_1^\prime-\vb Q^\prime\big) + u^\prime \vb A^\prime 
        + v^\prime\vb B^\prime\Big]
}
and 
$$
r(u,v,u^\prime,v^\prime)
 =\Big| \vb V_1 - \vb V_1^\prime
       + u\vb A+ v\vb B - u^\prime\vb A^\prime - v^\prime\vb B^\prime
  \Big|.
$$
Expanding the product (\ref{HBulletUVUPVP}) yields a sum of nine terms:
\begin{align}
\iint h_{\bullet} r^p 
 = \big (\vb V_1-\vb Q\big ) \cdot 
         \big (\vb V_1^\prime - \vb Q^\prime\big)
   \cdot &\iint r^p
\nn
 +\vb A \cdot \big (\vb V_1^\prime -\vb Q^\prime\big )
  &\iint u r^p
\nn
 +\vb B \cdot \big (\vb V_1^\prime -\vb Q^\prime\big )
  &\iint v r^p
\nn
  +  &\cdots
\nn
 +\vb B \cdot \vb B^\prime
  &\iint v v^\prime r^p. \label{HBulletExpansion}
\end{align}
%====================================================================%
It is important to notice that the integrals in (\ref{HBulletExpansion}) 
are independent of $\vb Q$ and $\vb Q^\prime$. This suggests that, to
compute $\iint h_\bullet r^p$,  I first compute the quantities
\numeq{QIFIPPIs}
{
   \iint \left\{ \begin{array}{c} 
   1 \\ u \\ v \\ u^\prime \\ uu^\prime \\ vu^\prime \\
   v^\prime \\ uv^\prime \\ vv^\prime
   \end{array}\right\} r^p
}
and then use (\ref{HBulletExpansion}) to compute $\iint h_\bullet r^p$.
The point of this step is that the quantities (\ref{QIFIPPIs}) need 
only be evaluated and stored once for each pair of panels, after which 
the results may be used in (\ref{HBulletExpansion}) to compute the 
nine separate quantities $\iint h_\bullet r^p$ that result 
different choices of the current source/sink vertices 
$\vb Q, \vb Q^\prime$.

The integrals (\ref{HBulletExpansion}) are 
known in \lss as the ``$\vb Q$-independent FIPPIs,''
while (\ref{FIPPIs}) are the ``$\vb Q$-dependent FIPPIs.''

\subsubsection*{Evaluation of $\iint h_\nabla r^p$}

Once we have evaluated the $\vb Q$-independent FIPPIs
for a pair of panels, we get $\iint h_\nabla r^p$ for 
free, since it is just the first entry in 
equation (\ref{QIFIPPIs}) times 4.

\subsubsection*{Evaluation of $\iint h_\times r^p$}

For $p>-3$, I proceed in analogy to equation (\ref{HBulletExpansion})
by writing $h_\times$ as a sum of nine terms,
$$ h_\times 
   = 
   \sum_{abcd} u^a v^b u^{\prime c} v^{\prime d} h_\times^{abcd},
$$
whereupon $\iint h_\times r^p$ may be reconstructed from 
the QIFIPPIs (\ref{QIFIPPIs}) according to
\numeq{HTimesRP}
{
 \iint h_\times r^p 
   = 
   \sum_{abcd} h_\times^{abcd} 
               \iint \Big[u^a v^b u^{\prime c} v^{\prime d}\Big] r^p.
}
The nonzero values of $h_\times^{abcd}$ are
%--------------------------------------------------------------------%
\begin{align*} 
h_\times^{0000} 
&=  (\vb Q_a\times \vb Q_b) \cdot (\vb V_0 - \vb V_0^\prime)
   +(\vb Q_a   -   \vb Q_b) \cdot (\vb V_0 \times\vb V_0^\prime) 
\\ 
%--------------------------------------------------------------------%
h_\times^{1000} 
&=   (\vb Q_a\times \vb Q_b) \cdot \vb A 
   + (\vb Q_a   -   \vb Q_b) \cdot (\vb A \times \vb V_0^\prime) 
\\
%--------------------------------------------------------------------%
h_\times^{0100} 
&= 
   (\vb Q_a\times \vb Q_b) \cdot \vb B 
  +(\vb Q_a   -   \vb Q_b) \cdot (\vb B \times \vb V_0^\prime) 
\\ 
%--------------------------------------------------------------------%
h_\times^{0010} 
&= -(\vb Q_a\times \vb Q_b) \cdot \vb A^\prime 
   +(\vb Q_a   -   \vb Q_b) \cdot (\vb V_0 \times \vb A^\prime) 
\\ 
%--------------------------------------------------------------------%
h_\times^{0001} 
&=  -(\vb Q_a\times \vb Q_b) \cdot \vb B^\prime 
    +(\vb Q_a   -   \vb Q_b) \cdot (\vb V_0 \times \vb B^\prime) 
\\ 
%--------------------------------------------------------------------%
h_\times^{1010} 
&=   (\vb Q_a   -   \vb Q_b) \cdot (\vb A \times \vb A^\prime)
\\
%--------------------------------------------------------------------%
h_\times^{1001}
&=   (\vb Q_a   -   \vb Q_b) \cdot (\vb A \times \vb B^\prime)
\\
%--------------------------------------------------------------------%
 h_\times^{0110}
&=   (\vb Q_a   -   \vb Q_b) \cdot (\vb B \times \vb A^\prime)
\\
%--------------------------------------------------------------------%
 h_\times^{0101}
&=   (\vb Q_a   -   \vb Q_b) \cdot (\vb B \times \vb B^\prime).
\end{align*}
%--------------------------------------------------------------------%
%
For the particular case $p=-3$, the above procedure is ill-behaved,
and instead I write
\numeq{HTimesRM3}
{
   \iint h_\times r^{-3}=
   (\vb Q_a \times \vb Q_b) 
   \cdot 
   \iint (\vb x_a - \vb x_b) r^{-3} 
   +
   (\vb Q_a -\vb Q_b) 
   \cdot 
   \iint (\vb x_a \times \vb x_b) r^{-3}
}
where now
\numeq{QIFIPPIsSupplement}
{
   \iint (\vb x_a-\vb x_b)r^{-3}, \qquad
    \iint (\vb x_a \times \vb x_b)r^{-3}
}
are to be included among the list of $\vb Q-$independent 
FIPPIs that must be calculated for each panel pair.

On first glance, it might seem that equations
(\ref{QIFIPPIs}) and (\ref{QIFIPPIsSupplement})
are redundant, since knowing the former should allow
reconstruction of the latter. This appearance is 
deceptive, because for panel pairs with common vertices 
some of the individual FIPPIs (\ref{QIFIPPIs}) are 
divergent for $p=-3$, while (\ref{QIFIPPIsSupplement}) 
are convergent. [For panel pairs with no common
vertices, the integrals (\ref{QIFIPPIs}) are convergent
but much more expensive to calculate than 
(\ref{QIFIPPIsSupplement}).] Of course, for $p=-3$
the $\vb Q-$independent FIPPIs defined by 
(\ref{QIFIPPIsSupplement}) are the only ones we 
\textit{need} 
(because for $p=-3$ the only $\vb Q$-dependent FIPPI 
we need is $\iint h_\times r^{p}$), while 
for $p>-3$ equation (\ref{QIFIPPIsSupplement}) 
does not suffice and we need instead the full
set (\ref{QIFIPPIs}). Thus a reasonable 
compromise seems to be to compute only 
(\ref{QIFIPPIsSupplement}) for the case $p=-3$, 
and to compute the full set (\ref{QIFIPPIs}) for
$p>-3$.

\subsubsection*{Evaluation of $\vb Q$-independent FIPPIs}

The $\vb Q$-independent FIPPIs, equation (\ref{QIFIPPIs}),
are nominally four-dimensional integrals, but we have the 
following simplifications:

\begin{enumerate}
  \item For $p=0$ the integral may be done analytically
        in closed form. (Actually, the same is true for $p=2$,
        but the result is too cumbersome to be useful.)
  \item If the panels have one or more common vertices, we may use
        the Taylor-Duffy method (Appendix \ref{TaylorDuffyAppendix})
        to perform one or more of the four integrals analytically.
  \item Even when the panels have no common vertices, we can 
        always evaluate one of the four integrals analytically,
        which accelerates numerical evaluation.
\end{enumerate}

We now address each of these points in turn. 

\paragraph{1. FIPPIs for $p=0$.} 

In this case all the FIPPIs are linear combinations of the 
basic integral
$$ \iint u^a v^b (u^\prime)^c (v^\prime)^d 
   = 
   \frac{1}{(2+a+b)(1+b)(2+c+d)(1+d)}.
$$
We have
$$
   \iint \left\{ \begin{array}{c} 
   1 \\ u \\ v \\ u^\prime \\ uu^\prime \\ vu^\prime \\
   v^\prime \\ uv^\prime \\ vv^\prime
   \end{array}\right\} r^0
   =
   \left\{ \begin{array}{c} 
           1/4 \\ 1/6 \\ 1/12 \\ 
           1/6 \\ 1/9 \\ 1/18 \\ 
           1/12 \\ 1/18 \\ 1/36
           \end{array}
   \right\}.
$$

\paragraph{2. FIPPIs for panels with common vertices.} 

As noted above, for panels with common vertices the Taylor-Duffy
method of Appendix (\ref{TaylorDuffyAppendix}) is available.

\paragraph{3. FIPPIs for panels with no common vertices.} 

As noted above, even when the panels have no common vertices
we can always evaluate one of the four integrals 
analytically to yield a three-dimensional integral.
We arbitrarily choose the integral we evaluate to be
the $v^\prime$ integral, and to facilitate its evaluation we 
write
\begin{align*}
r(u,v,u^\prime,v^\prime)
&=\Big| \vb V_1 - \vb V_1^\prime
       + u\vb A + v\vb B - u^\prime\vb A^\prime - v^\prime\vb B^\prime
  \Big|   
\\
&=a \sqrt{ (v^\prime + v_0^\prime)^2 + b^2 },
\end{align*}
%====================================================================%
$$
a = |\vb B^\prime|, 
\qquad
v_0^\prime = -\frac{1}{a^2} \vb B^\prime \cdot \vb Y,
\qquad
b^2=\frac{1}{a^2}|\vb Y|^2 - v_0^{\prime 2},
$$
$$
\vb Y=    \vb V_1 - \vb V_1^\prime  
       + u\vb A+ v\vb B - u^\prime\vb A^\prime.
$$
%====================================================================%
The integrals we need are now
%====================================================================%
\begin{subequations}
\begin{align}
 \int_{v_0^\prime}^{v_0^\prime + u^\prime} 
  \left\{ \begin{array}{c}  1 \\ v^\prime \end{array} \right\}
  \Big[v^{\prime 2} + b^2\Big]^{-3/2}d v^\prime
&= \frac{1}{a^3} 
   \left\{ \begin{array}{c}
    \frac{(u^\prime + v_0^\prime)}{b^2 S_2} - \frac{v_0^\prime}{b^2 S_1} 
    \\[5pt]
    \frac{1}{S_1} - \frac{1}{S_2}
   \end{array}\right\}
\\[5pt]
%--------------------------------------------------------------------%
 \int_{v_0^\prime}^{v_0^\prime + u^\prime} 
  \left\{ \begin{array}{c}  1 \\ v^\prime \end{array} \right\}
  \Big[v^{\prime 2} + b^2\Big]^{-1/2}d v^\prime
&= \frac{1}{a} 
   \left\{ \begin{array}{c}
    \log \frac{ S_2 + (u^\prime+v_0^\prime) }
              { S_1 + v_0^\prime }
    \\[5pt]
    S_2 - S_1
   \end{array}\right\}
\\[8pt]
%--------------------------------------------------------------------%
 \int_{v_0^\prime}^{v_0^\prime + u^\prime} 
  \left\{ \begin{array}{c}  1 \\ v^\prime \end{array} \right\}
  \Big[v^{\prime 2} + b^2\Big]^{1/2} d v^\prime
&= a
   \left\{ \begin{array}{c}
   \frac{b^2}{2} \log \frac{ S_2 + (u^\prime+v_0^\prime) }
                           { S_1 + v_0^\prime }
   +\frac{1}{2}\big[(u^\prime + v_0^\prime)S_2 - v_0^\prime S_1\big]
   \\[5pt]
   \frac{1}{3}(S_2^3 - S_1^3)
   \end{array}\right\}
\\[8pt]
%--------------------------------------------------------------------%
 \int_{v_0^\prime}^{v_0^\prime + u^\prime} 
  \left\{ \begin{array}{c}  1 \\ v^\prime \end{array} \right\}
  \Big[v^{\prime 2} + b^2\Big]d v^\prime
&= a^2
   \left\{ \begin{array}{c}
    \\[5pt]
   \end{array}\right\}
\end{align}
\label{vPrimeIntegrals}
\end{subequations}
$$ S_1\equiv\sqrt{b^2 + v_0^{\prime 2}}, 
   \qquad
   S_2\equiv\sqrt{b + (v_0^{\prime} + u^\prime)^2}, \qquad
$$
%====================================================================%
To make use of these results in evaluating the FIPPIs 
(\ref{QIFIPPIs}), we eliminate the $v^\prime$ integrals
and replace all factors of $\{1, v^\prime\}$ with
their counterparts on the RHS of (\ref{vPrimeIntegrals}),
leaving behind three-dimensional integrals that succumb
readily to numerical cubature.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newpage
\section{Derivatives of Matrix Elements}

For Casimir computations we need derivatives of matrix elements
with respect to rigid displacements and rotations of basis functions.

\subsection{Derivatives by Spherical-Multipole Method}

\subsection{Derivatives by Panel-Panel Integral Method}

We write the panel-panel decomposition of the RWG inner products,
equation (\ref{PPIs}), in the form
%====================================================================%
\begin{subequations}
\begin{align}
 \Big\langle \vb f_a \Big| \vb G(k) \Big | \vb f_b \Big \rangle
&= l_a l_b \sum_{\sigma, \tau=-}^+
   \sigma \tau
   \left\{ H_\bullet(\pan_a^\sigma, \pan_b^\sigma, \vb R) 
           -\frac{1}{k^2} H_\nabla(\pan_a^\sigma, \pan_b^\sigma, \vb R) 
   \right\}
\\
 \Big\langle \vb f_a \Big| \vb C(k) \Big | \vb f_b \Big \rangle
&= 
   \frac{l_a l_b }{ik}
   \sum_{\sigma, \tau=-}^+
   \sigma \tau \cdot 
   H_\times(\pan_a^\sigma, \pan_b^\sigma, \vb R) 
\end{align}
\end{subequations}
%====================================================================%
where
%====================================================================%
\begin{subequations}
\begin{align}
 H_\bullet(\pan_a, \pan_b, \vb R) 
   &=\frac{1}{4A_a A_b} 
     \int_{\pan_a} d\vb y_a \, \int_{\pan_b} d\vb y_b \,
     h_\bullet(\vb y_a, \vb y_b)
     \phi\big(k, \vb R + \vb y_{a} - \vb y_{b} \big) 
\\
 H_\nabla(\pan_a, \pan_b, \vb R) 
   &=\frac{1}{4A_a A_b} 
     \int_{\pan_a} d\vb y_a \, \int_{\pan_b} d\vb y_b \,
     h_\nabla(\vb y_a, \vb y_b)
     \phi\big(k, \vb R + \vb y_{a} - \vb y_{b} \big) 
\\
 H_\times(\pan_a, \pan_b, \vb R)
   &=\frac{1}{4A_a A_b}
     \int_{\pan_a} d\vb y_a \, \int_{\pan_b} d\vb y_b \,
     h_\times(\vb y_a, \vb y_b, \vb R)
     \psi\big(k, \vb R + \vb y_{a} - \vb y_{b} \big). 
\end{align}
\label{ThreeHFunctions}
\end{subequations}
%====================================================================%
Here we have rewritten the integrals over $\vb x_a, \vb x_b$ in 
equation (\ref{PanelPanelIntegrals}) using new integration variables
defined relative to the panel centroids (Figure \ref{RabFigure}):
%====================================================================%
\numeq{Rab}
{
  \vb x_a=\vb x_{a0} + \vb y_a, 
   \qquad 
   \vb x_b=\vb x_{b0} + \vb y_b, 
   \qquad
   \vb R_{ab} \equiv \vb R = \vb x_{a0} - \vb x_{b0}.
}
%====================================================================%
%####################################################################%
\begin{figure}
\begin{center}
\includegraphics{figures/PPIDerivatives.pdf}
\caption{Notation for equation \ref{Rab}.}
\label{RabFigure}
\end{center}
\end{figure}
%####################################################################%
(In equation (\ref{ThreeHFunctions}), note that $h_\times$, 
unlike $h_\bullet$ and $h_\nabla$, depends on $\vb R$ in 
addition to $\vb y_a, \vb y_b$.)

Now we can take derivatives with respect to the components 
of $\vb R$. Putting $\vb r = \vb R + \vb y_a - \vb y_b)$, we have
\begin{align*}
  \pard{H_\bullet}{\vb R_i}
&= \int d\vb y_a \, \int d\vb y_b \,
   \vb r_i 
   h_\bullet(\vb y_a, \vb y_b)
   \psi\big(k, \vb R + \vb y_a - \vb y_b \big) 
\\
  \pard{H_\nabla}{\vb R_i}
&= \int d\vb y_a \, \int d\vb y_b \,
   \vb r_i 
   h_\nabla(\vb y_a, \vb y_b)
   \psi\big(k, \vb R + \vb y_a - \vb y_b \big)
\\
  \pard{H_\times}{\vb R_i}
&= 
   \int d\vb y_a \, \int d\vb y_b \,
   \vb r_i
   h_\times(\vb y_a, \vb y_b, \vb R)
   \zeta\big(k, \vb R + \vb y_a - \vb y_b \big)
\\
&\qquad + 
   \int d\vb y_a \, \int d\vb y_b \,
   \pard{h_\times(\vb y_a, \vb y_b, \vb R)}{\vb R_i}
   \psi\big(k, \vb R + \vb y_a - \vb y_b \big)
\end{align*}
In the last line, we put
$$ \zeta(k, r) = \Big[ (ikr)^2 -3ikr + 3\Big]\frac{e^{ikr}}{4\pi r^5}$$
[which is defined such that $\nabla \psi(k,|\vb r|) = \vb r \zeta(k, |\vb r|)$]
and we have 
\begin{align*}
 \pard{ h_\times(\vb y_a, \vb y_b, \vb R)}{\vb R_i}
&=\pard{}{\vb R_i} 
   \bigg\{ \Big[ (\vb y_a - \vb Q_a) \times (\vb y_b - \vb Q_b) \Big]
           \cdot \vb R 
   \bigg\}
\\
&= \Big[ (\vb y_a - \vb Q_a) \times (\vb y_b - \vb Q_b) \Big]_i.
\end{align*}

\subsubsection*{Desingularization}

%====================================================================%
\begin{align*}
  \pard{H_\bullet}{\vb R_i}
&= \iint \vb r_i \vb h_\bullet \psi
\\
&= \iint \vb r_i h_{\bullet} \psi\supt{DS}
   +\sum_{n=0}^4 \frac{(ik)^n}{4\pi} B_n 
    \iint \vb r_i h_{\bullet} r^{n-3}
\\[10pt]
%--------------------------------------------------------------------%
  \pard{H_\nabla}{\vb R_i}
&= \iint \vb r_i h_\nabla \psi  
\\
&= \left[ \iint \vb r_i h_{\nabla} \psi\supt{DS}
                 +\sum_{n=0}^4 \frac{(ik)^n}{4\pi} B_n 
                  \iint \vb r_i h_{\nabla } r^{n-3}
           \right]
\\[10pt]
%--------------------------------------------------------------------%
  \pard{H_\times}{\vb R_i}
&=   \iint \vb r_i h_\times \zeta
   + \iint \left( \pard{h_\times}{\vb R_i}\right) \psi
\\
%--------------------------------------------------------------------%
&= \iint \vb r_i h_{\times} \zeta\supt{DS}
    +\iint \left(\pard{h_\times}{\vb R_i}\right)\psi\supt{DS}   
\\ 
&\qquad
   +\left[ \sum_{n=0}^5 \frac{(ik)^n}{4\pi} C_n 
                   \iint \vb r_i h_{\times } r^{n-5}
            \right]
   + \left[ \sum_{n=0}^4 \frac{(ik)^n}{4\pi} B_n 
            \iint \left( \pard{h_{\times}}{\vb R_i}\right) r^{n-3}
     \right]
\end{align*}
%====================================================================%
In the last line here we used
$$ \zeta\supt{DS}(k, r) = 
   \Big[ (ikr)^2 -3ikr + 3\Big]\frac{\texttt{ExpRel(ikr,4)}}{4\pi r^5} 
$$
and the $C_n$ coefficients are 
$$ C_0=3, \qquad C_1=0, \qquad C_2=-\frac{1}{2}, 
   \qquad C_3=C_4=0, \qquad C_5=\frac{1}{6}.
$$

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newpage
\section{Other Panel Integrals}
\begin{figure}
\resizebox{\textwidth}{!}{\includegraphics{OverlapIntegrals.pdf}}
\caption{Notation for computation of overlap integrals.}
\label{OverlapIntegralFigure}
\end{figure}

\subsection{Overlap Integral}

The overlap integral between two RWG basis functions is 
$$ O_{\alpha\beta}=
\Big<\vb f_\alpha \Big | \vb f_\beta\Big > 
=\int_{\text{\scriptsize sup }\vb f_\alpha\, \cap \,
        \text{\scriptsize sup }\vb f_\beta } 
  \vb f_\alpha(\vb x) \cdot \ \vb f_\beta(\vb x)
   \,d\vb x.
$$
If we think of $O_{\alpha\beta}$ as the $\alpha,\beta$ element of 
a matrix $\vb O$, then $\vb O$ is a very sparse matrix, with
at most 5 nonzero entries per row. Fix an interior edge 
$\vb L_\alpha$ in a triangular surface mesh and consider the 
basis function $\vb f_\alpha$ associated with this edge.
The only basis functions to have nonvanishing overlap with 
$\vb f_\alpha$ are \textbf{(1)} $\vb f_\alpha$ itself, and 
\textbf{(2)} basis functions associated with the four 
edges beside $\vb L_\alpha$ on the two panels that 
share $\vb L_\alpha$, such as $\vb L_\beta$ in Figure 
\ref{OverlapIntegralFigure}\textbf{(a)}.

\paragraph{The case $\alpha\ne \beta$.} 

Consider first the case of inequal basis functions
$\vb f_\alpha,\vb f_\beta$ that share a single
panel $\mathcal{P}$ [Figure \ref{OverlapIntegralFigure}\textbf{(a)}].
We parameterize points within $\mathcal{P}$ 
according to 
$$ \vb x=\vb Q_\alpha + u\vb L_\beta + v\vb L_\alpha, 
   \qquad 0\le u \le 1, \quad 0 \le v \le u.
$$
On $\mathcal{P}$, the two basis functions may be expressed in 
terms of this parameterization as 
\begin{align*} 
 \vb f_\alpha(\vb x) 
&= 
 \frac{\sigma^\alpha l_\alpha}{2A}
 \Big[u\vb L_\beta + v\vb L_\alpha\Big] 
\\
 \vb f_\beta(\vb x) 
&= \frac{\sigma^\beta l_\beta}{2A}
  \Big[ u\vb L_\beta + v\vb L_\alpha + (\vb Q_\alpha - \vb Q_\beta)\Big]
\\
&= \frac{\sigma^\beta l_\beta}{2A}
  \Big[ (u-1)\vb L_\beta + (v-1)\vb L_\alpha\Big]
\end{align*} 
Here $A$ is the area of $\mathcal{P}$ and $\sigma^\alpha = \pm 1$  
according as $\mathcal{P}$ is the positive or negative panel
associated with basis function $\vb f_\alpha$ (and similarly 
for $\sigma^{\beta}$), and we used the fact that 
$\vb Q_\alpha + \vb L_\beta + \vb L_\alpha = \vb Q_\beta.$

The overlap integral is 
\begin{align}
O_{\alpha\beta}
&=\int_{\mathcal{P}} \vb f_\alpha(\vb x) \cdot \vb f_\beta(\vb x)  \, d\vb x 
\nn
&=\frac{\sigma^\alpha \sigma^\beta l_\alpha l_\beta}{2A} 
  \int_0^1 \, du \, \int_0^u \, dv \, 
  \Big[ u \vb L_\beta + v\vb L_\alpha\Big]
 \cdot
  \Big[ (u-1) \vb L_\beta + (v-1)\vb L_\alpha\Big]
\nn
&=-\frac{\sigma^\alpha \sigma^\beta l_\alpha l_\beta}{24A} 
  \Big[ l_\alpha^2 + l_\beta^2 + 3\vb L_\alpha\cdot \vb L_\beta\Big]
\label{OAlphaBeta}
\end{align}

\paragraph{The case $\alpha=\beta$.}

In this case there are two panels that contribute
[Figure \ref{OverlapIntegralFigure}\textbf{(b)}].
The contribution of $\mathcal{P}$ is
\begin{align*}
\int_{\mathcal{P}} \vb f_\alpha(\vb x) \cdot \vb f_\alpha(\vb x)  \, d\vb x 
&=\frac{l_\alpha^2}{2A} 
  \int_0^1 \, du \, \int_0^u \, dv \, 
  \Big[ u \vb L_\beta + v\vb L_\alpha\Big]
 \cdot
  \Big[ u \vb L_\beta + v\vb L_\alpha\Big]
\\
&=\frac{l^2_\alpha}{24A} 
  \Big[ 3l_\alpha^2 + l_\beta^2 + 3\vb L_\alpha\cdot \vb L_\beta\Big].
\end{align*}
Adding the contribution of $\mathcal{P}^\prime$, 
the total overlap integral is 
\numeq{OAlphaAlpha}
{
O_{\alpha\alpha}
=\frac{l^2_\alpha}{24}
 \bigg\{ 
   \frac{1}{A}        \Big[ l_\alpha^2 + 3l_\beta^2 + 3\vb L_\alpha\cdot \vb L_\beta\Big]
 + \frac{1}{A^\prime} \Big[ l_\alpha^2 + 3l_\beta^{\prime 2} 
                            + 3\vb L_\alpha\cdot \vb L_\beta^\prime\Big]
 \bigg\}.
}

\subsection{Crossed Overlap Integral}

The crossed overlap integral between two RWG basis functions is 
$$ O^{\times}_{\alpha\beta}=
\Big<\vb f_\alpha \Big | \vbhat{n}\times \vb f_\beta\Big > 
=\int_{\text{\scriptsize sup }\vb f_\alpha\, \cap \,
        \text{\scriptsize sup }\vb f_\beta } 
  \vb f_\alpha(\vb x) \cdot \Big[\vbhat{n}(\vb x)\times  \vb f_\beta(\vb x)\Big]
   \,d\vb x
$$
where $\vbhat{n}(\vb x)$ is the surface normal at $\vb x$. 
(The direction of $\vbhat{n}$ must be chosen consistently; 
in {\sc libscuff} this is done by placing one or more 
\textit{reference points} inside closed objects and choosing 
the surface normal to each panel to point \textit{away}
from the nearest reference point.)

$ O^{\times}_{\alpha\beta}$ is only nonzero in 
the case of Figure \ref{OverlapIntegralFigure}\textbf{(b)}.
(In particular, the diagonal element 
$ O^{\times}_{\alpha\alpha}$ vanishes.)
Proceeding in analogy to the computation leading to 
equation (\ref{OAlphaBeta}), we find
\begin{align}
O^{\times}_{\alpha\beta}
&=\int_{\mathcal{P}} \vb f_\alpha(\vb x) \cdot 
                     \Big[\vbhat{n} \times \vb f_\beta(\vb x)\Big]  \, d\vb x 
\nn
&=\frac{\sigma^\alpha \sigma^\beta l_\alpha l_\beta}{2A} 
  \int_0^1 \, du \, \int_0^u \, dv \, 
  \Big[ u \vb L_\beta + v\vb L_\alpha\Big]
 \cdot
  \Big[ (u-1) \big(\vbhat{n}\times \vb L_\beta\big) + 
        (v-1) \big(\vbhat{n}\times \vb L_\alpha\big)
  \Big]
\nn
&=\frac{\sigma^\alpha \sigma^\beta l_\alpha l_\beta}{12A} 
  \Big[ \vb L_\alpha \cdot (\vbhat{n}\times \vb L_\beta) \Big]
\nn
&=\frac{\sigma^\alpha \sigma^\beta l_\alpha l_\beta}{12A} 
  \Big[ \vbhat{n} \cdot \big(\vb L_\beta\times \vb L_\alpha\big) \Big]
\nonumber
\intertext{by cyclic permutation of the triple vector product. But
the magnitude of the cross product here is just $\vbhat{n}$ times 
twice the panel area,}
&=\frac{\sigma^\alpha \sigma^\beta l_\alpha l_\beta}{12A} 
  \Big[ \vbhat{n} \cdot \big(\pm 2A\,\vbhat{n}\big) \Big]
\nn
&=\pm\frac{\sigma^\alpha \sigma^\beta l_\alpha l_\beta}{6}.
\label{OTimesAlphaBeta}
\end{align}
The $\pm$ sign is determined as follows: Suppose we start 
at vertex $\vb Q_\alpha$ and traverse the vertices of 
$\mathcal{P}$ by following $\vb L_\beta$, then $\vb L_\alpha$.
If in so doing we encounter the vertices of $\pan$ in 
the order $(0,1,2)$ or a cyclic permutation thereof, then
the $+$ sign holds in (\ref{OTimesAlphaBeta}); otherwise
(i.e. if we encounter the vertices in the order $(0,2,1)$ or 
a cyclic permutation thereof) the $-$ sign holds.

An easy way to determine this sign is to look at the 
indices within $\mathcal{P}$ of vertices $\vb Q_\beta$
and $\vb Q_\alpha$. Call these $I_\pan(\vb Q_\beta)$ and 
$I_\pan(\vb Q_\alpha)$, respectively; they are integers
defined modulo 3. Then the sign in (\ref{OTimesAlphaBeta})
is 
$$ \text{sign in equation (\ref{OTimesAlphaBeta})} 
   = 
   \begin{cases}
   +, \quad &\text{if } I_\pan(\vb Q_\beta)
                       -I_\pan(\vb Q_\alpha)
                        \equiv 2 \text{ mod } 3 
   \\
   -, \quad &\text{if } I_\pan(\vb Q_\beta)
                       -I_\pan(\vb Q_\alpha)
                        \equiv 1 \text{ mod } 3.
   \end{cases}
$$

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newpage
\section{Fields due to individual basis functions}

To compute the electric and magnetic fields at a point $\vb x$ 
arising from the current carried by a single RWG or
half-RWG basis function $\vb f_\alpha(\vb x)$, we first define the
``reduced potentials'' of $\vb f_\alpha$. These are basically just 
the usual vector and scalar potentials due to a current 
distribution, but without the proper dimensionful prefactors:
$$ \vb a_\alpha(\vb x) =
   \int_{\sup \vb f_\alpha} 
     G(k; \vb x - \vb x^\prime) \vb f_\alpha(\vb x^\prime) \, d\vb x^\prime,
   \qquad
   p(\vb x) =
   \int_{\sup \vb f_\alpha} G(k; \vb x - \vb x^\prime) 
                     \Big[\nabla \cdot \vb f_\alpha(\vb x^\prime)\Big] \, d\vb x^\prime.
$$
(Here $G(k; \vb r)=e^{ik|\vb r|}/{(4\pi|\vb r|)}$,
with $k=\sqrt{\epsilon\mu}\cdot \omega$ the wavenumber in the medium 
of interest.)

Now suppose we have electric and magnetic current distributions
described by basis function $\vb f_\alpha$ populated with strengths $K_\alpha$
and $N_\alpha$, respectively. Then the electric and magnetic fields at
$\vb x$ are 
\begin{align*}
 \vb E (\vb x) 
&= 
  Z_0 K_\alpha \Big[ i\omega \mu \vb a_\alpha(\vb x) 
                     - \frac{1}{i\omega \epsilon}\nabla p(\vb x)
               \Big]
 - N_\alpha \nabla \times \vb a(\vb x)
\\[5pt]
 \vb H(\vb x) 
&=
  K_\alpha \nabla \times \vb a(\vb x)
 +\frac{1}{Z_0}
  N_\alpha \Big[   i\omega \epsilon \vb a(\vb x) 
                 - \frac{1}{i\omega \mu }\nabla p(\vb x)
               \Big]
\end{align*}
(Note that $\epsilon$ and $\mu$ here are the \textit{relative}
permeability and permittivity of the medium in question; $Z_0$ 
is the impedance of free space.)

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newpage
\section{Cartesian Multipole Moments}

\subsection{Electric Dipole Moment of an RWG Electric Current}
The electric dipole moment of an electric current distribution $\vb J(\vb x)$ is 
$$\vb p= \int_{\sup \vb J}  \vb x\, \rho(\vb x) d\vb x $$
where $\rho(\vb x)\equiv \frac{1}{i\omega}\nabla \cdot \vb J$ is the charge 
density associated with $\vb J$. For an RWG function populated with unit 
strength we have 
\begin{align} 
 \rho_\alpha(\vb x) 
 &=\frac{1}{i\omega}\nabla \cdot \vb f_\alpha(\vb x) \nn
 &=\frac{1}{i\omega}
   \begin{cases} 
    +\displaystyle{\frac{l_\alpha}{A^+_\alpha}}, 
     \qquad &\vb x \in \mathcal{P}_\alpha^+ \\\\
    -\displaystyle{\frac{l_\alpha}{A^-_\alpha}}, 
      \qquad &\vb x \in \mathcal{P}_\alpha^-.
   \end{cases} \label{rhoRWG}
\end{align} 
Then the electric dipole moment of an electric current distribution 
described by an RWG function populated with unit strength is 
\begin{align*}
  \vb p_\alpha 
&= \frac{2l_\alpha}{i\omega}
   \left\{ 
   \frac{1}{2A^+_\alpha} \int_{\pan_\alpha^+} \vb x \,d\vb x  
   \,\,- \,\,
   \frac{1}{2A^-_\alpha} \int_{\pan_\alpha^-} \vb x \, d\vb x 
   \right\}  \\
&= \frac{2l_\alpha}{i\omega}
   \left\{ 
            \int_0^1 \,du\,\int_0^u \, dv 
            \Big[ \vb Q^+ + u(\vb V_1-\vb Q^+) + v(\vb V_2 - \vb V_1)  \Big]
   \right. \\
&  \qquad \qquad- 
   \left. 
            \int_0^1 \,du\,\int_0^u \, dv 
            \Big[ \vb Q^- + u(\vb V_1-\vb Q^-) + v(\vb V_2 - \vb V_1)  \Big]
   \right\} \\
&= \frac{l_\alpha}{3 i\omega}\Big(\vb Q^+_\alpha - \vb Q^-_\alpha\Big).
\end{align*}

\subsection{Magnetic Dipole Moment of an RWG Electric Current}

The magnetic dipole moment of an electric current distribution $\vb J(\vb x)$ is 
$$\vb m= \frac{1}{2} \int_{\sup \vb J}  \vb x \times \vb J(\vb x) \,d\vb x. $$
Then the magnetic dipole moment of an electric current distribution 
described by an RWG function populated with unit strength is 
\begin{align*}
  \vb m_\alpha 
&= \frac{l_\alpha}{2}
   \left\{ 
   \frac{1}{2A^+_\alpha} \int_{\pan_\alpha^+} 
                         \vb x \times \Big(\vb x-\vb Q^+\Big) 
                         \,d\vb x  
   \,\,- \,\,
   \frac{1}{2A^-_\alpha} \int_{\pan_\alpha^-} 
                         \vb x \times \Big(\vb x-\vb Q^-\Big) 
                         \,d\vb x  
   \right\}  \\
&= \frac{l_\alpha}{2}
   \left\{ 
   \frac{1}{2A^+_\alpha} 
     \left[\vb Q^+ \times \int_{\pan_\alpha^+} \vb x \,d\vb x  \right]
   \,\,- \,\,
   \frac{1}{2A^-_\alpha} 
     \left[ \vb Q^- \times \int_{\pan_\alpha^-} \vb x \,d\vb x \right]
   \right\}\\
&= \frac{l_\alpha}{2}
   \left\{ 
            \int_0^1 \,du\,\int_0^u \, dv 
            \Big[  u(\vb Q^+ \times \vb V_1) 
                  +v(\vb Q^+ \times (\vb V_2 - \vb V_1)) 
            \Big]
   \right. \\
&  \qquad \qquad- 
   \left. 
            \int_0^1 \,du\,\int_0^u \, dv 
            \Big[  u(\vb Q^- \times \vb V_1) 
                  +v(\vb Q^- \times (\vb V_2 - \vb V_1)) 
            \Big]
   \right\} \\
&= \frac{l_\alpha}{12}
   \Big(\vb Q^+_\alpha - \vb Q^-_\alpha\Big) \times 
   \Big(\vb V_{1\alpha} + \vb V_{2\alpha}\Big).
\end{align*}

\subsection{Dipole Moments of RWG Magnetic Currents}

In a non-PEC scattering problem we must account for the 
contributions of the magnetic currents to the electric
and magnetic dipole moments. To ferret out what these
are, we need to recall how dipole moments are defined
in the first place. We begin by considering a 
vector-valued function $\vb K(\vb x^\prime)$ 
confined to a region near the origin of spatial extent 
much smaller than the distance to some evaluation point 
$\vb x$. In this case it is just a mathematical fact that 
the convolutions of $\vb K$ with the $\vb G$ and $\vb C$
kernels approach 

\newcommand{\moment}[2]{#1^{\text{\tiny{($\mathbf{#2}$)}}}}
\begin{align*}
\oint \vb G(\vb x, \vb x^\prime) \cdot \vb K(\vb x^\prime) d\vb x^\prime
 &\quad\to\quad   A_{ij}(\vb x) \moment{p_j}{K}
                + B_{ij}(\vb x) \moment{m_j}{K}
\\
\oint \vb C(\vb x, \vb x^\prime) \cdot \vb K(\vb x^\prime) d\vb x^\prime
 &\quad\to\quad  -B_{ij}(\vb x) \moment{p_j}{K}
                + A_{ij}(\vb x) \moment{m_j}{K}
\end{align*}
where $\{A,B\}_{ij}(\vb x)$ are certain functions whose precise
form we will not need, and where 
$\moment{\vb p}{K}$
and 
$\moment{\vb m}{K}$
are certain constants associated with the $\vb K$ 
distribution:
$$ \moment{\vb p}{K}
    =\frac{1}{i\omega} \int \Big(\nabla \cdot \vb K\Big)d\vb x, 
   \qquad
   \moment{\vb m}{K}
    =\frac{1}{2} \int \vb x \times \vb K(\vb x) d\vb x.
$$ 
Using these, the fields at distant points are
%====================================================================%
\begin{align*}
 \vb E\big[\vb K; \vb x\big]
 &= ikZ \oint \vb G(\vb x, \vb x^\prime) \cdot \vb K(\vb x^\prime) d\vb x^\prime
\\
 &\to ikZ \Big[   A_{ij} \moment{p}{K} + B_{ij} \moment{m}{K} \Big]
\\
 \vb H\big[\vb K; \vb x\big]
 &=  -ik\oint \vb C(\vb x, \vb x^\prime) \cdot \vb K(\vb x^\prime) d\vb x^\prime
\\
 &\to -ik\Big[  -B_{ij} \moment{p}{K}
               + A_{ij} \moment{m}{K}
         \Big]
\end{align*}
%====================================================================%
Now we consider the effect of adding magnetic currents 
$\vb N$ into the mix. The fields become
%====================================================================%
\begin{align*}
 \vb E\big[\vb K, \vb N; \vb x\big]
 &=  ikZ \oint \vb G(\vb x, \vb x^\prime) \cdot \vb K(\vb x^\prime) d\vb x^\prime
     + ik\oint \vb C(\vb x, \vb x^\prime) \cdot \vb N(\vb x^\prime) d\vb x^\prime
\\[5pt]
 &\to ikZ \Big[   A_{ij} \moment{p_j}{K} + B_{ij} \moment{m_j}{K} \Big] 
       +ik\Big[  -B_{ij} \moment{p_j}{N} + A_{ij} \moment{m_j}{N} \Big]
\\[5pt]
 &\to ikZ \bigg[   A_{ij} 
                  \underbrace{\Big\{ \moment{p_j}{K} + \frac{1}{Z}\moment{m_j}{N} \Big\}}
                             _{\moment{p_j}{K,N}}
                  +B_{ij} 
                  \underbrace{\Big\{ \moment{m_j}{K} - \frac{1}{Z}\moment{p_j}{N} \Big\}}
                             _{\moment{m_j}{K,N}}
          \bigg]
\\[10pt]
 \vb H\big[\vb K, \vb N; \vb x\big]
 &=  -ik\oint \vb C(\vb x, \vb x^\prime) \cdot \vb K(\vb x^\prime) d\vb x^\prime
   +\frac{ik}{Z} \oint \vb G(\vb x, \vb x^\prime) \cdot \vb N(\vb x^\prime) d\vb x^\prime
\\[5pt]
 &\to       -ik\Big[  -B_{ij} \moment{p_j}{K} + A_{ij} \moment{m_j}{K} \Big]
  +\frac{ik}{Z}\Big[   A_{ij} \moment{p_j}{N} + B_{ij} \moment{m_j}{N} \Big].
\\[5pt]
 &\to      -ik\bigg[  -B_{ij} 
                      \underbrace{\Big\{\moment{p_j}{K} + \frac{1}{Z}\moment{m_j}{N}\Big\}}
                                _{\moment{p_j}{K,N}}
                      +A_{ij} 
                      \underbrace{\Big\{\moment{m_j}{K} - \frac{1}{Z}\moment{m_j}{N}\Big\}}
                                _{\moment{m_j}{K,N}}
              \bigg].
\end{align*}
So the effective electric and magnetic dipole moments of a combined
distribution of electric and magnetic currents are 
$$ \moment{\vb p}{K,N} \equiv \moment{\vb p}{K} + \frac{1}{Z}\moment{\vb m}{N},
   \qquad
   \moment{\vb m}{K,N} \equiv \moment{\vb m}{K} - \frac{1}{Z}\moment{\vb p}{N}.
$$
Note that these depend on $Z$.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand{\MMExt}{\check{\mathcal{M}}}
\newcommand{\MMInt}{\hat{\mathcal{M}}}
\newcommand{\NNExt}{\check{\mathcal{N}}}
\newcommand{\NNInt}{\hat{\mathcal{N}}}
\newcommand{\BMMExt}{\boldsymbol{\check{\mathcal{M}}}}
\newcommand{\BMMInt}{\boldsymbol{\hat{\mathcal{M}}}}
\newcommand{\BNNExt}{\boldsymbol{\check{\mathcal{N}}}}
\newcommand{\BNNInt}{\boldsymbol{\hat{\mathcal{N}}}}
\newpage
\section{Spherical Multipole Moments}

\subsection*{Definition of the Spherical Multipole Moments}

Following Jackson and other authors, I define the 
electric and magnetic spherical multipole moments of a localized source 
distribution to be the coefficients in a spherical-wave
expansion of the fields away from the source regions:
\begin{subequations}
\begin{align}
 \vb E(\vb r) &= \sum_{\ell m} \Big\{  a\supt{M}_{\ell,m} \MMExt_{\ell m}(\vb r)
                                      +a\supt{E}_{\ell,m} \NNExt_{\ell m}(\vb r)
                               \Big\}
\\
 \vb H(\vb r) &= \frac{1}{Z}
                 \sum_{\ell m} \Big\{ -a\supt{M}_{\ell,m} \NNExt_{\ell m}(\vb r)
                                      +a\supt{N}_{\ell,m} \MMExt_{\ell m}(\vb r)
                               \Big\}
\end{align}
\label{SphericalMultipoleDefinitions}
\end{subequations}
where $Z$ is the wave impedance of the medium ($Z=377\,\Omega$ for vacuum).
Note that my $a\supt{M}_{\ell,m}, a\supt{E}_{\ell,m}$ coefficients
are not normalized in quite the same way as Jackson's
$a\subt{$M$}(l,m), a\subt{$E$}(l,m)$ coefficients; 
the relationship is 
$$ a\supt{M}_{\ell,m} = Z_0 a\subt{$M$}(l,m), \qquad 
   a\supt{E}_{\ell,m} = Z_0 \frac{i}{k} a\subt{$E$}(l,m)
$$
Jackson gives expressions (equations 9.167-8) for computing 
the $a$ coefficients for given source distributions; however, 
these expressions are not convenient for our 
purposes.\footnote{In particular, applying Jackson's expressions
directly would require evaluating integrals over the quantity 
$\nabla\cdot \big[\vb r \times \vb f\supt{RWG}(\vb r)\big]$,
which vanishes in the \textit{interior} of an RWG panel but makes
nonzero contributions at the \textit{edges}. This complication
makes Jackson's expressions somewhat unwieldy in our case, 
whereas the approach outlined above is computationally 
straightforward.} Instead, in the following sections I outline
an alternative approach for recovering the $a$ coefficients
from known source distributions.

\subsection*{Expansion of the Dyadic Green's Functions in Spherical Helmholtz Solutions}

This approach is based on the well-known spherical-wave expansion 
of the dyadic Green's functions of Section \ref{DyadicGreensFunctionsSection}.
[In the following expression, the $\rho$ and $\sigma$ subscripts run over
spherical vector components ($r,\theta,\phi$.)]

\begin{subequations}
\begin{align}
  G_{\rho\sigma} (k; \vb r-\vb r^\prime)
&=\hspace{0.09in} ik
  \sum_{\ell m} 
  \Big\{ 
     \MMExt_{\ell m \rho}( k, \vb r_>)
     \MMInt^*_{\ell m \sigma}( k, \vb r_<) 
   + \NNExt_{\ell m \rho}( k, \vb r_>)
     \NNInt^*_{\ell m \sigma}( k, \vb r_>) 
  \Big\}
\\
  C_{\rho\sigma} (k; \vb r-\vb r^\prime)
&=ik
  \sum_{\ell m} 
  \Big\{ 
     \NNExt_{\ell m \rho}( k, \vb r_>)
     \MMInt^*_{\ell m \sigma}( k, \vb r_<) 
   - \MMExt_{\ell m \rho}( k, \vb r_>)
     \NNInt^*_{\ell m \sigma}( k, \vb r_>) 
  \Big\}
\end{align}
\label{GCExpansions}
\end{subequations}
(Note: The expansion for $\vb C$ here assumes that 
$|\vb r|>|\vb r^\prime|.$ In the opposite case in 
which 
$|\vb r|<|\vb r^\prime|,$ the above expression for $\vb C$
acquires a minus sign.)

\subsection*{Fields due to localized current distributions}

Now consider the fields arising from localized surface electric
and magnetic current distributions $\vb K(\vb x)$ and $\vb N(\vb x):$
\begin{align*}
 \vb E(\vb r) 
&= 
   ik\int \Big\{ Z\vb G(k, \vb r-\vb r^\prime) \cdot \vb K(\vb r^\prime)
                 +\vb C(k, \vb r-\vb r^\prime) \cdot \vb N(\vb r^\prime)
          \Big\} \, d\vb r^\prime
\\
 \vb H(\vb r) 
&= 
   ik\int \Big\{ -\vb C(k, \vb r-\vb r^\prime) \cdot \vb K(\vb r^\prime)
                 +\frac{1}{Z}\vb G(k, \vb r-\vb r^\prime) \cdot \vb N(\vb r^\prime)
          \Big\}\,d\vb r^\prime.
\end{align*}
Insert the expansions (\ref{GCExpansions}) and assume that the 
field evaluation point will always be further from the origin than
the source current point: 
\begin{subequations}
\begin{align*}
 \vb E(\vb r) 
&= 
 -k^2 \sum_{\ell m} 
       \Bigg\{ \BMMExt_{\ell m}(\vb r) \cdot 
               \bigg[   \INP{ \BMMInt_{\ell m} }{Z \vb K}
                      - \INP{ \BNNInt_{\ell m} }{\vb N}
               \bigg]
\\
&\hspace{1.0in}
             + \BNNExt_{\ell m}(\vb r) \cdot 
               \bigg[   \INP{ \BNNInt_{\ell m} }{Z \vb K}
                      + \INP{ \BMMInt_{\ell m} }{\vb N}
               \bigg]
       \Bigg\}
\\[8pt]
 \vb H(\vb r) 
&= -\frac{k^2}{Z_0} \sum_{\ell m} 
       \Bigg\{ \BMMExt_{\ell m}(\vb r) \cdot 
               \bigg[   \INP{ \BNNInt_{\ell m} }{Z\vb K}
                      + \INP{ \BMMInt_{\ell m} }{\vb N}
               \bigg]
\\
&\hspace{1.0in}
             + \BNNExt_{\ell m}(\vb r) \cdot 
               \bigg[ - \INP{ \BMMInt_{\ell m} }{Z\vb K}
                      + \INP{ \BNNInt_{\ell m} }{\vb N}
               \bigg]
       \Bigg\}
\end{align*}
\label{SphericalFieldExpansions}
\end{subequations}

Comparing (\ref{SphericalFieldExpansions}) with the definitions
(\ref{SphericalMultipoleDefinitions}) now allows us to read off
the expressions for $a\sups{E,M}$ in terms of the source
distributions $\vb K$ and $\vb N$: 

%====================================================================%
%====================================================================%
%====================================================================%
\begin{subequations}
\begin{align}
a\sups{M}_{\ell,m}
 &= -k^2\bigg[ \INP{ \BMMInt_{\ell m} }{Z\vb K}
              -\INP{ \BNNInt_{\ell m} }{\vb N}
        \bigg]
\\
a\sups{E}_{\ell,m}
 &= -k^2\bigg[  \INP{ \BNNInt_{\ell m} }{Z\vb K}
               +\INP{ \BMMInt_{\ell m} }{\vb N}
        \bigg]
\end{align}
\label{SphericalMultipolesFromKN}
\end{subequations}
%====================================================================%
%====================================================================%
%====================================================================%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newpage
\section{Evaluation of the fields at panel centroids}

It is useful to have expressions for the $\vb E$ and $\vb H$
fields at the centroids of the triangular panels in the
discretization of object surfaces. Of course, the solution 
of the EFIE or PMCHW equations automatically gives us the 
\textit{tangential} components of the fields on the object
surfaces, but to get the normal components we must do a little
more work. 

Thus, consider the fields at a point lying a distance $z$
above the centroid of a panel in the direction of the 
outward-pointing panel normal. Let $\vbrho=(x,y)$ be the
in-plane coordinate vector. The normal $\vb E-$field is given by
%====================================================================%
\begin{align}
E_z(z) 
 &= \int d\vbrho \, \Big\{ 
             \Gamma_{zx}\supt{EE}(\vbrho, z) K_x(\vbrho) 
            +\Gamma_{zy}\supt{EE}(\vbrho, z) K_y(\vbrho) 
           \Big\}
\nonumber \\
&\qquad
   + \int d\vbrho \, \Big\{ 
             \Gamma_{zx}\supt{EM}(\vbrho, z) N_x(\vbrho) 
            +\Gamma_{zy}\supt{EM}(\vbrho, z) N_y(\vbrho) 
           \Big\}.
\label{Ezz}
\end{align}
%====================================================================%
Anticipating that the final answers will involve the 
first derivatives of $\vb K$ and $\vb N$ at the origin (i.e. the panel 
centroid), I write
%====================================================================%
\begin{align*}
 K_x(\vbrho) &= K_x^{(00)} + x K_x^{(10)} + y K_x^{(01)} + xyK_x^{(11)}
  + \cdots 
\\
 K_y(\vbrho) &= K_y^{(00)} + x K_y^{(10)} + y K_y^{(01)} + xyK_y^{(11)}
  + \cdots
\end{align*}
(where $K^{(pq)}$ is short 
for $|\partial^{p+q} K/\partial^p x \partial^q y|_{\vbrho=0}$)
and similarly for the components of $\vb N$.
%====================================================================%
Also, the components of the $\Gamma$ tensors that I will need are
%====================================================================%
\begin{align*}
 \Gamma\supt{EE}_{zx} &= i k Z zx \big[-3 + 3ikr - (ikr)^2\big]
  \frac{e^{ikr}}{4\pi (ik)^2 r^5}
\\
 \Gamma\supt{EE}_{zy} &= i k Z zy \big[-3 + 3ikr - (ikr)^2\big]
  \frac{e^{ikr}}{4\pi (ik)^2 r^5}
\\
 \Gamma\supt{EM}_{zx} &= i k y \big[-1 + ikr\big]
  \frac{e^{ikr}}{4\pi (ik) r^3}
\\
 \Gamma\supt{EM}_{zy} &= -i k x \big[-1 +ikr\big]
  \frac{e^{ikr}}{4\pi (ik) r^3}
\end{align*}
%====================================================================%
where $r=\sqrt{\vbrho^2 + z^2}$ and $k,Z$ are the wavenumber and
wave impedance for the medium in question.
Now I insert everything into (\ref{Ezz}) and note that terms linear
in $x$ and/or $y$ vanish under the angular portion of the $d\vbrho$
integration:
$$ \int d\vbrho 
   \left\{ \begin{array}{c} 1 \\ x \\ y \\ x^2 \\xy \\y^2 \end{array}
   \right\}
   =2\pi \int \, \rho d\rho 
   \left\{ \begin{array}{c} 1 \\ 0 \\ 0 \\ \rho^2/2 \\ 0 \\ \rho^2/2 \end{array}
   \right\}
$$
%====================================================================%
This yields
\begin{align*}
 E_z(z) 
&= \frac{Z \big( K_x^{(10)} + K_y^{(01)} \big)}{4ik}  
   \cdot z \cdot \int_0^\infty \, \rho^3 d\rho \, \big[-3 + 3ikr - (ikr)^2\big] 
   \frac{e^{ikr}}{r^5}
\\
&\qquad
 + \frac{\big( N_x^{(01)} - N_y^{(10)} \big)}{4}  
   \int_0^\infty \, \rho^3 d\rho \, \big[-1 + ikr ] 
   \frac{e^{ikr}}{r^3}.
\end{align*}
%====================================================================%
The prefactor in the second term here involves the $z$ component of the 
curl of the magnetic current, $\nabla \times \vb N$; but the curl of an 
RWG basis function vanishes in the interior of the panels on which the 
function is defined, so this term does not contribute.

On the other hand, the first term here is proportional to $\nabla \cdot \vb K$.
Change integration variables to 
$r=\sqrt{\rho^2 + z^2}, \,\, r\,dr = \rho\, d\rho:$
%====================================================================%
\begin{align*}
 E_z(z) 
&= \frac{Z \big (\nabla \cdot \vb K \big)}{4ik} 
   \cdot z \cdot \int_z^\infty \, dr (r^2 - z^2) \, \big[-3 + 3ikr - (ikr)^2\big] 
   \frac{e^{ikr}}{r^4}
\end{align*}
The only terms in the integrand that lead to nonvanishing results in the 
$z\to 0$ limit are those coming from the $-3$ term in the square brackets:
%====================================================================%
\begin{align*}
 -3z\cdot \int_z^\infty \left[ \frac{1}{r^2} - \frac{z^2}{r^4} \right]dr 
&=
  3z\cdot\left| \frac{1}{r} - \frac{z^2}{3r^3} \right|_{z}^\infty
\\
&=2
\end{align*}
%====================================================================%
and thus 
\numeq{Ezz2}
{
   \lim_{z\to 0}E_z(z) 
   = \frac{Z(\nabla \cdot \vb K)}{2ik} 
   = \frac{(\nabla \cdot \vb K)}{2i\epsilon \omega } 
   = \frac{\sigma}{2\epsilon}
}
where $\sigma=\frac{1}{i\omega}\nabla \cdot \vb K$ is 
the surface charge density at the panel centroid. 

Equation (\ref{Ezz2}) is of course just the result we 
would have predicted on the basis of electrostatic 
arguments, but it is useful to see here how it follows 
from our full frequency-dependent formalism.

Meanwhile, an analogous calculation for the magnetic field yields
\numeq{Hzz}
{\lim_{z\to 0}H_z(z) 
   = -\frac{(\nabla \cdot \vb N)}{2i\mu\omega}.
   = -\frac{(\nabla \cdot \vb N)}{2ik Z}.
}
Note the minus sign compared to (\ref{Ezz2}).

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newpage
\newcommand{\GBar}{\overline{G}}

\section{Periodic Boundary Conditions}

\subsection{Periodic DGFs}

To avoid confusion with the free-space photon wavenumber, 
I use the symbol $\vb p$ to denote a two-dimensional 
Bloch wavevector.

I use an overbar notation to denote the 
\textit{periodic Green's function}, which contains contributions
from all lattice cells appropriately weighted by Bloch phases.
$$
  \GBar(\vb p; k; \vb r, \vb r^\prime)
= \sum_{\vb L} e^{i \vb p \cdot \vb L} G(k; \vb r, \vb r^\prime+\vb L)
\qquad 
 \bigg( G(k; \vb r, \vb r^\prime) 
 = \frac{e^{ik|\vb r-\vb r^\prime|}}{4\pi|\vb r-\vb r^\prime|}
 \bigg)
$$

I will also need to define a version of this function that 
excludes the contributions of the innermost 9 lattice cells.
I will call this version 
$\GBar_{\texttt{AB9}}$
%$\GBar_{\text{\scriptsize{AB9}}}$, 
where the subscript stands for 
stands for ``all but 9.''

\subsection{Assembling the BEM matrix}

\begin{align*}
M_{\alpha\beta}
\end{align*}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\appendix

\include{IndexNotationAppendix} 
\include{SphericalHelmholtzAppendix} 
\include{RelativeExponentialAppendix} 

\end{document}
