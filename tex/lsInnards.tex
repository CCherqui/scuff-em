%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% MatrixElements.tex 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\documentclass[dvips,letterpaper]{article}

\input{scufftex}

\graphicspath{{figures/}}

%------------------------------------------------------------
%------------------------------------------------------------
%- Special commands for this document -----------------------
%------------------------------------------------------------
%------------------------------------------------------------
\newcommand{\BG}{\boldsymbol{\Gamma}}

%------------------------------------------------------------
%------------------------------------------------------------
%- Document header  -----------------------------------------
%------------------------------------------------------------
%------------------------------------------------------------
\title {\lss Implementation and Technical Details}
\author {Homer Reid}
\date {October 11, 2011}

%------------------------------------------------------------
%------------------------------------------------------------
%- Start of actual document
%------------------------------------------------------------
%------------------------------------------------------------

\begin{document}
\pagestyle{myheadings}
\markright{Homer Reid: \lss Implementation and Technical Details}
\maketitle

\tableofcontents

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newpage
\section{Scattering Geometries in \lss}

\begin{itemize}

\item
\lss thinks of a scattering geometry as consisting of a collection
of ``objects.'' Each object $\mathcal{O}_\alpha$ is a region of
space throughout which the permittivity and permeability are constant,
$$ \epsilon(\vb x, \omega) \equiv \epsilon_\alpha(\omega), \qquad
   \mu(\vb x, \omega)      \equiv \mu_\alpha(\omega)
$$
where $\epsilon_\alpha(\omega)$ and $\mu_\alpha(\omega)$ may
be arbitrary user-specified functions of frequency. 
(Only isotropic $\epsilon$ and $\mu$ are supported).

All objects have finite volume and are geometrically characterized 
in \lss by a surface mesh consisting of a union of flat triangular
panels. The surface of object $\mathcal{O}_\alpha$ is labeled 
$\mathcal{S}_\alpha$.

Objects may be \textit{nested}, i.e. one object may be 
fully contained inside another object. 

In addition, all objects are understood to be embedded within an 
infinite homogeneous medium (the ``external medium'') with 
arbitrary user-specified material properties 
$\epsilon_e(\omega)$ and $\mu_e(\omega)$. (In what follows it
will occasionally be convenient to think of the external
medium as an object $\mathcal{O}_e$ with a surface $\mathcal{S}_e$
at infinity.)

\item
\lss recognizes two broad categories of material bodies:
``PEC'' (perfectly-electrically-conducting) bodies and
``dielectric'' bodies. 
The term ``dielectric'' in \lss parlance really just means
``not perfectly conducting.'' An object described as a ``dielectric''
for the purposes of \lss may be a good but imperfect conductor,
a magnetic material, or any other type of material that we wouldn't
typically think of as a ``dielectric.''

\item
\lss decomposes the total electric and magnetic fields into 
``incident'' and ``scattered'' contributions. The ``incident'' 
fields, $\vb E\sups{inc}$ and $\vb H\sups{inc}$, 
are arbitrary user-specified functions of space.
The ``scattered'' fields $\vb E\sups{scat}$ and 
$\vb H\sups{scat}$ include the contributions of currents
flowing on the surfaces of all objects in the \lss geometry.
Generally speaking, the incident fields are the fields that
would be present if the scattering geometry were 
empty (all objects and the external medium have
$\epsilon=\mu=1$) and the scattered fields are the difference
between these incident fields and the actual fields that
exist in the presence of the non-empty scattering geometry. 

\end{itemize}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newpage
\section{Representation of Surface Currents in \ls}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newpage
\section{Homogeneous Dyadic Green's Functions}

Before proceeding, we must pause briefly to establish our 
conventions and notation for homogeneous dyadic Green's
functions.

Consider a homogeneous medium characterized by spatially uniform 
relative permittivity and permeability $\epsilon_\alpha$ and 
$\mu_\alpha$. (The $\alpha$ subscript serves to identify one of 
several piecewise-constant homogeneous regions in a \lss scattering 
geometry.) 
If we have
known distributions of electric and magnetic current
$\vb J(\vb x)$ and $\vb M(\vb x),$
we can compute the electric and magnetic fields in terms
of these currents and the properties of the medium, and  
the relevant convolution kernels in this procedure are
the dyadic Green's functions (DGFs):
%====================================================================%
\begin{align*}
 E_i(\vb x, \omega) 
&= 
   \int
    \Big\{
     \Gamma\supt{EE}_{ij}(\epsilon_\alpha, \mu_\alpha; \omega; \vb x, \vb x^\prime) 
     J_j(\vb x^\prime)
     +
     \Gamma\supt{EM}_{ij}(\epsilon_\alpha, \mu_\alpha; \omega; \vb x, \vb x^\prime) 
     M_j(\vb x^\prime)
    \Big\}
    \, d\vb x^\prime
\\
 H_i(\vb x, \omega) 
&= 
   \int
    \Big\{
     \Gamma\supt{ME}_{ij}(\epsilon_\alpha, \mu_\alpha; \omega; \vb x, \vb x^\prime) 
     J_j(\vb x^\prime)
     +
     \Gamma\supt{MM}_{ij}(\epsilon_\alpha, \mu_\alpha; \omega; \vb x, \vb x^\prime) 
     M_j(\vb x^\prime)
    \Big\}
    \, d\vb x^\prime.
\end{align*}
%====================================================================%

Explicit expressions for the DGFs are 
%====================================================================%
\begin{align*}
\BG\supt{EE}(\epsilon_\alpha, \mu_\alpha, \omega, \vb x, \vb x^\prime)
&=
 iZ_0 Z^\alpha k^\alpha \, \vb G(k^\alpha, \vb x-\vb x^\prime)
\\[8pt]
%--------------------------------------------------------------------%
\BG\supt{ME}(\epsilon_\alpha, \mu_\alpha, \omega, \vb x, \vb x^\prime)
&=
 -ik^\alpha \vb C(k^\alpha, \vb x-\vb x^\prime)
\\[8pt]
%--------------------------------------------------------------------%
\BG\supt{EM}(\epsilon_\alpha, \mu_\alpha, \omega, \vb x, \vb x^\prime)
&=
 ik^\alpha \, \vb C(k^\alpha, \vb x-\vb x^\prime)
\\[8pt]
%--------------------------------------------------------------------%
\BG\supt{MM}(\epsilon_\alpha, \mu_\alpha, \omega, \vb x, \vb x^\prime)
&= \frac{ik^\alpha}{Z_0 Z^\alpha} \vb G(k^\alpha, \vb x-\vb x^\prime)
\end{align*}
%====================================================================%
$$\bigg(Z_0=\sqrt\frac{\mu_0}{\epsilon_0},
        \qquad
        Z^\alpha=\sqrt\frac{\mu^\alpha}{\epsilon^\alpha}, 
         \qquad
        k^\alpha=\sqrt{\mu_0 \mu^\alpha \epsilon_0 \epsilon^\alpha}\cdot \omega
  \bigg)
$$
%====================================================================%
where $\vb G$, the ``photon Green's function,''
is the solution to the equation
\begin{equation}
 \Big[\nabla \times \nabla\times - \,\,k^2 \Big]\vb G(k; \vb r)
 =\delta(\vb r)\vb{1};
 \label{DyadicGFG}
\end{equation}
and $\vb C$ is defined by  
\begin{equation}
  \vb C(k, \vb r) = -\frac{1}{ik} \nabla \times \vb G(k, \vb r).
 \label{DyadicGFC}
\end{equation}
%
(Note that the $\BG$ dyadics depend separately on $\epsilon,\mu$ 
and $\omega$, while $\vb G$ and $\vb C$ depend only on the 
combination $k=\sqrt{\epsilon\mu}\cdot \omega.$)

Explicit expressions for the components of $\vb G$ and $\vb C$ are 
\begin{equation}
G_{ij}(k,\vb r) =
  \Big[\delta_{\mu\nu} +\frac{1}{k} \partial_i \partial_j \Big]
  G_0(k, \vb r), \qquad
  C_{ij}(k, \vb r) = +\frac{1}{i\kappa} \varepsilon_{ijl} 
                          \partial_l G_0(k, \vb r)
\label{GCfromG0}
\end{equation}
where $G_0$ is the scalar Green's function for the Helmholtz equation,
\numeq{ScalarGF}
{G_0(k; \vb r)
   =
  \frac{e^{ik|\vb r|}}{4\pi|\vb r|}
}
which satisfies
$$ \Big[ \nabla^2 + k^2 \Big] G_0(k; \vb r)
   =\delta(\vb r).
$$
With these expressions, we can verify that equation (\ref{DyadicGFC}) 
is actually just the first half of a pair of reciprocal curl identities 
relating $\vb G$ and $\vb C:$
\numeq{ReciprocalCurlIdentities}
{
  \frac{1}{ik} \nabla \times \vb G=-\vb C, 
\qquad
  \frac{1}{ik} \nabla \times \vb C=\vb G.
}
(As usual with tensors and dyadics, the vector notation here
is suggestive but vague; the precise meaning of (\ref{DyadicGFC}) is 
\numeq{ReciprocalCurlIdentities2}
{
   \frac{1}{ik} \varepsilon_{iAB} \partial_A G_{Bj} = -C_{ij},
   \qquad
   \frac{1}{ik} \varepsilon_{iAB} \partial_A C_{Bj} = G_{ij}.)
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\paragraph{Shorthand} In what follows, an equation like 

$$ E_i(\vb x, \omega) = 
   \int_{\mathcal S} 
     \Gamma\supt{EE}_{ij}(\epsilon_\alpha, \mu_\alpha; \omega; 
                          \vb x, \vb x^\prime) 
     K_j(\vb x^\prime)
    \, d\vb x^\prime
$$
will often be abbreviated to read 
$$ \vb E(\vb x) = 
    \int_{\mathcal S} 
      \BG\supt{EE}(\alpha, \vb x, \vb x^\prime) 
         \cdot \vb K(\vb x^\prime) 
    \, d\vb x^\prime
$$
(with $\omega$ arguments suppressed and the dependence 
on $\epsilon_\alpha, \mu_\alpha$ condensed into a dependence
on the region index $\alpha$), or even abbreviated further
to read
$$ \vb E = \BG\supt{EE}(\alpha) * \vb K $$
where $*$ denotes a convolution operation.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newpage
\section{Computation of the Scattered Fields in \ls}

Consider a point $\vb x$ in space. As illustrated in 
Figure \ref{FieldContributionsFigure}, suppose this point 
is contained inside an object $\mathcal{O}_\alpha$ (which
may be the external medium $\mathcal{O}_e$), and suppose
that there are additional objects 
$\mathcal{O}_\beta$ (PEC) and $\mathcal{O}_\gamma$ (dielectric) 
also contained inside $\mathcal{O}_\alpha$. 
Then the surfaces $\mathcal{S}_\beta$ and $\mathcal{S}_\gamma$,
together with $\mathcal{S}_\alpha$, constitute the boundary of 
the volume containing $\vb x$, and the scattered $E$-field at 
$\vb x$ is
%====================================================================%
\begin{align} 
E_i(\vb x) 
    = &-\int_{\mathcal{S}_\alpha} 
           \Big\{ \Gamma_{ij}\supt{EE}(\alpha; \vb x, \vb x^\prime) 
                   K_j(\vb x^\prime)
                  \,+\,
                   \Gamma_{ij}\supt{EM}(\alpha; \vb x, \vb x^\prime) 
                   N_j(\vb x^\prime)
           \Big\} \, d\vb x^\prime
\nn
     &+\int_{\mathcal{S}_\beta} 
           \Big\{ \Gamma_{ij}\supt{EE}(\alpha; \vb x, \vb x^\prime)
                   K_j(\vb x^\prime)
           \Big\} \, d\vb x^\prime
\nn
     &+\int_{\mathcal{S}_\gamma} 
           \Big\{ \Gamma_{ij}\supt{EE}(\alpha; \vb x, \vb x^\prime) 
                   K_j(\vb x^\prime)
                  \,+\,
                   \Gamma_{ij}\supt{EM}(\alpha; \vb x, \vb x^\prime) 
                   N_j(\vb x^\prime)
           \Big\} \, d\vb x^\prime
\nn
     &+\chi_\alpha\sups{inc} E\sups{inc}_i(\vb x).
\label{FieldContributionsEquation}
\end{align}
%====================================================================%
(The $\vb H$ fields are given by identical relations with 
$\{ \Gamma\supt{EE}, \Gamma\supt{EM}\}  \to 
 \{ \Gamma\supt{ME}, \Gamma\supt{MM}\}$.) 

Note the following points with respect to equation
(\ref{FieldContributionsEquation}):
\begin{itemize}
  \item If $\vb x$ is contained inside an object 
        $\mathcal{O}_\alpha$, sources on $\mathcal{S}_\alpha$
        contribute to the fields at $\vb x$ 
        \textit{with a minus sign} (first line of 
        (\ref{FieldContributionsEquation})). 
        (If $\mathcal{O}_\alpha=\mathcal{O}_e$, 
         the external medium, then this contribution vanishes.) 
        Sources on the surfaces of objects contained within 
        $\mathcal{O}_\alpha$ contribute with a plus sign.

  \item In each line of (\ref{FieldContributionsEquation}), 
        (i.e. regardless of the surface over which we are 
        integrating) the Green's functions used to compute
        the fields at $\vb x$ are the Green's functions for
        object $\mathcal{O}_\alpha$ (i.e. the Green's functions
        corresponding to material properties 
        $\{\epsilon_\alpha,\mu_\alpha\}$.) The material properties
        of objects $\mathcal{O}_\beta$ and $\mathcal{O}_\gamma$
        are not referenced.

  \item We have considered the case in which $\mathcal{O}_\alpha$
        contains just one PEC object $\mathcal{O}_\beta$ 
        and one dielectric object $\mathcal{O}_\gamma$, but 
        the case of multiple PEC and/or dielectric objects contained
        within $\mathcal{O}_\alpha$ is easily accommodated simply 
        by replicating the second and/or third lines on the RHS of 
        (\ref{FieldContributionsEquation}).

  \item Object $\mathcal{O}_\gamma$ might also contain one
        or more objects $\mathcal{O}_\delta$, and there
        may be additional objects $\mathcal{O}_\lambda$ not 
        contained within $\mathcal{O}_\alpha$ 
        (indeed, $\mathcal{O}_\alpha$ may itself be contained within
        an object), but these objects make no contribution
        to the scattered field at $\vb x$, because their surfaces are 
        not part of the surface bounding the volume containing $\vb x$.

  \item The last line of (\ref{FieldContributionsEquation}) describes
        the contribution of the incident field to the total field at 
        $\vb x$.  This contribution is only present if the incident 
        field sources lie inside $\mathcal{O}_\alpha$, a dependence
        which is characterized by the \textit{indicator function}
        $\chi\sups{inc}_\alpha$:

        $$
         \chi\sups{inc}_\alpha
         =\begin{cases} 
            1, \qquad &\text{if the incident field sources lie inside 
                              $\mathcal{O}_\alpha$} \\
            0, \qquad &\text{otherwise.}
          \end{cases} 
        $$
        
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\end{itemize}

%####################################################################%
%####################################################################%
%####################################################################%
\begin{figure}
\begin{center}
%\includegraphics{FieldContributionsFigure}
\caption{Contributions of objects to the scattered fields at 
         an arbitrary point $\vb x$. Objects $\mathcal{O}_\beta$
         and $\mathcal{O}_\gamma$ contribute
         to the field at $\vb x$ ``with a plus sign'' 
         (cf. equation \ref{FieldContributionsEquation}).
         Object $\mathcal{O}_\alpha$ 
         contributes to the field at $\vb x$ ``with a minus
         sign.'' Objects $\mathcal{O}_\delta$ and $\mathcal{O}_\lambda$
         do not contribute to the field at $\vb x$.}
\label{FieldContributionsFigure}
\end{center}
\end{figure}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newpage
\section{The Equations Solved by \ls: Continuous Forms}

\subsection{The equation imposed at points on PEC object surfaces}

At each point $\vb x$ on the surface of a PEC object,
we require that the tangential components of the 
total (incident + scattered) field vanish:
\numeq{PECEquation1}
{ \vbhat{n}\times \vb E\sups{total} (\vb x)=0 
}
where $\vbhat{n}$ is the normal to the object surface
at $\vb x$. 
To break this down a little further, suppose that $\vb x$
lies on the surface of object $\mathcal{O}_\beta$ in
Figure (\ref{FieldContributionsFigure}). Then (\ref{PECEquation1}) 
reads
%====================================================================%
\begin{align}
\vbhat{n}\times
 \Bigg[  &\hphantom{+}\,\,\int_{\mathcal{S_\beta}} 
           \Big\{ \BG\supt{EE}(\alpha)*\vb K \Big\} \, d\vb x^\prime
\nn
         &+\int_{\mathcal{S_{\beta^\prime}}} 
           \Big\{ \BG\supt{EE}(\alpha)*\vb K \Big\} \, d\vb x^\prime
\nn
         &+\int_{\mathcal{S_\gamma}} 
           \Big\{ \BG\supt{EE}(\alpha)*\vb K 
                 +\BG\supt{EM}(\alpha)*\vb N \Big\} \, d\vb x^\prime
\nn
         &-\int_{\mathcal{S_\alpha}} 
           \Big\{ \BG\supt{EE}(\alpha)*\vb K 
                 +\BG\supt{EM}(\alpha)*\vb N \Big\} \, d\vb x^\prime
 \Bigg]
= -\chi\sups{inc}_\alpha \vbhat{n}\times \vb E\sups{inc}(\vb x)
\label{PECEquationBreakdown}
\end{align}
%====================================================================%
where $S_\alpha$ is the surface of the object $\mathcal{O}_\alpha$ 
that contains $\mathcal{O}_\beta$ (which may be the exterior medium, 
in which case the last bracketed term on the LHS 
of (\ref{PECEquationBreakdown}) vanishes),
$\beta^\prime$ runs over any other PEC objects contained
within $\mathcal{O}_\alpha$, and $\gamma$ runs over
any dielectric objects contained within 
$\mathcal{O}_\alpha$.

The incident field only contributes to the total field
inside object $\mathcal{O}_\alpha$, 
and thus only contributes to equation (\ref{PECEquation1}),
if the incident field sources are contained inside 
$\mathcal{O}_\alpha$. This dependence is represented by the 
quantity $\chi\sups{inc}_\alpha$ on the RHS of 
(\ref{PECEquationBreakdown}), which is an 
\textit{indicator function} characterizing the location of 
the incident field sources:
$$
 \chi\sups{inc}_\alpha
 =\begin{cases} 
    1, \qquad &\text{if the incident field sources lie inside 
                      $\mathcal{O}_\alpha$} \\
    0, \qquad &\text{otherwise.}
  \end{cases} 
$$

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{The equation imposed at points on dielectric object surfaces}

At each point $\vb x$ on the surface of a dielectric object, we require
that the tangential components of the total $\vb E$ and $\vb H$ fields
be continuous as we pass from just inside to just outside the 
surface,
%====================================================================%
\begin{subequations}
\begin{align}
 \lim_{\eta \to 0} \vbhat{n}\times 
 \Big[ \vb E\sups{total}(\vb x + \eta\vbhat{n})
      -\vb E\sups{total}(\vb x - \eta\vbhat{n})
 \Big] 
&= 0 
\\
 \lim_{\eta \to 0} \vbhat{n}\times 
 \Big[ \vb H\sups{total}(\vb x + \eta\vbhat{n})
      -\vb H\sups{total}(\vb x - \eta\vbhat{n})
 \Big] 
&= 0.
\label{DielectricEquation1}
\end{align}
\end{subequations}
%====================================================================%
Referring again to Figure (\ref{FieldContributionsFigure}), let 
$\mathcal{O}_\gamma$ be the dielectric object in question, let 
$\mathcal{O}_\alpha$ be the object containing 
$\mathcal{O}_\gamma$, 
let $\mathcal{O}_{\gamma^\prime}$ represent any other dielectric
objects contained in $\mathcal{O}_\alpha$, 
let $\mathcal{O}_{\beta}$ represent any PEC objects contained 
in $\mathcal{O}_\alpha$, and let $\mathcal{O}_\delta$ represent 
any objects contained inside $\mathcal{O}_\gamma$.

Then the total $E$-field as we approach $\vb x$ from 
\textit{inside} $\mathcal{O}_\gamma$ is 
%====================================================================%
\begin{align} 
E\sups{total}_i(\vb x) 
    = &-\int_{\mathcal{S}_\gamma} 
           \Big\{ \Gamma_{ij}\supt{EE}(\gamma; \vb x, \vb x^\prime) 
                   K_j(\vb x^\prime)
                  \,+\,
                   \Gamma_{ij}\supt{EM}(\gamma; \vb x, \vb x^\prime) 
                   N_j(\vb x^\prime)
           \Big\} \, d\vb x^\prime
\nn
     &+\int_{\mathcal{S}_\delta}
           \Big\{ \Gamma_{ij}\supt{EE}(\gamma; \vb x, \vb x^\prime) 
                   K_j(\vb x^\prime)
                  \,+\,
                   \Gamma_{ij}\supt{EM}(\gamma; \vb x, \vb x^\prime) 
                   N_j(\vb x^\prime)
           \Big\} \, d\vb x^\prime.
\nn
     &+\chi\sups{inc}_\gamma E_i\supt{inc}(\vb x)
\label{FieldInsideDielectric}
\end{align}
%====================================================================%
(we have assumed that $\mathcal{O}_\delta$ is dielectric, but 
the PEC case is similar), while the 
total $E$-field as we approach $\vb x$ from \textit{outside} 
$\mathcal{O}_\gamma$ is 
%====================================================================%
\begin{align} 
E\sups{total}_i(\vb x) 
    = &+\int_{\mathcal{S}_\gamma} 
           \Big\{ \Gamma_{ij}\supt{EE}(\alpha; \vb x, \vb x^\prime) 
                   K_j(\vb x^\prime)
                  \,+\,
                   \Gamma_{ij}\supt{EM}(\alpha; \vb x, \vb x^\prime) 
                   N_j(\vb x^\prime)
           \Big\} \, d\vb x^\prime
\nn
     &+\int_{\mathcal{S}_{\gamma^\prime}}
           \Big\{ \Gamma_{ij}\supt{EE}(\alpha; \vb x, \vb x^\prime) 
                   K_j(\vb x^\prime)
                  \,+\,
                   \Gamma_{ij}\supt{EM}(\alpha; \vb x, \vb x^\prime) 
                   N_j(\vb x^\prime)
           \Big\} \, d\vb x^\prime.
\nn
     &+\int_{\mathcal{S}_{\beta}}
           \Big\{ \Gamma_{ij}\supt{EE}(\alpha; \vb x, \vb x^\prime) 
                   K_j(\vb x^\prime)
           \Big\} \, d\vb x^\prime
\nn
     &-\int_{\mathcal{S}_{\alpha}}
           \Big\{ \Gamma_{ij}\supt{EE}(\alpha; \vb x, \vb x^\prime) 
                   K_j(\vb x^\prime)
                  \,+\,
                   \Gamma_{ij}\supt{EM}(\alpha; \vb x, \vb x^\prime) 
                   N_j(\vb x^\prime)
           \Big\} \, d\vb x^\prime
\nn
     &+\chi\sups{inc}_\alpha E_i\supt{inc}(\vb x).
\label{FieldOutsideDielectric}
\end{align}
%====================================================================%
Inserting (\ref{FieldInsideDielectric}) and 
(\ref{FieldOutsideDielectric}) into (\ref{DielectricEquation1}), 
the first of the two conditions imposed at $\vb x$ is
%====================================================================%
\begin{align}
\vbhat{n}\times
 \Bigg[  &\hphantom{+}\,\,\int_{\mathcal{S_\gamma}}
           \Big\{ \big[\BG\supt{EE}(\alpha) + \BG\supt{EE}(\gamma)\big]
                   *\vb K 
                + \big[\BG\supt{EM}(\alpha) + \BG\supt{EM}(\gamma)\big]
                   *\vb N 
           \Big\} \, d\vb x^\prime
\nn
         &+\int_{\mathcal{S}_{\gamma^\prime}}
           \Big\{ \BG\supt{EE}(\alpha)*\vb K 
                 +\BG\supt{EM}(\alpha)*\vb N 
           \Big\} \, d\vb x^\prime
\nn
         &+\int_{\mathcal{S_\beta}} 
           \Big\{ \BG\supt{EE}(\alpha)*\vb K \Big\} \, d\vb x^\prime
\nn
         &-\int_{\mathcal{S_\alpha}}
           \Big\{ \BG\supt{EE}(\alpha)*\vb K 
                 +\BG\supt{EM}(\alpha)*\vb N 
           \Big\} \, d\vb x^\prime
\nn
         &-\int_{\mathcal{S_\delta}} 
           \Big\{ \BG\supt{EE}(\gamma)*\vb K 
                 +\BG\supt{EM}(\gamma)*\vb N 
           \Big\} \, d\vb x^\prime
 \Bigg]
= \Big[\chi\sups{inc}_\gamma - \chi\sups{inc}_\alpha\Big] 
   \vbhat{n}\times \vb E\sups{inc}(\vb x)
\label{DielectricEquationBreakdown}
\end{align}
%====================================================================%
and the second of the two conditions is identical 
but with 
$\{\BG\supt{EE}, \BG\supt{EM}\} \to 
 \{\BG\supt{ME}, \BG\supt{MM}\}$.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newpage
\section{Introduction of the $-Z_0$ Prefactor in the 
         Magnetic Current Expansion} 

In rough schematic form, the equations derived in the 
previous section take the form 
%====================================================================%
$$ \left( \begin{array}{cc}
   \BG\supt{EE} & \BG\supt{EM} \\
   \BG\supt{ME} & \BG\supt{MM} \\
   \end{array} \right)
   *
   \left( \begin{array}{c} \vb K \\  \vb N\end{array}\right)
   = 
   -
   \left( \begin{array}{c}
   \vb E\sups{inc} \\
   \vb H\sups{inc} \\
   \end{array}\right)
$$
%====================================================================%
where $*$ denotes a convolution operation.

The matrix kernel on the LHS is not symmetric because 
$\BG\supt{EM} = -\BG\supt{ME}$. To remedy this, I 
\textbf{(a)} scale the magnetic current by $-1/Z_0$, and then
\textbf{(b)} divide the upper row of the system by $Z_0$ to obtain
the following symmetric system:
%====================================================================%
\renewcommand{\arraystretch}{2.0}
\numeq{lsSystem}
{ \left( \begin{array}{cc}
   \displaystyle{ \frac{1}{Z_0} \BG\supt{EE}} 
   & 
   \displaystyle{-\BG\supt{EM}}
   \\
   \displaystyle{\BG\supt{ME}}
   & 
   \displaystyle{-Z_0\BG\supt{MM}} \\
   \end{array} \right)
   *
   \left( \begin{array}{c} 
      \displaystyle{\vb K} 
      \\
      \displaystyle{-\frac{1}{Z_0}\vb N}
   \end{array}\right)
   = 
   -
   \left( \begin{array}{c}
   \displaystyle{\frac{1}{Z_0} \vb E\sups{inc}} 
   \\
   \displaystyle{\vb H\sups{inc}}
   \end{array}\right)
}
\renewcommand{\arraystretch}{1.0}
Equation (\ref{lsSystem}) is the actual linear system
solved by \ls.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newpage
\section{The Equations Solved by \ls: Discrete Forms}

\subsubsection*{Discretization Procedure} 

\lss uses a two-step procedure to discretize the integral equations 
derived in the previous sections. 
Briefly, we approximate the $\vb K$ and $\vb N$ surface-current 
distributions as expansions in RWG basis functions, then 
Galerkin-test the resulting equations again with the RWG basis
functions. 

In more detail,

\begin{enumerate}
 \item First, \lss approximates surface currents as expansions 
       in RWG basis functions.

       For electric currents on the surfaces of PEC objects, 
       we have the expansion
       \begin{subequations}
       %====================================================================%
       \begin{equation}
         \vb K(\vb x) \approx \sum K_{\alpha n} \vb f_{\alpha n}(\vb x)
       \end{equation}
       %====================================================================%
       where $\alpha$ runs over all PEC objects in the geometry
       and $n$ runs over all RWG basis functions on object 
       $\mathcal{O}_\alpha$.

       For electric and magnetic currents on the surfaces of 
       dielectric objects, we have the expansions
       %====================================================================%
       \begin{equation}
           \vb K(\vb x) \approx \sum K_{\beta n} \vb f_{\beta n}(\vb x), 
           \qquad 
           \vb N(\vb x) \approx -Z_0 \sum N_{\beta n} \vb f_{\beta n}(\vb x)
       \end{equation}
       %====================================================================%
       \label{KNExpansions}
       \end{subequations}
       \noindent where $\beta $ runs over all PEC objects in the geometry
       and $n$ runs over all RWG basis functions on object
       $\mathcal{O}_\beta$. (The rationale for the prefactor $-Z_0$ 
       was explained in the previous section).

 \item Second, \lss obtains one equation for each of the unknown
       $K$ and $N$ coefficients in (\ref{KNExpansions}) by proceeding
       as follows.

       First, we take the inner product of equation
       (\ref{PECEquationBreakdown})
       with each RWG basis function $\vb f_{\alpha n}$ defined on 
       the surface of each PEC object. This gives us one equation
       for each of the $K_{\alpha n}$ coefficients in 
       (\ref{KNExpansions}a).

       Second, we take the inner product of equation
       (\ref{DielectricEquationBreakdown})
       with each RWG basis function $\vb f_{\beta n}$ defined on 
       the surface of each dielectric object. We associate the 
       resulting equation with the coefficient $K_{\beta n}$ in
       (\ref{KNExpansions}b). Then, we take the inner product of 
       the magnetic analogue of 
       (\ref{DielectricEquationBreakdown}) (which, as stated above,
       is identical to (\ref{DielectricEquationBreakdown}) with
       the replacements $\{\BG\supt{EE}, \BG\supt{EM}\} \to 
       \{\BG\supt{ME}, \BG\supt{MM}\}$) with $\vb f_{\beta n})$
       and associate the resulting equation with the coefficient
       $N_{\beta n}$ in (\ref{KNExpansions}b).
\end{enumerate}

\subsubsection*{Discretized Version of Equation 
                (\ref{PECEquationBreakdown})}

We consider again the setting of Figure \ref{EmbeddedObjects}:
We have a PEC object $\mathcal{O}_\beta$, embedded in an object
$\mathcal{O}_\alpha$ (which may be the environment 
$\mathcal{O}_e$); also embedded in $\mathcal{O}_\alpha$ are
additional PEC object(s) $\mathcal{O}_{\beta^\prime}$ and dielectric 
object(s) $\mathcal{O}_\gamma.$ 
Inserting expansions (\ref{KNExpansions}) 
into (\ref{PECEquationBreakdown})
and Galerkin-testing with a basis function $\vb f_{\beta m}$ on 
the surface of $\mathcal{O}_\beta$ yields 
(after dividing both 
sides of the equation by $Z_0$ as per equation (\ref{lsSystem}):
%====================================================================%
\begin{align}
&\sum_{n=1}^{\texttt{NEdges}(\beta)} 
   \Big\langle 
         \vb f_{\beta m} 
   \Big| \frac{1}{Z_0} \BG\supt{EE}(\alpha) \Big|
         \vb f_{\beta n}
   \Big\rangle 
         K_{\beta n}
\nn
%--------------------------------------------------------------------%
+&\sum_{n=1}^{\texttt{NEdges}(\beta^\prime)} 
   \Big\langle 
         \vb f_{\beta m} 
   \Big| \frac{1}{Z_0} \BG\supt{EE}(\alpha) \Big| 
         \vb f_{\beta^\prime n}
   \Big\rangle 
         K_{\beta^\prime n}
\nn
%--------------------------------------------------------------------%
+&\sum_{n=1}^{\texttt{NEdges}(\gamma)} \bigg\{
   \Big\langle 
         \vb f_{\beta m} 
   \Big| \frac{1}{Z_0} \BG\supt{EE}(\alpha) \Big| 
         \vb f_{\gamma n}
   \Big\rangle 
         K_{\gamma n}
   \,-
   \Big\langle 
         \vb f_{\beta m} 
   \Big| \BG\supt{EM}(\alpha) \Big| 
         \vb f_{\gamma n}
   \Big\rangle 
         N_{\gamma n}
  \bigg\}
\nn
%--------------------------------------------------------------------%
-&\sum_{n=1}^{\texttt{NEdges}(\alpha)} \bigg\{
   \Big\langle 
         \vb f_{\beta m} 
   \Big| \frac{1}{Z_0} \BG\supt{EE}(\alpha) \Big| 
         \vb f_{\alpha n}
   \Big\rangle 
         K_{\alpha n}
   \,-
   \Big\langle 
         \vb f_{\beta m} 
   \Big| \BG\supt{EM}(\alpha) \Big| 
         \vb f_{\alpha n}
   \Big\rangle 
         N_{\alpha n}
  \bigg\}
\nn
%--------------------------------------------------------------------%
&=-\frac{1}{Z_0} \chi_\alpha\sups{inc} 
   \Big\langle \vb f_{\beta m} \Big| \vb E\sups{inc} \Big\rangle.
 \label{DiscretizedPECEquation}
\end{align}
%====================================================================%

\subsubsection*{Discretized Version of Equation
                (\ref{DielectricEquationBreakdown}) and its 
                Magnetic Analogue}

Again in the setting of Figure \ref{EmbeddedObjects}, we 
Galerkin-test equation (\ref{DielectricEquationBreakdown}) 
with a basis function $\vb f_{\gamma m}$ on the surface
of object $\mathcal{O}_\gamma$ to find (again, dividing through
by $Z_0$ as per (\ref{lsSystem})):
%====================================================================%
\begin{subequations}
\begin{align}
&\sum_{n=1}^{\texttt{NEdges}(\gamma)}  \bigg\{
   \Big\langle 
         \vb f_{\gamma m} 
   \Big| \frac{1}{Z_0} \BG\supt{EE}(\alpha) + \frac{1}{Z_0} \BG\supt{EE}(\gamma) \Big|
         \vb f_{\gamma n}
   \Big\rangle 
         K_{\gamma n}
   -
   \Big\langle 
         \vb f_{\gamma m} 
   \Big| \BG\supt{EM}(\alpha) + \BG\supt{EM}(\gamma) \Big|
         \vb f_{\gamma n}
   \Big\rangle 
         N_{\gamma n}
  \bigg\}
\nn
%--------------------------------------------------------------------%
&\sum_{n=1}^{\texttt{NEdges}(\gamma^\prime)}  \bigg\{
   \Big\langle 
         \vb f_{\gamma m} 
   \Big| \frac{1}{Z_0}\BG\supt{EE}(\alpha) \Big|
         \vb f_{\gamma^\prime n}
   \Big\rangle 
         K_{\gamma^\prime n}
   -
   \Big\langle 
         \vb f_{\gamma m} 
   \Big| \BG\supt{EM}(\alpha) \Big|
         \vb f_{\gamma^\prime n}
   \Big\rangle 
         N_{\gamma^\prime n}
  \bigg\}
\nn
%--------------------------------------------------------------------%
+&\sum_{n=1}^{\texttt{NEdges}(\beta)} 
   \Big\langle 
         \vb f_{\gamma m} 
   \Big| \frac{1}{Z_0} \BG\supt{EE}(\alpha) \Big| 
         \vb f_{\beta n}
   \Big\rangle 
         K_{\beta n}
\nn
%--------------------------------------------------------------------%
-&\sum_{n=1}^{\texttt{NEdges}(\alpha)} \bigg\{
   \Big\langle 
         \vb f_{\gamma m} 
   \Big| \frac{1}{Z_0} \BG\supt{EE}(\alpha) \Big| 
         \vb f_{\alpha n}
   \Big\rangle 
         K_{\alpha n}
   \,-
   \Big\langle 
         \vb f_{\gamma m} 
   \Big| \BG\supt{EM}(\alpha) \Big| 
         \vb f_{\alpha n}
   \Big\rangle 
         N_{\alpha n}
  \bigg\}
\nn
%--------------------------------------------------------------------%
-&\sum_{n=1}^{\texttt{NEdges}(\delta)} \bigg\{
   \Big\langle 
         \vb f_{\gamma m} 
   \Big| \frac{1}{Z_0} \BG\supt{EE}(\gamma) \Big| 
         \vb f_{\delta n}
   \Big\rangle 
         K_{\delta n}
   \,-
   \Big\langle 
         \vb f_{\gamma m} 
   \Big| \BG\supt{EM}(\gamma) \Big| 
         \vb f_{\delta n}
   \Big\rangle 
         N_{\delta n}
  \bigg\}
\nn
%--------------------------------------------------------------------%
&=\frac{1}{Z_0} \Big[\chi_\gamma\sups{inc} - \chi_\alpha\sups{inc}\Big] 
   \Big\langle \vb f_{\gamma m} \Big| \vb E\sups{inc} \Big\rangle.
\end{align}

\subsubsection*{Discretized Version of the Magnetic Analogue of 
                Equation (\ref{DielectricEquationBreakdown})}

Finally,, we Galerkin-test the magnetic-field analogue of 
(\ref{DielectricEquationBreakdown}) to find
\begin{align}
&\sum_{n=1}^{\texttt{NEdges}(\gamma)}  \bigg\{
   \Big\langle 
         \vb f_{\gamma m} 
   \Big| \BG\supt{ME}(\alpha) + \BG\supt{ME}(\gamma) \Big|
         \vb f_{\gamma n}
   \Big\rangle 
         K_{\gamma n}
   -
   \Big\langle 
         \vb f_{\gamma m} 
   \Big| Z_0\BG\supt{MM}(\alpha) + Z_0\BG\supt{MM}(\gamma) \Big|
         \vb f_{\gamma n}
   \Big\rangle 
         N_{\gamma n}
  \bigg\}
\nn
%--------------------------------------------------------------------%
&\sum_{n=1}^{\texttt{NEdges}(\gamma^\prime)}  \bigg\{
   \Big\langle 
         \vb f_{\gamma m} 
   \Big| \BG\supt{ME}(\alpha) \Big|
         \vb f_{\gamma^\prime n}
   \Big\rangle 
         K_{\gamma^\prime n}
   -
   \Big\langle 
         \vb f_{\gamma m} 
   \Big| Z_0\BG\supt{MM}(\alpha) \Big|
         \vb f_{\gamma^\prime n}
   \Big\rangle 
         N_{\gamma^\prime n}
  \bigg\}
\nn
%--------------------------------------------------------------------%
+&\sum_{n=1}^{\texttt{NEdges}(\beta)} 
   \Big\langle 
         \vb f_{\gamma m} 
   \Big| \BG\supt{ME}(\alpha) \Big| 
         \vb f_{\beta n}
   \Big\rangle 
         K_{\beta n}
\nn
%--------------------------------------------------------------------%
-&\sum_{n=1}^{\texttt{NEdges}(\alpha)} \bigg\{
   \Big\langle 
         \vb f_{\gamma m} 
   \Big| \BG\supt{ME}(\alpha) \Big| 
         \vb f_{\alpha n}
   \Big\rangle 
         K_{\alpha n}
   \,-
   \Big\langle 
         \vb f_{\gamma m} 
   \Big| Z_0 \BG\supt{MM}(\alpha) \Big| 
         \vb f_{\alpha n}
   \Big\rangle 
         N_{\alpha n}
  \bigg\}
\nn
%--------------------------------------------------------------------%
-&\sum_{n=1}^{\texttt{NEdges}(\delta)} \bigg\{
   \Big\langle 
         \vb f_{\gamma m} 
   \Big| \BG\supt{ME}(\gamma) \Big| 
         \vb f_{\delta n}
   \Big\rangle 
         K_{\delta n}
   \,-
   \Big\langle 
         \vb f_{\gamma m} 
   \Big| Z_0 \BG\supt{MM}(\gamma) \Big| 
         \vb f_{\delta n}
   \Big\rangle 
         N_{\delta n}
  \bigg\}
\nn
%--------------------------------------------------------------------%
&=\Big[\chi_\gamma\sups{inc} - \chi_\alpha\sups{inc}\Big] 
   \Big\langle \vb f_{\gamma m} \Big| \vb H\sups{inc} \Big\rangle.
\end{align}
\label{DiscretizedDielectricEquation}
\end{subequations}
%====================================================================%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newpage
\section{Structure of the BEM System}

The discretization procedure of the previous section results in a 
linear system of the form
\numeq{BEMSystem}
{ \Big[ \vb M \Big]  \cdot \Big[ \vb{KN} \Big] = \Big[ \vb{RHS} \Big ] }
where the vector $\big[\vb{KN}\big]$ contains the unknown 
$K$ and $N$ coefficients from equation (\ref{KNExpansions}),
the matrix $\big[\vb M\big]$ is the ``BEM matrix,''
and the right-hand-side vector $\big[\vb{RHS}\big]$ 
depends on the incident fields.

In the remainder of this section we will describe the structure
of each of the entities in equation (\ref{BEMSystem}). 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Structure of the coefficient vector}

The $\vb{KN}$ vector contains the $K$ and $N$ coefficients
in (\ref{KNExpansions}), ordered as follows:

\begin{enumerate}
 \item All coefficients for object $\mathcal{O}_1$ come first, 
       followed by all coefficients for object $\mathcal{O}_2$, etc.

       (Object indices correspond with the order in which the 
        objects were specified in the \texttt{.rwggeo} file 
        used as input to \ls.)
       
 \item Within the portion of the vector corresponding to a 
       dielectric object, the electric and magnetic coefficients
       for the first RWG basis function come first, followed
       by the electric and magnetic coefficients
       for the second RWG basis function, etc.

\end{enumerate}

Thus, for a geometry consisting of object $\mathcal{O}_1$ (PEC)
with $M$ interior edges in its surface discretization
and object $\mathcal{O}_2$ (dielectric) with $N$ interior edges
in its surface discretization, the $\vb{KN}$ vector has dimension
$2N+M$ and looks like
%====================================================================%
$$ \vb{KN}=\left(\begin{array}{c}
   K_{11} \\ 
   \vdots \\
   K_{1M} \\ 
   K_{21} \\ 
   N_{21} \\ 
   \vdots \\
   K_{2N} \\ 
   N_{2N}
   \end{array}\right).
$$
%====================================================================%

To compute the index of any given coefficient $K_{\alpha n}$ 
or $N_{\alpha n}$ within the $\vb{KN}$ vector,
it is useful first to define functions \texttt{NBF}($\alpha$) 
and \texttt{BFIndexOffset}($\alpha$). The former of these 
is just the number of basis functions on object $\alpha$,
i.e.
$$ \texttt{NBF}(\alpha) = 
   \begin{cases}
   \texttt{NEdges}(\alpha), \qquad &\text{if object $\mathcal{O}_\alpha$
                                          is PEC} \\
   2\cdot \tt{NEdges}(\alpha), 
                        \qquad &\text{if object $\mathcal{O}_\alpha$
                                      is dielectric.} \\
   \end{cases}
$$
(Here \texttt{NEdges}($\alpha$) is the number of interior edges 
in the surface discretization of object $\mathcal{O}_\alpha$.)

The function \texttt{BFIndexOffset}($\alpha$) is the index
within the $\vb{KN}$ vector of the first coefficient corresponding
to object $\mathcal{O}_\alpha$; thus 
\begin{align*}
 \texttt{BFIndexOffset}(1) &= 1 \\
 \texttt{BFIndexOffset}(2) &= 1 + \tt{NBF}(1) \\
 \texttt{BFIndexOffset}(3) &= 1 + \tt{NBF}(1) + \tt{NBF}(2) \\
\end{align*}
et cetera.

Then I can write the following relations for the indices 
with the $\vb{KN}$ vector of individual $K, N$ coefficients.
(Note that these are one-based indices, which must be translated
into zero-based indices for use in \texttt{C++} code.)
%====================================================================%
\begin{align*}
\mathcal{I}(K, \alpha, n)
&\equiv \text{Index of coefficient $K_{\alpha n}$
              within the $\vb{KN}$ vector}
\\
&=\begin{cases}
   \texttt{BFIndexOffset}(\alpha) + n-1, 
   \qquad &\text{if $\mathcal{O}_\alpha$ is PEC} \\
   \texttt{BFIndexOffset}(\alpha) + 2(n-1),
   \qquad &\text{if $\mathcal{O}_\alpha$ is dielectric}
  \end{cases}
\\[5pt]
\mathcal{I}(N, \alpha, n)
&\equiv \text{Index of coefficient $N_{\alpha n}$ 
              within the $\vb{KN}$ vector}
\\
&=\texttt{BFIndexOffset}(\alpha) + 2(n-1)+1.
\end{align*}
%====================================================================%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Structure of the RHS vector}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Structure of the BEM matrix}

Consider two basis functions: $\vb f_{\alpha m}$, corresponding
to the $m$th interior edge of object $\mathcal{O}_\alpha$,
and $\vb f_{\beta n}$, corresponding to the $n$th interior edge
of object $\mathcal{O}_\beta.$ 

Let $\vb A$ be the index of the medium through which the 
objects interact. (If we have $\texttt{NObj}$ objects in 
our geometry, then either $1\le \vb A \le \texttt{NObj}$ 
or else $\vb A=e$ for the external medium.) Thus,

\begin{itemize}
 \item If $\mathcal{O}_\alpha$ is contained in $\mathcal{O}_\beta$, 
       then $\vb A=\beta$.
 \item If $\mathcal{O}_\beta$ is contained in $\mathcal{O}_\alpha$, 
       then $\vb A=\alpha$.
 \item If $\mathcal{O}_\alpha$ and $\mathcal{O}_\alpha$ are both
       contained in the same object $\mathcal{O}_\gamma$ (which may
       be the external medium $\mathcal{O}_e$), then  
       then $\vb A=\gamma$.
 \item If none of the above are true, then the two objects do not
       interact and the corresponding block of the BEM matrix is
       zero.
\end{itemize}

Define a symbol $\texttt{Sign}$ to have value $-1$ in the first
two cases (i.e. when one of $\mathcal{O}_\alpha$, $\mathcal{O}_\beta$
is contained inside the other), while $\texttt{Sign}=+1$ otherwise.

Then the two basis elements contribute a 
$1\times 1$, $1\times 2$, $2\times 1$, or $2\times 2$
block of matrix elements to the BEM matrix, which may be determined
by looking at equations 
(\ref{DiscretizedPECEquation}) 
and 
(\ref{DiscretizedDielectricEquation}) 
as follows:
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{enumerate}
%====================================================================%
\item \textbf{Both objects are PEC:}
%====================================================================%
$$\begin{array}{lclcl}
   M\Big( \mathcal{I}^K_{\alpha m}, \mathcal{I}^K_{\beta n} \Big) 
  &=&
  \displaystyle{ \frac{1}{Z_0} 
                 \Big\langle 
                 \vb f_{\alpha m} 
                 \Big| \BG\supt{EE}(\vb A) \Big|
                 \vb f_{\beta n} 
                 \Big\rangle
               }
%--------------------------------------------------------------------%
  &=&
  \displaystyle{
  ik\supt{A} Z\supt{A}
                \Big\langle 
                \vb f_{\alpha m} 
                \Big| \vb G(k\supt{A}) \Big|
                \vb f_{\beta n} 
                \Big\rangle
               }
\end{array}$$
%====================================================================%
\item \textbf{ $\mathcal{O}_\alpha$ is PEC, 
               $\mathcal{O}_\beta$ is dielectric:}
%====================================================================%
$$\begin{array}{lclcl}
 M\Big( \mathcal{I}^K_{\alpha m}, \mathcal{I}^K_{\beta n} \Big) 
  &=& 
  \displaystyle{ \frac{\texttt{Sign}}{Z_0} 
                 \Big\langle \vb f_{\alpha m} 
                 \Big| \BG\supt{EE}(\vb A) \Big|
                 \vb f_{\beta n} 
                 \Big\rangle
               }
%--------------------------------------------------------------------%
  &=&
  \displaystyle{ \texttt{Sign}\cdot ik\supt{A} Z\supt{A}
                 \Big\langle \vb f_{\alpha m} 
                 \Big| \vb G(k\supt{A}) \Big|
                 \vb f_{\beta n} 
                 \Big\rangle
               }
\\[10pt]
%--------------------------------------------------------------------%
%--------------------------------------------------------------------%
 M\Big( \mathcal{I}^K_{\alpha m}, \mathcal{I}^N_{\beta n} \Big) 
  &=&
  \displaystyle{ -\texttt{Sign}\cdot
                 \Big\langle 
                 \vb f_{\alpha m} 
                 \Big| \BG\supt{EM}(\vb A) \Big|
                 \vb f_{\beta n} 
                 \Big\rangle
               }
%--------------------------------------------------------------------%
  &=&
  \displaystyle{ -\texttt{Sign}\cdot ik\supt{A}
                  \Big\langle 
                  \vb f_{\alpha m} 
                  \Big| \vb C(k\supt{A})\Big|
                  \vb f_{\beta n} 
                  \Big\rangle
               }
\end{array}$$
%====================================================================%
\item \textbf{ $\mathcal{O}_\alpha$ is dielectric, 
               $\mathcal{O}_\beta$ is PEC:}
%====================================================================%
$$\begin{array}{lclcl}
 M\Big( \mathcal{I}^K_{\alpha m}, \mathcal{I}^K_{\beta n} \Big) 
  &=& 
  \displaystyle{ \frac{\texttt{Sign}}{Z_0} 
                 \Big\langle \vb f_{\alpha m} 
                 \Big| \BG\supt{EE}(\vb A) \Big|
                 \vb f_{\beta n} 
                 \Big\rangle
               }
%--------------------------------------------------------------------%
  &=&
  \displaystyle{ \texttt{Sign}\cdot ik\supt{A} Z\supt{A}
                 \Big\langle \vb f_{\alpha m} 
                 \Big| \vb G(k\supt{A}) \Big|
                 \vb f_{\beta n} 
                 \Big\rangle
               }
\\[10pt]
%--------------------------------------------------------------------%
%--------------------------------------------------------------------%
 M\Big( \mathcal{I}^N_{\alpha m}, \mathcal{I}^K_{\beta n} \Big) 
  &=&
  \displaystyle{ \texttt{Sign}\cdot
                 \Big\langle 
                 \vb f_{\alpha m} 
                 \Big| \BG\supt{ME}(\vb A) \Big|
                 \vb f_{\beta n} 
                 \Big\rangle
               }
%--------------------------------------------------------------------%
  &=&
  \displaystyle{ -\texttt{Sign}\cdot ik\supt{A}
                  \Big\langle 
                  \vb f_{\alpha m} 
                  \Big| \vb C(k\supt{A})\Big|
                  \vb f_{\beta n} 
                  \Big\rangle
               }
\end{array}$$
%====================================================================%
\item \textbf{ $\mathcal{O}_\alpha, \mathcal{O}_\beta$ are both
               dielectric and $\mathcal{O}_\alpha \ne \mathcal{O}_\beta$:}
%====================================================================
$$\begin{array}{lclcl}
 M\Big( \mathcal{I}^K_{\alpha m}, \mathcal{I}^K_{\beta n} \Big) 
  &=& 
  \displaystyle{ \frac{\texttt{Sign}}{Z_0} 
                 \Big\langle \vb f_{\alpha m} 
                 \Big| \BG\supt{EE}(\vb A) \Big|
                 \vb f_{\beta n} 
                 \Big\rangle
               }
%--------------------------------------------------------------------%
  &=&
  \displaystyle{ \texttt{Sign}\cdot ik\supt{A} Z\supt{A}
                 \Big\langle \vb f_{\alpha m} 
                 \Big| \vb G(k\supt{A}) \Big|
                 \vb f_{\beta n} 
                 \Big\rangle
               }
\\[10pt]
%--------------------------------------------------------------------%
%--------------------------------------------------------------------%
 M\Big( \mathcal{I}^K_{\alpha m}, \mathcal{I}^N_{\beta n} \Big) 
  &=&
  \displaystyle{ -\texttt{Sign}\cdot
                 \Big\langle 
                 \vb f_{\alpha m} 
                 \Big|\BG\supt{EM}(\vb A) \Big|
                 \vb f_{\beta n} 
                 \Big\rangle
               }
%--------------------------------------------------------------------%
  &=&
  \displaystyle{ -\texttt{Sign}\cdot ik\supt{A}
                  \Big\langle 
                  \vb f_{\alpha m} 
                  \Big| \vb C(k\supt{A})\Big|
                  \vb f_{\beta n} 
                  \Big\rangle
               }
\\[10pt]
%--------------------------------------------------------------------%
%--------------------------------------------------------------------%
 M\Big( \mathcal{I}^N_{\alpha m}, \mathcal{I}^K_{\beta n} \Big) 
  &=&
  \displaystyle{ \texttt{Sign}\cdot
                 \Big\langle 
                 \vb f_{\alpha m} 
                 \Big|\BG\supt{ME}(\vb A) \Big|
                 \vb f_{\beta n} 
                 \Big\rangle
               }
%--------------------------------------------------------------------%
  &=&
  \displaystyle{ -\texttt{Sign}\cdot ik\supt{A}
                  \Big\langle 
                  \vb f_{\alpha m} 
                  \Big| \vb C(k\supt{A})\Big|
                  \vb f_{\beta n} 
                  \Big\rangle
               }
\\[10pt]
%--------------------------------------------------------------------%
%--------------------------------------------------------------------%
 M\Big( \mathcal{I}^N_{\alpha m}, \mathcal{I}^N_{\beta n} \Big) 
  &=&
  \displaystyle{ -\texttt{Sign}\cdot Z_0 
                 \Big\langle 
                 \vb f_{\alpha m} 
                 \Big|\BG\supt{MM}(\vb A) \Big|
                 \vb f_{\beta n} 
                 \Big\rangle
               }
%--------------------------------------------------------------------%
  &=&
  \displaystyle{ -\frac{\texttt{Sign}\cdot ik\supt{A}}{Z\supt{A}}
                  \Big\langle 
                  \vb f_{\alpha m} 
                  \Big| \vb G(k\supt{A})\Big|
                  \vb f_{\beta n} 
                  \Big\rangle
               }
\end{array}$$
%====================================================================%
\item \textbf{ $\mathcal{O}_\alpha, \mathcal{O}_\beta$ are both
               dielectric and $\mathcal{O}_\alpha = \mathcal{O}_\beta$:}

%====================================================================%
This case is identical to the previous case, but now the matrix elements
are augmented by additional contributions describing the basis functions
interacting through the medium inside the object. Let the index
of this medium be $\vb B$. (We have $\vb B=\alpha=\beta$.) Then
the matrix elements are 
%====================================================================
\begin{align*}
 M\Big( \mathcal{I}^K_{\alpha m}, \mathcal{I}^K_{\beta n} \Big) 
 &= \frac{1}{Z_0}
    \Big\langle \vb f_{\alpha m} 
    \Big| \BG\supt{EE}(\vb A) + \BG\supt{EE}(\vb B) \Big|
                \vb f_{\beta n} 
    \Big\rangle
\\[5pt]
 &= ik\supt{A} Z\supt{A}
    \Big\langle \vb f_{\alpha m} 
                 \Big| \vb G(k\supt{A}) \Big|
                 \vb f_{\beta n} 
    \Big\rangle
    +
    ik\supt{B} Z\supt{B}
    \Big\langle \vb f_{\alpha m} 
                 \Big| \vb G(k\supt{B}) \Big|
                 \vb f_{\beta n} 
    \Big\rangle
\\[10pt]
%--------------------------------------------------------------------%
 M\Big( \mathcal{I}^K_{\alpha m}, \mathcal{I}^N_{\beta n} \Big) 
 &= -\Big\langle \vb f_{\alpha m} 
    \Big| \BG\supt{EM}(\vb A) + \BG\supt{EM}(\vb B) \Big|
                \vb f_{\beta n} 
    \Big\rangle
\\[5pt]
 &= -ik\supt{A}
    \Big\langle \vb f_{\alpha m} 
                 \Big| \vb C(k\supt{A}) \Big|
                 \vb f_{\beta n} 
    \Big\rangle
    -ik\supt{B}
    \Big\langle \vb f_{\alpha m} 
                 \Big| \vb C(k\supt{B}) \Big|
                 \vb f_{\beta n} 
    \Big\rangle
\\[10pt]
%--------------------------------------------------------------------%
 M\Big( \mathcal{I}^N_{\alpha m}, \mathcal{I}^K_{\beta n} \Big) 
 &= \Big\langle \vb f_{\alpha m} 
    \Big| \BG\supt{ME}(\vb A) + \BG\supt{ME}(\vb B) \Big|
                \vb f_{\beta n} 
    \Big\rangle
\\[5pt]
 &= -ik\supt{A}
    \Big\langle \vb f_{\alpha m} 
                 \Big| \vb C(k\supt{A}) \Big|
                 \vb f_{\beta n} 
    \Big\rangle
    -ik\supt{B}
    \Big\langle \vb f_{\alpha m} 
                 \Big| \vb C(k\supt{B}) \Big|
                 \vb f_{\beta n} 
    \Big\rangle
\\[10pt]
%--------------------------------------------------------------------%
 M\Big( \mathcal{I}^N_{\alpha m}, \mathcal{I}^N_{\beta n} \Big) 
 &= -\Big\langle \vb f_{\alpha m} 
    \Big| \BG\supt{MM}(\vb A) + \BG\supt{MM}(\vb B) \Big|
                \vb f_{\beta n} 
    \Big\rangle
\\[5pt]
 &= -\frac{ik\supt{A}}{Z\supt{A}}
    \Big\langle \vb f_{\alpha m} 
                 \Big| \vb G(k\supt{A}) \Big|
                 \vb f_{\beta n} 
    \Big\rangle
    -
    \frac{ik\supt{B}}{Z\supt{B}}
    \Big\langle \vb f_{\alpha m} 
                 \Big| \vb G(k\supt{B}) \Big|
                 \vb f_{\beta n}
    \Big\rangle.
\\[10pt]
\end{align*}
%====================================================================%
\end{enumerate}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newpage
\section{Evaluation of Integrals over RWG Basis Functions}

As demonstrated in the previous section, the elements of the 
BEM matrix involve integrals over pairs of RWG basis functions 
of the form
%====================================================================%
\begin{subequations}
\begin{align}
 \Big\langle \vb f_a \Big| \vb G(k) \Big | \vb f_b \Big \rangle
&\equiv 
  \int_{\sup \vb f_a} d\vb x \, 
  \int_{\sup \vb f_b} d\vb x^\prime \,
  \vb f_a(\vb x) \cdot 
  \vb G(k, \vb x-\vb x^\prime) \cdot 
  \vb f_b(\vb x^\prime)
\\
 \Big\langle \vb f_a \Big| \vb C(k) \Big | \vb f_b \Big \rangle
&\equiv 
  \int_{\sup \vb f_a} d\vb x \, 
  \int_{\sup \vb f_b} d\vb x^\prime \,
  \vb f_a(\vb x) \cdot 
  \vb C(k, \vb x-\vb x^\prime) \cdot 
  \vb f_b(\vb x^\prime).
\end{align}
\label{MatrixElementIntegrals}
\end{subequations}
%====================================================================%
\lss computes these integrals using one of two strategies depending
on how far apart the basis functions are from one another. To 
quantify this, let $d_{ab}$ be the distance between the centroids
of basis functions $\vb f_a$ and $\vb f_b$, and let 
$R\subs{max}=\texttt{max}(R_a, R_b)$ be the larger of the radii
of the two basis functions. (The ``radius'' of a compact source distribution
is the radius of the smallest sphere in which the source distribution
may be enclosed. For RWG basis functions, we take the centroid to be
the midpoint of the common edge shared by the two triangle that define
the basis function; then the radius is the greatest distance from the 
centroid to any of the four panel vertices 
(Figure \ref{RWGMidPointRadius}).) 

Then the computation of the integrals (\ref{MatrixElementIntegrals})
proceeds as follows. 

\begin{enumerate}
 \item
 When $d_{ab} > \texttt{DBFTHRESHOLD}\cdot R\subs{max}$,
 we approximate (\ref{MatrixElementIntegrals}) using a 
 spherical-multipole expansion. 
 (Here \texttt{DBFThreshold}, the ``distant basis-function threshold,''
 is a dimensionless number that must be tuned to yield 
 optimal accuracy and performance; in \lss its value is set to 8.3.)
 \item
 Otherwise, we compute (\ref{MatrixElementIntegrals}) as a sum
 of four numerically-evaluated integrals over pairs of triangular
 panels.
\end{enumerate}

Each of these methods is described in the following sections.

\subsection{Matrix elements between distant basis functions: 
            spherical multipole method}

\subsection{Matrix elements between nearby basis functions: 
            panel-panel integration method}

%====================================================================%
Each of these integrals is a sum of contributions from four panels:
%====================================================================%
\begin{align*}
 \Big\langle \vb f_a \Big| \vb G(k) \Big | \vb f_b \Big \rangle
&=
  \sum_{\sigma, \tau=-}^+ 
  \frac{\sigma\tau l_a l_b}{4A^\sigma_a A^\tau_b}
  \int_{\pan_a^\sigma}  d\vb x_a \,
  \int_{\pan_b^\tau}  d\vb x_b \,
   \Big[ (\vb x_a - \vb Q_a) \cdot (\vb x_b - \vb Q_b) 
        -\frac{4}{k^2}
   \Big]
   \phi(k,\vb x_a - \vb x_b)
\\
%--------------------------------------------------------------------%
 \Big\langle \vb f_a \Big| \vb C(k) \Big | \vb f_b \Big \rangle
&=
  \frac{1}{ik}
  \sum_{\sigma, \tau=-}^+ 
  \frac{\sigma \tau l_a l_b}{2A^\sigma_a A^\tau_b}
  \int_{\pan_a^\sigma}  d\vb x_a \,
  \int_{\pan_b^\tau}  d\vb x_b \,
   \bigg\{ \Big[ (\vb x_a - \vb Q_a) \times (\vb x_b - \vb Q_b) \Big]
           \cdot (\vb x_a - \vb x_b)
   \bigg\}
   \psi(k,\vb x_a - \vb x_b)
\end{align*}
%====================================================================%
where  
$$ \phi(k, r)=\frac{e^{ikr}}{4\pi r}, \qquad 
   \psi(k, r)=(ikr-1)\frac{e^{ikr}}{4\pi r^3}.
$$
($\psi$ is defined such that $\nabla \phi = \vb r \psi$).

\end{document}
